"use strict";var ngObibaMica;function NgObibaMicaTemplateUrlFactory(){var r={searchStudiesResultTable:"search/components/result/studies-result-table/component.html",searchNetworksResultTable:"search/components/result/networks-result-table/component.html",searchDatasetsResultTable:"search/components/result/datasets-result-table/component.html",searchCriteriaRegionTemplate:"search/components/criteria/item-region/region/component.html",vocabularyFilterDetailHeading:"search/components/vocabulary-filter-detail-heading/component.html",CriterionDropdownTemplate:"search/components/criteria/item-region/dropdown/component.html",searchResultList:"search/components/result/search-result/list.html",searchInputList:"lists/views/input-search-widget/input-search-widget-template.html",searchResultCoverage:"search/components/result/search-result/coverage.html",searchResultGraphics:"search/components/result/search-result/graphics.html",variableCrosstab:"analysis/crosstab/views/crosstab-variable-crosstab.html",variableFrequencies:"analysis/crosstab/views/crosstab-variable-frequencies.html",variableFrequenciesEmpty:"analysis/crosstab/views/crosstab-variable-frequencies-empty.html",variableStatistics:"analysis/crosstab/views/crosstab-variable-statistics.html",variableStatisticsEmpty:"analysis/crosstab/views/crosstab-variable-statistics-empty.html",searchCellStatValue:"search/components/result/cell-stat-value/component.html"},t={registry:null};function e(e){var t=e;this.getHeaderUrl=function(e){return e in t?t[e].header:null},this.getFooterUrl=function(e){return e in t?t[e].footer:null},this.getTemplateUrl=function(e){return e in t?t[e].template?t[e].template:r[e]:null}}t.setTemplateUrl=function(e,t){e in this.registry&&(this.registry[e].template=t)},t.setHeaderUrl=function(e,t){e in this.registry&&(this.registry[e].header=t)},t.setFooterUrl=function(e,t){e in this.registry&&(this.registry[e].footer=t)},t.$get=function(){return new e(this.registry)},this.create=function(e){return t.registry=e,t}}!function(){function r(){var t=this;t.$get=function(){throw new Error("The provider factory method $get() must be overridden by client code.")},t.setFactory=function(e){t.$get=e}}function a(){var r={DataAccessClientDetailPath:"",DataAccessClientListPath:"",DataAccessFormConfigResource:"ws/config/data-access-form",DataAccessAmendmentFormConfigResource:"ws/config/data-access-amendment-form",DataAccessRequestsResource:"ws/data-access-requests",DataAccessAmendmentsResource:"ws/data-access-request/:parentId/amendments",DataAccessAmendmentResource:"ws/data-access-request/:parentId/amendment/:id",DataAccessRequestsExportHistoryResource:"ws/data-access-requests/_history?lang=:lang",DataAccessRequestsExportCsvResource:"ws/data-access-requests/csv?lang=:lang",DataAccessRequestResource:"ws/data-access-request/:id",DataAccessRequestActionLogsResource:"ws/data-access-request/:id/_log-actions",DataAccessAmendmentsLogHistoryResource:"/ws/data-access-request/:id/amendments/_history",DataAccessRequestAttachmentsUpdateResource:"/ws/data-access-request/:id/_attachments",DataAccessRequestAttachmentDownloadResource:"/ws/data-access-request/:id/attachments/:attachmentId/_download",SchemaFormAttachmentDownloadResource:"/ws/:path/form/attachments/:attachmentName/:attachmentId/_download",DataAccessRequestDownloadPdfResource:"/ws/data-access-request/:id/_pdf",DataAccessRequestCommentsResource:"ws/data-access-request/:id/comments?admin=:admin",DataAccessRequestCommentResource:"ws/data-access-request/:id/comment/:commentId",DataAccessRequestStatusResource:"ws/data-access-request/:id/_status?to=:status",DataAccessAmendmentStatusResource:"ws/data-access-request/:parentId/amendment/:id/_status?to=:status",TempFileUploadResource:"ws/files/temp",TempFileResource:"ws/files/temp/:id",TaxonomiesSearchResource:"ws/taxonomies/_search",TaxonomiesResource:"ws/taxonomies/_filter",TaxonomyResource:"ws/taxonomy/:taxonomy/_filter",VocabularyResource:"ws/taxonomy/:taxonomy/vocabulary/:vocabulary/_filter",VariableResource:"ws/variable/:id",VariableSummaryResource:"ws/variable/:id/summary",SetsResource:"ws/:type/sets",SetsImportResource:"ws/:type/sets/_import",SetResource:"ws/:type/set/:id",SetClearResource:"ws/:type/set/:id/documents",SetDocumentsResource:"ws/:type/set/:id/documents?from=:from&limit=:limit",SetExistsResource:"ws/:type/set/:id/document/:did/_exists",SetImportResource:"ws/:type/set/:id/documents/_import",SetImportQueryResource:"ws/:type/set/:id/documents/_rql",SetRemoveResource:"ws/:type/set/:id/documents/_delete",JoinQuerySearchResource:"ws/:type/_rql",JoinQuerySearchCsvResource:"ws/:type/_rql_csv?query=:query",JoinQuerySearchCsvReportResource:"ws/:type/_report?query=:query",JoinQuerySearchCsvReportByNetworkResource:"ws/:type/_report_by_network?networkId=:networkId&locale=:locale",JoinQueryCoverageResource:"ws/variables/_coverage",JoinQueryCoverageDownloadResource:"ws/variables/_coverage_download?query=:query",VariablePage:"",NetworkPage:"#/network/:network",StudyPage:"#/:type/:study",StudyPopulationsPage:"#/:type/:study",DatasetPage:"#/:type/:dataset",BaseUrl:"/",FileBrowserFileResource:"ws/file/:path/",FileBrowserSearchResource:"ws/files-search/:path",FileBrowserDownloadUrl:"ws/draft/file-dl/:path?inline=:inline",SearchBaseUrl:"#/search",DocumentSuggestion:"ws/:documentType/_suggest",EntitiesCountResource:"ws/datasets/entities/_count?query=:query",EntitiesCountBaseUrl:"#/entities-count",DatasetCategoricalVariablesResource:"ws/:dsType/:dsId/variables/:query/categorical",DatasetVariablesResource:"ws/:dsType/:dsId/variables/:query",DatasetVariableResource:"ws/variable/:varId",DatasetVariablesCrosstabResource:"ws/:dsType/:dsId/variables/cross/:v1/by/:v2",DatasetResource:"ws/dataset/:dsType/:dsId"};function e(e){var t=e;this.getUrl=function(e){return e in t?t[e]:null}}this.setUrl=function(e,t){e in r&&(r[e]=t)},this.$get=function(){return new e(r)}}(ngObibaMica=angular.module("ngObibaMica",["schemaForm","ngCookies","obiba.mica.utils","obiba.mica.file","obiba.mica.attachment","obiba.mica.access","obiba.mica.search","obiba.mica.analysis","obiba.mica.graphics","obiba.mica.localized","obiba.mica.fileBrowser","angularUtils.directives.dirPagination"])).constant("USER_ROLES",{all:"*",admin:"mica-administrator",reviewer:"mica-reviewer",editor:"mica-editor",user:"mica-user",dao:"mica-data-access-officer"}).config(["$provide","paginationTemplateProvider",function(e,t){e.provider("ngObibaMicaUrl",a),e.provider("ObibaServerConfigResource",r),t.setPath("views/pagination-template.html")}])}(),ngObibaMica.utils=angular.module("obiba.mica.utils",["schemaForm","LocalStorageModule"]),ngObibaMica.utils.factory("urlEncode",function(){return function(e){return window.encodeURIComponent(e)}}).service("GraphicChartsConfigurations",function(){this.getClientConfig=function(){return!0},this.setClientConfig=function(){return!0}}).directive("fixedHeader",["$timeout","$window",function(r,a){return{restrict:"A",scope:{tableMaxHeight:"@",trigger:"=fixedHeader"},link:function(n,e){var s=e[0];function t(){n.redraw||(angular.element(s.querySelectorAll("thead, tbody, tfoot")).css("display",""),r(function(){n.redraw=!0;var i=0;if(angular.forEach(s.querySelectorAll("tr:first-child th"),function(e,t){var r=s.querySelector("tbody tr:first-child td:nth-child("+(t+1)+")"),a=s.querySelector("tfoot tr:first-child td:nth-child("+(t+1)+")"),n=r?r.offsetWidth:e.offsetWidth;r&&(r.style.width=n+"px"),e&&(e.style.width=n+"px"),a&&(a.style.width=n+"px"),i+=n}),angular.element(s.querySelectorAll("thead, tfoot")).css("display","block"),angular.element(s.querySelectorAll("tbody")).css({display:"block","max-height":n.tableMaxHeight||"inherit",overflow:"auto"}),i<s.offsetWidth){var e=s.querySelector("tbody tr:first-child td:last-child");e&&(e.style.width=e.offsetWidth+s.offsetWidth-i+"px",(e=s.querySelector("thead tr:first-child th:last-child")).style.width=e.offsetWidth+s.offsetWidth-i+"px")}var t=s.querySelector("tbody"),r=t.offsetWidth-t.clientWidth;if(0<r){var a=s.querySelector("tbody tr:first-child td:last-child");a.style.width=parseInt(a.style.width.replace("px",""))-r+"px"}n.redraw=!1}))}n.redraw=!1,n.$watchGroup(["trigger",function(){return e=s.querySelector("tbody"),"none"!==a.getComputedStyle(e).display&&0!==e.offsetWidth&&null!==s.querySelector("tbody tr:first-child");var e}],function(e){!0===e[1]&&t()}),n.$watch(function(){return s.offsetWidth},function(){t()})}}}]).directive("routeChecker",["$route",function(n){return{restrict:"A",scope:{routeCheckerHidesParent:"="},link:function(e,t,r){var a=r.ngHref.substr(1,r.ngHref.length-1);Object.keys(n.routes).filter(function(e){var t=n.routes[e].regexp;return!!t&&t.test(a)}).pop()||(e.routeCheckerHidesParent?t.parent().hide():t.hide())}}}]).factory("FormDirtyStateObserver",["$uibModal","$location",function(a,n){var i;return{observe:function(r){i&&i(),i=r.$on("$locationChangeStart",function(e,t){if(r.form&&r.form.$dirty)return a.open({backdrop:"static",controller:["$scope","$uibModalInstance",function(e,t){e.ok=function(){t.close(!0)},e.cancel=function(){t.dismiss("cancel")}}],templateUrl:"utils/views/unsaved-modal.html"}).result.then(function(e){!0===e&&(i(),n.path(angular.copy(n).url(t).hash()))}),void e.preventDefault();i()})},unobserve:function(){i&&i()}}}]).service("SfOptionsService",["$translate","$q",function(e,r){var a=["required","errors.does-not-validate","errors.localized.completed"];this.transform=function(){var t=r.defer();return e(a).then(function(e){t.resolve({validationMessage:{302:e.required,default:e["errors.does-not-validate"],completed:e["errors.localized.completed"]}})}),t.promise}}]).config(["schemaFormProvider",function(e){e.postProcess(function(e){return e.filter(function(e){return e.hasOwnProperty("wordLimit")}).forEach(function(t){t.$validators={wordLimitError:function(e){return!(angular.isDefined(e)&&null!==e&&(e.match(/\S+/g)||[]).length>parseInt(t.wordLimit))}}}),e})}]).config(["localStorageServiceProvider",function(e){e.setPrefix("mica").setStorageType("localStorage")}]);var UserProfileService=function(){function e(){}return e.prototype.getAttribute=function(e,t){return this.getAttibuteValue(e,t)},e.prototype.getFullName=function(e){var t=this.getProfileAttributeValue(e,"firstName"),r=this.getProfileAttributeValue(e,"lastName");return t&&r?t+" "+r:null},e.prototype.getEmail=function(e){return this.getProfileAttributeValue(e,"email")},e.prototype.getProfileAttributeValue=function(e,t){return e?this.getAttibuteValue(e.attributes,t):null},e.prototype.getAttibuteValue=function(e,t){if(e){var r=e.filter(function(e){return e.key===t});return r&&0<r.length?r[0].value:null}return null},e}();ngObibaMica.utils.service("UserProfileService",UserProfileService);var UserProfileModalService=function(){function e(e,t){this.$uibModal=e,this.UserProfileService=t}return e.prototype.show=function(e){var t={email:this.UserProfileService.getEmail(e),fullName:this.UserProfileService.getFullName(e),profile:e};this.$uibModal.open({controller:["$scope",function(e){return e.applicant=t}],templateUrl:"utils/services/user-profile-modal/service.html"})},e.$inject=["$uibModal","UserProfileService"],e}();ngObibaMica.utils.service("UserProfileModalService",UserProfileModalService);var CustomWatchDomElementService=function(){function e(){this.attributes=[]}return e.prototype.configWatch=function(e,t){return this.node=e,this.attributes=t,this.config={attributeFilter:this.attributes},this},e.prototype.customWatch=function(a){new MutationObserver(function(e){for(var t=0,r=e;t<r.length;t++)"attributes"===r[t].type&&a()}).observe(this.node,this.config)},e}();ngObibaMica.utils.service("CustomWatchDomElementService",[CustomWatchDomElementService]),angular.module("obiba.mica.utils").component("obibaSchemaFormRenderer",{bindings:{schemaForm:"<",model:"<",readOnly:"<",parsingErrorCallbacks:"<",onRedraw:"<"},templateUrl:"utils/components/entity-schema-form/component.html",controller:["$rootScope","$timeout","LocalizedSchemaFormService","SfOptionsService","JsonUtils",function(e,s,o,t,c){var l=this,u=e.$new();function d(e){return"object"!=typeof l.parsingErrorCallbacks?function(){console.error("Error parsing ",e,l.schemaForm)}:l.parsingErrorCallbacks[e]}function h(e){"function"==typeof l.onRedraw&&l.onRedraw(e)}l.form={},l.sfOptions={},t.transform().then(function(e){l.sfOptions=e,l.sfOptions.pristine={errors:!0,success:!1}}),l.$onChanges=function(e){if(e&&e.schemaForm&&e.schemaForm.currentValue){h(!1);var t=e.schemaForm.currentValue;l.form.definition=(n=o.translate(c.parseJsonSafely(t.definition,[])),i=d("definition"),0===n.length&&(n=[],"function"==typeof i&&i()),n),l.form.schema=(r=o.translate(c.parseJsonSafely(t.schema,{})),a=d("schema"),0===Object.getOwnPropertyNames(r).length&&(r={},"function"==typeof a&&a()),r),l.form.downloadTemplate="Template"===t.pdfDownloadType,l.form.schema.readonly=l.readOnly}var r,a,n,i;s(function(){l.form=angular.copy(l.form),u.$broadcast("schemaFormRedraw"),h(!0)},250)}}]}),ngObibaMica.file=angular.module("obiba.mica.file",["ngResource"]),ngObibaMica.file.filter("bytes",function(){return function(e){return null==e?"":filesize(e)}}),ngObibaMica.file.factory("TempFileResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("TempFileResource"),{},{get:{method:"GET"},delete:{method:"DELETE"}})}]),ngObibaMica.attachment=angular.module("obiba.mica.attachment",["obiba.mica.file","ui.bootstrap","ngFileUpload","templates-ngObibaMica"]),ngObibaMica.attachment.directive("attachmentList",[function(){return{restrict:"E",scope:{hrefBuilder:"=",files:"=",emptyMessage:"="},templateUrl:"attachment/attachment-list-template.html",link:function(r){r.attachments=[],r.hrefBuilder=r.hrefBuilder||function(e){return e.id},r.hasAttachments=!1,r.$watch("files",function(e){e&&(r.hasAttachments=0<e.length,r.attachments=e.map(function(e){var t=angular.copy(e);return t.href=r.hrefBuilder(e),t}))},!0)}}}]).directive("attachmentInput",[function(){return{restrict:"E",require:"^form",scope:{multiple:"=",accept:"@",files:"=",disabled:"=",onError:"=",deleteAttachments:"<"},templateUrl:"attachment/attachment-input-template.html",controller:"AttachmentCtrl"}}]).controller("AttachmentCtrl",["$scope","$timeout","$log","Upload","TempFileResource","ngObibaMicaUrl",function(a,s,o,t,c,r){void 0!==a.deleteAttachments&&null!==a.deleteAttachments||(a.deleteAttachments=!0);a.onFileSelect=function(e){a.uploadedFiles=e,a.uploadedFiles.forEach(function(e){!function(e){a.files=a.files||[];var i={showProgressBar:!0,lang:"en",progress:0,fileName:e.name,size:e.size};a.multiple||a.files.splice(0,a.files.length),a.files.push(i),a.upload=t.upload({url:r.getUrl("TempFileUploadResource"),method:"POST",file:e}).progress(function(e){i.progress=parseInt(100*e.loaded/e.total)}).success(function(e,t,r){var a=r().location.split("/"),n=a[a.length-1];c.get({id:n},function(e){o.debug("tempFile",e),i.id=e.id,i.md5=e.md5,i.justUploaded=!0,i.timestamps={created:new Date},s(function(){i.showProgressBar=!1},1e3)})}).error(function(e){o.error("File upload failed: ",JSON.stringify(e,null,2));var t=a.files.indexOf(i);-1!==t&&a.files.splice(t,1),a.onError&&a.onError(i)})}(e)})},a.deleteTempFile=function(r){c.delete({id:r},function(){for(var e=a.files.length;e--;){var t=a.files[e];t.justUploaded&&t.id===r&&a.files.splice(e,1)}})},a.deleteFile=function(e){for(var t=a.files.length;t--;)a.files[t].id===e&&a.files.splice(t,1)}}]),ngObibaMica.access=angular.module("obiba.mica.access",["pascalprecht.translate","ui.bootstrap","obiba.alert","obiba.comments","obiba.mica.attachment","obiba.utils","angularMoment","templates-ngObibaMica"]),ngObibaMica.access.config(["$provide",function(e){e.provider("ngObibaMicaAccessTemplateUrl",(new NgObibaMicaTemplateUrlFactory).create({list:{header:null,footer:null},view:{header:null,footer:null},form:{header:null,footer:null},amendmentView:{header:null,footer:null},amendmentForm:{header:null,footer:null}}))}]),function(){function t(r,t){var a=this;a.filterOutItemFromCollection=function(t,e){return(e||[]).filter(function(e){return e.action!==t.action||e.author!==t.author||e.changedOn!==t.changedOn})},a.sourceCollectionWithout=function(e){return a.filterOutItemFromCollection(e,a.sourceCollection)},a.replaceActionNameByTranslationKey=function(e){var t=(a.predefinedActionNames||[]).indexOf(e.action);-1<t&&(e.action=a.predefinedActions[t])},a.add=function(e){if(a.showError=!1,e&&e.action&&e.changedOn){a.replaceActionNameByTranslationKey(e),e.changedOn=e.changedOn.toISOString(),e.author||(e.author=r.login());var t=a.sourceCollectionWithout(e);t.push(e),a.update&&"function"==typeof a.update?(a.update({logs:t}),a.item={},a.changedOn=null):console.error("Did not create",e)}else a.showError=!0},a.predefinedActionsChanged=function(e){e.predefinedActions&&e.predefinedActions.currentValue&&(a.predefinedActionNames=a.predefinedActions.map(function(e){return t("translate")(e)}))},a.$onChanges=function(e){a.predefinedActionsChanged(e)}}angular.module("obiba.mica.access").component("actionLogEditor",{bindings:{sourceCollection:"<",predefinedActions:"<",update:"&"},templateUrl:"access/components/action-log/component.html",controller:["SessionProxy","$filter",t]}),angular.module("obiba.mica.access").component("actionLogItemEditor",{bindings:{item:"<",sourceCollection:"<",predefinedActions:"<",update:"&"},templateUrl:"access/components/action-log/item/component.html",controller:["SessionProxy","$uibModal","$filter",function(e,a,n){var i=this;t.call(i,e,n),i.remove=function(t){a.open({templateUrl:"access/components/action-log/item/delete-modal.html",controller:["$uibModalInstance","actionLogItem",function(e,t){this.item=t}],controllerAs:"$modal",resolve:{actionLogItem:function(){return{action:n("translate")(t.action),author:t.author,changedOn:moment(t.changedOn).calendar()}}}}).result.then(function(){var e=i.sourceCollectionWithout(t);e.length<i.sourceCollection.length&&i.update&&"function"==typeof i.update?i.update({logs:e}):console.error("Did not remove",t)})},i.edit=function(r){a.open({templateUrl:"access/components/action-log/item/edit-modal.html",controller:["$uibModalInstance","actionLogItem","predefinedActionNames",function(e,t,r){this.item=t,this.predefinedActionNames=r}],controllerAs:"$modal",size:"sm",resolve:{actionLogItem:function(){return{action:n("translate")(r.action),author:r.author,changedOn:new Date(r.changedOn)}},predefinedActionNames:function(){return i.predefinedActionNames}}}).result.then(function(e){if(i.replaceActionNameByTranslationKey(e),e.changedOn=e.changedOn.toISOString(),i.update&&"function"==typeof i.update){var t=i.sourceCollectionWithout(r);(t=i.filterOutItemFromCollection(e,t)).push(e),i.update({logs:t})}else console.error("Did not update",r)})},i.$onChanges=function(e){var t;i.predefinedActionsChanged(e),i.showButtons=i.item&&(t=i.item)&&t.hasOwnProperty("action")&&t.hasOwnProperty("author")&&t.hasOwnProperty("changedOn")}}]})}(),ngObibaMica.access.component("entityList",{bindings:{parentId:"<",canAdd:"<"},templateUrl:"access/components/entity-list/component.html",controller:["$rootScope","DataAccessEntityUrls","DataAccessEntityResource","DataAccessEntityService","NOTIFICATION_EVENTS","SessionProxy","USER_ROLES","ngObibaMicaAccessTemplateUrl","DataAccessRequestConfig","ngObibaMicaUrl","$translate","UserProfileService","UserProfileModalService",function(t,r,a,n,i,s,o,c,l,e,u,d,h){var m=this;function p(e){for(var t=0;t<e.length;t++){var r=e[t];if("OPENED"!==r.status)for(var a=0;a<r.statusChangeHistory.length;a++){var n=r.statusChangeHistory[a];"OPENED"===n.from&&"SUBMITTED"===n.to&&(r.submissionDate=n.changedOn)}}m.requests=e,m.loading=!1}var f=function(){m.loading=!1};function g(e,t){m.requestToDelete===t&&(a.delete(m.entityBaseUrl,m.requestToDelete).$promise.then(function(){m.loading=!0,a.list(m.listUrl).$promise.then(p,f)},f),delete m.requestToDelete)}m.getHistoryExportHref=function(){return e.getUrl("DataAccessRequestsExportHistoryResource").replace(":lang",u.use())},m.getCsvExportHref=function(){return e.getUrl("DataAccessRequestsExportCsvResource").replace(":lang",u.use())},m.getDataAccessRequestPageUrl=function(){return e.getUrl("DataAccessClientDetailPath")?e.getUrl("BaseUrl")+e.getUrl("DataAccessClientDetailPath"):null},m.deleteRequest=function(e){m.requestToDelete=e.id,t.$broadcast(i.showConfirmDialog,{titleKey:"data-access-request.delete-dialog.title",messageKey:"data-access-request.delete-dialog.message",messageArgs:[e.title,e.applicant]},e.id)},m.$onInit=function(){m.headerTemplateUrl=c.getHeaderUrl("list"),m.footerTemplateUrl=c.getFooterUrl("list"),m.config=l.getOptions(),m.searchStatus={},m.loading=!0,m.addButtonCaption=null===m.parentId?m.config.newRequestButtonCaption||"data-access-request.add":"data-access-amendment.add",m.noneCaption=null===m.parentId?"data-access-request.none":"data-access-amendment.none",m.actions=n.actions,m.showApplicant=0<s.roles().filter(function(e){return-1<[o.dao,o.admin].indexOf(e)}).length;var e=t.$new();m.$on=angular.bind(e,e.$on),m.$on(i.confirmDialogAccepted,g),n.getStatusFilterData(function(e){m.REQUEST_STATUS=e})},m.$onChanges=function(e){e.parentId&&void 0!==e.parentId.currentValue&&(null===e.parentId.currentValue?(m.listUrl=r.getDataAccessRequestsUrl(),m.entityBaseUrl=r.getDataAccessRequestBaseUrl()):(m.listUrl=r.getDataAccessAmendmentsUrl(m.parentId),m.entityBaseUrl=r.getDataAccessAmendmentBaseUrl(m.parentId)),a.list(m.listUrl).$promise.then(p,f))},m.UserProfileService=d,m.UserProfileModalService=h}]});var PrintFriendlyController=function(){},PrintFriendlyComponent=function(){this.transclude=!0,this.bindings={accessForm:"<",lastSubmittedDate:"<",model:"<",project:"<",validForm:"<"},this.controller=PrintFriendlyController,this.controllerAs="$ctrl",this.templateUrl="access/components/print-friendly-view/component.html"};ngObibaMica.access.component("printFriendlyView",new PrintFriendlyComponent),angular.module("obiba.mica.access").service("DataAccessEntityFormService",["$rootScope","$filter","$location","DataAccessEntityUrls","DataAccessEntityResource","DataAccessEntityService","NOTIFICATION_EVENTS",function(u,d,h,m,p,f,g){this.for=function(e,r,a,n){var t={},i=r["obiba.mica.DataAccessAmendmentDto.amendment"].parentId,s=i?m.getDataAccessAmendmentUrl(i,r.id):m.getDataAccessRequestUrl(r.id),o=i?"data-access-amendment":"data-access-request";function c(e,t,r){u.$broadcast(g.showConfirmDialog,{titleKey:o+".status-change-confirmation.title",messageKey:null!==t?t:o+".status-change-confirmation.message",messageArgs:null!==r?[d("translate")(r).toLowerCase()]:[]},e)}function l(e,t){e===t&&p.updateStatus(s,r.id,e).$promise.then(a,n)}return t.reopen=function(){c(f.status.OPENED,null,"reopen")},t.review=function(){c(f.status.REVIEWED,o+".status-change-confirmation.message-review",null)},t.approve=function(){c(f.status.APPROVED,null,"approve")},t.reject=function(){c(f.status.REJECTED,null,"reject")},t.conditionallyApprove=function(){c(f.status.CONDITIONALLY_APPROVED,null,"conditionallyApprove")},t.delete=function(){u.$broadcast(g.showConfirmDialog,{titleKey:o+".delete-dialog.title",messageKey:o+".delete-dialog.message",messageArgs:[r.title,r.applicant]},r.id)},t.printForm=function(){setTimeout(function(){window.print()},250)},e.$on(g.confirmDialogAccepted,function(e,t){r.id===t&&p.delete(s,t).$promise.then(function(){h.path(i?"/data-access-request/"+i:"/data-access-requests").replace()})}),e.$on(g.confirmDialogAccepted,function(e,t){l(f.status.OPENED,t)}),e.$on(g.confirmDialogAccepted,function(e,t){l(f.status.REVIEWED,t)}),e.$on(g.confirmDialogAccepted,function(e,t){l(f.status.CONDITIONALLY_APPROVED,t)}),e.$on(g.confirmDialogAccepted,function(e,t){l(f.status.APPROVED,t)}),e.$on(g.confirmDialogAccepted,function(e,t){l(f.status.REJECTED,t)}),t}}]);var DataAccessEntityResource=function(){function e(e,t,r,a,n,i){this.DataAccessRequestsResource=e,this.DataAccessRequestResource=t,this.DataAccessAmendmentsResource=r,this.DataAccessAmendmentResource=a,this.DataAccessRequestStatusResource=n,this.DataAccessAmendmentStatusResource=i}return e.prototype.list=function(e){var t=this.getParentId(e);return t?this.DataAccessAmendmentsResource.query({parentId:t}):this.DataAccessRequestsResource.query()},e.prototype.create=function(e,t,r,a){return this.getParentId(e)?this.DataAccessAmendmentsResource.save(t,r,a):this.DataAccessRequestsResource.save(t,r,a)},e.prototype.update=function(e,t){return this.getParentId(e)?this.DataAccessAmendmentResource.save(t):this.DataAccessRequestResource.save(t)},e.prototype.get=function(e,t){var r=this.getParentId(e);return r?this.DataAccessAmendmentResource.get({parentId:r,id:t}):this.DataAccessRequestResource.get({id:t})},e.prototype.delete=function(e,t){var r=this.getParentId(e);return r?this.DataAccessAmendmentResource.delete({parentId:r,id:t}):this.DataAccessRequestResource.delete({id:t})},e.prototype.updateStatus=function(e,t,r){var a=this.getParentId(e);return a?this.DataAccessAmendmentStatusResource.update({parentId:a,id:t,status:r}):this.DataAccessRequestStatusResource.update({id:t,status:r})},e.prototype.getParentId=function(e){var t=/data-access-request\/(\w+)(?:\/amendment)?/.exec(e);return t&&2===t.length?t[t.index]:null},e.$inject=["DataAccessRequestsResource","DataAccessRequestResource","DataAccessAmendmentsResource","DataAccessAmendmentResource","DataAccessRequestStatusResource","DataAccessAmendmentStatusResource"],e}();ngObibaMica.access.service("DataAccessEntityResource",DataAccessEntityResource),ngObibaMica.access.service("DataAccessEntityService",["$translate","SessionProxy","USER_ROLES","ngObibaMicaUrl",function(t,a,n,e){var r={OPENED:"OPENED",SUBMITTED:"SUBMITTED",REVIEWED:"REVIEWED",CONDITIONALLY_APPROVED:"CONDITIONALLY_APPROVED",APPROVED:"APPROVED",REJECTED:"REJECTED"},i={canViewProfile:function(t){var r=!1,e=a.roles();return angular.forEach(e,function(e){e!==t&&e!==n.admin||(r=!0)}),r},canView:function(e){return o(e,"VIEW")},canEdit:function(e){return o(e,"EDIT")},canEditStatus:function(e){return o(e,"EDIT_STATUS")},canDelete:function(e){return o(e,"DELETE")},canEditAttachments:function(e){return o(e,"EDIT_ATTACHMENTS")},canDeleteAttachments:function(e){return o(e,"DELETE_ATTACHMENTS")},canAddAmendments:function(e){return!!e["obiba.mica.DataAccessAmendmentDto.amendment"]||o(e,"ADD_AMENDMENTS")},canEditActionLogs:function(e){return o(e,"EDIT_ACTION_LOGS")},canViewPrivateComments:function(e){return o(e,"VIEW_PRIVATE_COMMENTS")},canAddPrivateComments:function(e){return o(e,"ADD_PRIVATE_COMMENTS")}},s={canSubmit:function(e){return c(e,"SUBMITTED")},canReopen:function(e){return c(e,"OPENED")},canReview:function(e){return c(e,"REVIEWED")},canConditionallyApprove:function(e){return c(e,"CONDITIONALLY_APPROVED")},canApprove:function(e){return c(e,"APPROVED")},canReject:function(e){return c(e,"REJECTED")}};function o(e,t){return!!e.actions&&-1!==e.actions.indexOf(t)}function c(e,t){return e.nextStatus?-1!==e.nextStatus.indexOf(t):null}return this.status=r,this.actions=i,this.nextStatus=s,this.getStatusFilterData=function(e){e&&t(Object.keys(r)).then(function(t){e(Object.keys(t).map(function(e){return{key:e,translation:t[e]}}))})},this.processLogsHistory=function(e){return(e||[]).map(function(e){switch(function(e){var t="opened";if(e.action)t="action";else if("OPENED"!==e.from||e.from!==e.to)switch(e.to){case"OPENED":t="reopened";break;case"SUBMITTED":t="submitted";break;case"REVIEWED":t="reviewed";break;case"CONDITIONALLY_APPROVED":t="conditionallyApproved";break;case"APPROVED":t="approved";break;case"REJECTED":t="rejected"}return t}(e)){case"opened":e.msg="data-access-request.histories.opened",e.icon="glyphicon glyphicon-saved";break;case"reopened":e.msg="data-access-request.histories.reopened",e.icon="glyphicon glyphicon-saved";break;case"submitted":e.msg="data-access-request.histories.submitted",e.icon="glyphicon glyphicon-export";break;case"reviewed":e.msg="data-access-request.histories.reviewed",e.icon="glyphicon glyphicon-check";break;case"conditionallyApproved":e.msg="data-access-request.histories.conditionallyApproved",e.icon="glyphicon glyphicon-unchecked";break;case"approved":e.msg="data-access-request.histories.approved",e.icon="glyphicon glyphicon-ok";break;case"rejected":e.msg="data-access-request.histories.rejected",e.icon="glyphicon glyphicon-remove";break;case"action":e.msg=e.action,e.icon="glyphicon glyphicon-play-circle",e.changedOn=new Date(e.changedOn).toISOString()}return e})},this.getListDataAccessRequestPageUrl=function(){return e.getUrl("DataAccessClientListPath")?e.getUrl("BaseUrl")+e.getUrl("DataAccessClientListPath"):null},this}]);var DataAccessEntityUrls=function(){function e(){}return e.prototype.getDataAccessRequestsUrl=function(){return"/data-access-requests"},e.prototype.getDataAccessRequestBaseUrl=function(){return"/data-access-request"},e.prototype.getDataAccessRequestUrl=function(e){return this.getDataAccessRequestBaseUrl()+"/"+e},e.prototype.getDataAccessAmendmentsUrl=function(e){return"/data-access-request/"+e+"/amendments"},e.prototype.getDataAccessAmendmentBaseUrl=function(e){return"/data-access-request/"+e+"/amendment"},e.prototype.getDataAccessAmendmentUrl=function(e,t){return this.getDataAccessAmendmentBaseUrl(e)+"/"+t},e}();ngObibaMica.access.service("DataAccessEntityUrls",DataAccessEntityUrls),ngObibaMica.access.controller("DataAccessRequestListController",["$scope","ngObibaMicaAccessTemplateUrl",function(e,t){e.headerTemplateUrl=t.getHeaderUrl("list"),e.footerTemplateUrl=t.getFooterUrl("list")}]).controller("DataAccessRequestViewController",["$rootScope","$scope","$q","$location","$uibModal","$routeParams","$filter","$translate","DataAccessRequestResource","DataAccessAmendmentsResource","DataAccessEntityService","DataAccessRequestStatusResource","DataAccessFormConfigResource","DataAccessRequestAttachmentsUpdateResource","DataAccessRequestCommentsResource","DataAccessRequestCommentResource","ngObibaMicaUrl","ngObibaMicaAccessTemplateUrl","AlertService","ServerErrorUtils","NOTIFICATION_EVENTS","DataAccessRequestConfig","SfOptionsService","moment","UserProfileService",function(a,n,e,r,t,i,s,o,c,l,u,d,h,m,p,f,g,y,b,v,S,T,E,O,R){var C=Object.freeze({form:0,amendments:1,documents:2,comments:3,privateComments:4,history:5});function D(e){b.alert({id:"DataAccessRequestViewController",type:"danger",msg:v.buildMessage(e)})}function A(){p.query({id:i.id,admin:!0===n.privateComments||""},function(e){n.form.comments=e||[]})}function w(e){e&&(n.attachments=angular.copy(n.dataAccessRequest.attachments)||[]),n.showAttachmentsForm=e}function I(){e.all([c.get({id:i.id}).$promise,l.getLogHistory({id:i.id}).$promise]).then(function(e){var t=e[0],r=e[1];try{n.dataAccessRequest=t,n.form.model=t.content?JSON.parse(t.content):{};var a=g.getUrl("DataAccessRequestDownloadPdfResource").replace(":id",n.dataAccessRequest.id);n.requestDownloadUrl=a+(-1!==a.indexOf("?q=")?"&":"?")+"lang="+o.use(),n.attachments=t.attachments||[],n.lastSubmittedDate=(n.dataAccessRequest.logsHistory||[]).filter(function(e){return e.to===u.status.SUBMITTED}).sort(function(e,t){return O(e).isBefore(t)?-1:O(e).isSame(t)?0:O(e).isAfter(t)?1:void 0}).pop(),n.logsHistory=u.processLogsHistory([].concat(t.statusChangeHistory,t.actionLogHistory||[],r||[]).sort(function(e,t){return e.changedOn.localeCompare(t.changedOn)}))}catch(e){n.validForm=!1,n.form.model={},b.alert({id:"DataAccessRequestViewController",type:"danger",msgKey:"data-access-request.parse-error"})}n.loading=!1},D)}function N(){E.transform().then(function(e){n.sfOptions=e,n.sfOptions.pristine={errors:!0,success:!1}}),h.get(function(e){n.dataAccessForm=e},D)}function U(){setTimeout(function(){I()})}function q(e,t,r){a.$broadcast(S.showConfirmDialog,{titleKey:"data-access-request.status-change-confirmation.title",messageKey:null!==t?t:"data-access-request.status-change-confirmation.message",messageArgs:null!==r?[s("translate")(r).toLowerCase()]:[]},e)}function L(e,t){e===t&&d.update({id:n.dataAccessRequest.id,status:e},U,D)}n.logsHistory=[],n.parentId=void 0,n.loading=!1,n.validForm=!0,n.config=T.getOptions(),n.actions=u.actions,n.nextStatus=u.nextStatus,n.showAttachmentsForm=!1,n.selectTab=function(e){switch(e){case C.form:case C.history:case C.documents:break;case C.comments:n.privateComments=!1,void 0===n.parentId&&A();break;case C.privateComments:void 0===n.parentId&&(n.privateComments=!0,A());break;case C.amendments:n.parentId=i.id}},n.delete=function(){n.requestToDelete=n.dataAccessRequest.id,a.$broadcast(S.showConfirmDialog,{titleKey:"data-access-request.delete-dialog.title",messageKey:"data-access-request.delete-dialog.message",messageArgs:[n.dataAccessRequest.title,n.dataAccessRequest.applicant]},n.requestToDelete)},n.submitComment=function(e){p.save({id:i.id,admin:!0===n.privateComments},e.message,A,D)},n.updateComment=function(e){f.update({id:i.id,commentId:e.id},e.message,A,D)},n.deleteComment=function(e){n.commentToDelete=e.id,a.$broadcast(S.showConfirmDialog,{titleKey:"comment.delete-dialog.title",messageKey:"comment.delete-dialog.message",messageArgs:[e.createdBy]},e.id)},n.getDownloadHref=function(e){return g.getUrl("DataAccessRequestAttachmentDownloadResource").replace(":id",n.dataAccessRequest.id).replace(":attachmentId",e.id)},n.updateAttachments=function(){var e=angular.copy(n.dataAccessRequest);e.attachments=n.attachments,m.save(e,function(){w(!1),I()})},n.cancelAttachments=function(){w(!1)},n.editAttachments=function(){w(!0)},n.updateActionLogs=function(e){Array.isArray(e)&&(n.loading=!0,n.dataAccessRequest.actionLogHistory=e,c.editActionLogs(n.dataAccessRequest,function(){U()}))},n.onAttachmentError=function(e){b.alert({id:"DataAccessRequestViewController",type:"danger",msgKey:"server.error.file.upload",msgArgs:[e.fileName]})},n.headerTemplateUrl=y.getHeaderUrl("view"),n.footerTemplateUrl=y.getFooterUrl("view"),n.submit=function(){n.$broadcast("schemaFormValidate"),n.forms.requestForm.$valid?d.update({id:n.dataAccessRequest.id,status:u.status.SUBMITTED},function(){t.open({scope:n,templateUrl:"access/views/data-access-request-submitted-modal.html"}).result.then(function(){U()})},D):b.alert({id:"DataAccessRequestViewController",type:"danger",msgKey:"data-access-request.submit.invalid"})},n.reopen=function(){q(u.status.OPENED,null,"reopen")},n.review=function(){q(u.status.REVIEWED,"data-access-request.status-change-confirmation.message-review",null)},n.approve=function(){q(u.status.APPROVED,null,"approve")},n.reject=function(){q(u.status.REJECTED,null,"reject")},n.conditionallyApprove=function(){q(u.status.CONDITIONALLY_APPROVED,null,"conditionallyApprove")},n.UserProfileService=R,n.userProfile=function(e){n.applicant=e,t.open({scope:n,templateUrl:"access/views/data-access-request-profile-user-modal.html"})},n.dataAccessRequest={},n.getDataAccessListPageUrl=u.getListDataAccessRequestPageUrl(),n.printForm=function(){setTimeout(function(){window.print()},250)},n.getFullName=function(e){return R.getFullName(e)},n.$on(S.confirmDialogAccepted,function(e,t){n.requestToDelete===t&&(c.delete({id:n.requestToDelete},function(){r.path("/data-access-requests").replace()}),delete n.requestToDelete)}),n.$on(S.confirmDialogAccepted,function(e,t){n.commentToDelete===t&&f.delete({id:i.id,commentId:t},{},A,D)}),n.$on(S.confirmDialogAccepted,function(e,t){L(u.status.OPENED,t)}),n.$on(S.confirmDialogAccepted,function(e,t){L(u.status.REVIEWED,t)}),n.$on(S.confirmDialogAccepted,function(e,t){L(u.status.CONDITIONALLY_APPROVED,t)}),n.$on(S.confirmDialogAccepted,function(e,t){L(u.status.APPROVED,t)}),n.$on(S.confirmDialogAccepted,function(e,t){L(u.status.REJECTED,t)}),a.$on("$translateChangeSuccess",N),n.tabs={activeTab:0},n.TAB_NAMES=C,n.forms={},n.form={schema:null,definition:null,model:{},comments:null},i.id&&(N(),I())}]).controller("DataAccessRequestEditController",["$rootScope","$log","$scope","$routeParams","$location","$uibModal","LocalizedSchemaFormService","DataAccessRequestsResource","DataAccessRequestResource","DataAccessFormConfigResource","JsonUtils","AlertService","ServerErrorUtils","SessionProxy","DataAccessEntityService","ngObibaMicaAccessTemplateUrl","DataAccessRequestConfig","SfOptionsService","FormDirtyStateObserver","DataAccessRequestDirtyStateService","$timeout",function(e,t,r,a,n,i,s,o,c,l,u,d,h,m,p,f,g,y,b,v,S){var T=function(e,t){b.unobserve();var r=t().location.split("/");n.path("/data-access-request/"+r[r.length-1]).replace()},E=function(e){d.alert({id:"DataAccessRequestEditController",type:"danger",msg:h.buildMessage(e)})};function O(e){d.alert({id:"DataAccessRequestEditController",type:"danger",msgKey:"server.error.file.upload",msgArgs:[e.fileName]})}r.getDataAccessListPageUrl=p.getListDataAccessRequestPageUrl();function R(){y.transform().then(function(e){r.sfOptions=e,r.sfOptions.onError=O}),l.get(function(e){r.sfForm.definition=s.translate(u.parseJsonSafely(e.definition,[])),r.sfForm.schema=s.translate(u.parseJsonSafely(e.schema,{})),0===r.sfForm.definition.length&&(r.sfForm.definition=[],r.validForm=!1,d.alert({id:"DataAccessRequestEditController",type:"danger",msgKey:"data-access-config.parse-error.definition"})),0===Object.getOwnPropertyNames(r.sfForm.schema).length&&(r.sfForm.schema={},r.validForm=!1,d.alert({id:"DataAccessRequestEditController",type:"danger",msgKey:"data-access-config.parse-error.schema"})),r.validForm&&(r.dataAccessRequest=a.id?c.get({id:a.id},function(e){try{r.sfForm.model=e.content?JSON.parse(e.content):{}}catch(e){r.sfForm.model={},d.alert({id:"DataAccessRequestEditController",type:"danger",msgKey:"data-access-request.parse-error"})}return r.canEdit=p.actions.canEdit(e),r.sfForm.schema.readonly=!r.canEdit,r.$broadcast("schemaFormRedraw"),e.attachments=e.attachments||[],e}):{applicant:m.login(),status:p.status.OPENED,attachments:[]}),S(function(){r.sfForm=angular.copy(r.sfForm),r.loaded=!0},250)},E)}e.$on("$translateChangeSuccess",function(){R()}),R(),r.loaded=!1,r.config=g.getOptions(),r.validForm=!0,r.requestId=a.id,r.newRequest=!a.id,r.cancel=function(){n.path("/data-access-request"+(a.id?"/"+a.id:"s")).replace()},r.save=function(){r.dataAccessRequest.content=angular.toJson(r.sfForm.model),r.newRequest?o.save(r.dataAccessRequest,T,E):c.save(r.dataAccessRequest,function(){b.unobserve(),n.path("/data-access-request"+(r.dataAccessRequest.id?"/"+r.dataAccessRequest.id:"s")).replace()},E)},r.editable=!0,r.validate=function(e){r.$broadcast("schemaFormValidate"),i.open({resolve:{isValid:e.$valid},templateUrl:"access/views/data-access-request-validation-modal.html",controller:["$scope","isValid",function(e,t){e.isValid=t}]})},r.headerTemplateUrl=f.getHeaderUrl("form"),r.footerTemplateUrl=f.getFooterUrl("form"),r.sfForm={schema:null,definition:null,model:{}},b.observe(r),v.setForm(r.form),r.$on("$destroy",function(){v.setForm(null)})}]),angular.module("obiba.mica.access").controller("DataAccessAmendmentEditController",["$scope","$location","$q","$routeParams","$uibModal","DataAccessEntityResource","DataAccessAmendmentFormConfigResource","DataAccessEntityUrls","DataAccessEntityService","ServerErrorUtils","AlertService","DataAccessRequestDirtyStateService","FormDirtyStateObserver","SessionProxy","ngObibaMicaAccessTemplateUrl",function(a,n,e,t,r,i,s,o,c,l,u,d,h,m,p){function f(e,t){h.unobserve();var r=t().location.split("/");n.path(a.entityUrl+"/amendment/"+r[r.length-1]).replace()}function g(e){u.alert({id:"DataAccessAmendmentEditController",type:"danger",msg:l.buildMessage(e)})}function y(){h.unobserve(),d.setForm(null)}a.entityUrl=t.id?o.getDataAccessAmendmentUrl(t.parentId,t.id):o.getDataAccessRequestUrl(t.parentId),a.read=!1,a.formDrawn=!1;var b=t.id?i.get(a.entityUrl,t.id):{"obiba.mica.DataAccessAmendmentDto.amendment":{parentId:t.parentId},$promise:new Promise(function(e){setTimeout(e,0,{})}),status:c.status.OPENED},v=b.$promise.then(function(e){return e.content?JSON.parse(e.content):{}}),S=s.get();e.all([b,v,S.$promise]).then(function(e){return a.requestEntity=e[0],a.model=e[1],a.dataAccessForm=e[2],e},function(e){console.error("Failed to resolve amendment promises because",e)}),a.headerTemplateUrl=p.getHeaderUrl("amendmentForm"),a.footerTemplateUrl=p.getFooterUrl("amendmentForm"),h.observe(a),d.setForm(a.form),a.$on("$destroy",y),a.cancel=function(){y(),n.path(a.entityUrl).replace()},a.save=function(){a.requestEntity.content=angular.toJson(a.model),a.requestEntity.parentId=t.parentId,delete a.requestEntity.$promise,a.requestEntity.applicant||(a.requestEntity.applicant=m.login()),t.id?i.update(a.entityUrl,a.requestEntity).$promise.then(function(){h.unobserve(),n.path(a.entityUrl).replace()},g):i.create(a.entityUrl,a.requestEntity,f,g)},a.validate=function(e){a.$broadcast("schemaFormValidate"),r.open({resolve:{isValid:e.$valid},templateUrl:"access/views/data-access-request-validation-modal.html",controller:["$scope","isValid",function(e,t){e.isValid=t}]})},a.toggleFormDrawnStatus=function(e){a.formDrawn=e}}]),angular.module("obiba.mica.access").controller("DataAccessAmendmentViewController",["$scope","$routeParams","$q","$uibModal","DataAccessEntityResource","DataAccessEntityService","DataAccessEntityFormService","DataAccessAmendmentFormConfigResource","DataAccessEntityUrls","AlertService","ngObibaMicaAccessTemplateUrl",function(t,r,a,n,i,s,o,e,c,l,u){function d(e,t){var r=e.filter(function(e){return e.key===t});return r&&0<r.length?r[0].value:null}function h(e){return e.content?JSON.parse(e.content):{}}function m(){var e=i.get(t.entityUrl,r.id);a.all([e,e.$promise.then(h)]).then(function(e){t.requestEntity=e[0],t.model=e[1]})}t.userProfile=function(e){t.applicant=e,n.open({scope:t,templateUrl:"access/views/data-access-request-profile-user-modal.html"})},t.getFullName=function(e){return e?e.attributes?d(e.attributes,"firstName")+" "+d(e.attributes,"lastName"):e.username:null},t.getProfileEmail=function(e){return e&&e.attributes?d(e.attributes,"email"):null},t.entityUrl=c.getDataAccessAmendmentUrl(r.parentId,r.id),t.read=!0,t.formDrawn=!1;var p=i.get(t.entityUrl,r.id),f=p.$promise.then(h),g=e.get();a.all([p,f,g.$promise]).then(function(e){return t.requestEntity=e[0],t.model=e[1],t.dataAccessForm=e[2],t.actions=s.actions,t.nextStatus=s.nextStatus,Object.assign(t,o.for(t,t.requestEntity,m)),e},function(e){console.error("Failed to resolve amendment promises because",e)}),t.headerTemplateUrl=u.getHeaderUrl("amendmentView"),t.footerTemplateUrl=u.getFooterUrl("amendmentView"),t.submit=function(){t.$broadcast("schemaFormValidate"),t.forms.requestForm.$valid?i.updateStatus(t.entityUrl,r.id,s.status.SUBMITTED).$promise.then(function(){n.open({scope:t,templateUrl:"access/views/data-access-request-submitted-modal.html"}).result.then(function(){m()})}):l.alert({id:"DataAccessAmendmentViewController",type:"danger",msgKey:"data-access-request.submit.invalid"})},t.toggleFormDrawnStatus=function(e){t.formDrawn=e}}]),ngObibaMica.access.config(["$routeProvider",function(e){e.when("/data-access-requests",{templateUrl:"access/views/data-access-request-list.html",controller:"DataAccessRequestListController"}).when("/data-access-request/new",{templateUrl:"access/views/data-access-request-form.html",controller:"DataAccessRequestEditController"}).when("/data-access-request/:id/edit",{templateUrl:"access/views/data-access-request-form.html",controller:"DataAccessRequestEditController"}).when("/data-access-request/:id",{templateUrl:"access/views/data-access-request-view.html",controller:"DataAccessRequestViewController"}).when("/data-access-request/:parentId/amendment/new",{templateUrl:"access/views/data-access-amendment-view.html",controller:"DataAccessAmendmentEditController"}).when("/data-access-request/:parentId/amendment/:id/edit",{templateUrl:"access/views/data-access-amendment-view.html",controller:"DataAccessAmendmentEditController"}).when("/data-access-request/:parentId/amendment/:id",{templateUrl:"access/views/data-access-amendment-view.html",controller:"DataAccessAmendmentViewController"})}]),ngObibaMica.access.factory("DataAccessFormConfigResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessFormConfigResource"),{},{get:{method:"GET",errorHandler:!0}})}]).factory("DataAccessAmendmentFormConfigResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessAmendmentFormConfigResource"),{},{get:{method:"GET",errorHandler:!0}})}]).factory("DataAccessRequestsResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessRequestsResource"),{},{save:{method:"POST",errorHandler:!0},get:{method:"GET"}})}]).factory("DataAccessRequestsExportCsvResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessRequestsExportCsvResource"),{},{get:{method:"GET"}})}]).factory("DataAccessRequestResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessRequestResource"),{},{save:{method:"PUT",params:{id:"@id"},errorHandler:!0},editActionLogs:{method:"PUT",params:{id:"@id"},url:t.getUrl("DataAccessRequestActionLogsResource"),errorHandler:!0},get:{method:"GET"},delete:{method:"DELETE"}})}]).factory("DataAccessAmendmentsResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessAmendmentsResource"),{},{save:{method:"POST",params:{parentId:"@parentId"},errorHandler:!0},get:{method:"GET",params:{parentId:"@parentId"}},getLogHistory:{method:"GET",isArray:!0,url:t.getUrl("DataAccessAmendmentsLogHistoryResource")}})}]).factory("DataAccessAmendmentResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessAmendmentResource"),{},{save:{method:"PUT",params:{parentId:"@parentId",id:"@id"},errorHandler:!0},get:{method:"GET"},delete:{method:"DELETE"}})}]).factory("DataAccessRequestAttachmentsUpdateResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessRequestAttachmentsUpdateResource"),{},{save:{method:"PUT",params:{id:"@id"},errorHandler:!0}})}]).factory("DataAccessRequestCommentsResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessRequestCommentsResource"),{},{save:{method:"POST",params:{id:"@id",admin:"@admin"},headers:{"Content-Type":"text/plain"},errorHandler:!0},get:{method:"GET",params:{id:"@id",admin:"@admin"},errorHandler:!0}})}]).factory("DataAccessRequestCommentResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessRequestCommentResource"),{},{delete:{method:"DELETE",params:{id:"@id",commentId:"@commentId"},errorHandler:!0},update:{method:"PUT",params:{id:"@id",commentId:"@commentId"},headers:{"Content-Type":"text/plain"},errorHandler:!0}})}]).factory("DataAccessRequestStatusResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessRequestStatusResource"),{},{update:{method:"PUT",params:{id:"@id",status:"@status"},errorHandler:!0}})}]).factory("DataAccessAmendmentStatusResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DataAccessAmendmentStatusResource"),{},{update:{method:"PUT",params:{id:"@id",parentId:"@parentId",status:"@status"},errorHandler:!0}})}]).service("DataAccessRequestConfig",function(){var r={newRequestButtonCaption:null,documentsSectionTitle:null,documentsSectionHelpText:null,downloadButtonCaption:null,commentsEnabled:!0,userListPageTitle:null,newRequestButtonHelpText:null};this.setOptions=function(t){"object"==typeof t&&Object.keys(t).forEach(function(e){e in r&&(r[e]=t[e])})},this.getOptions=function(){return angular.copy(r)}}).service("DataAccessRequestDirtyStateService",[function(){var t=null;this.setForm=function(e){t=e},this.isDirty=function(){return t&&t.$dirty}}]).filter("filterProfileAttributes",function(){return function(e){var t=["email","firstName","lastName","createdDate","lastLogin","username"];return e.filter(function(e){return-1===t.indexOf(e.key)})}}).filter("capitalizeFirstLetter",["StringUtils",function(t){return function(e){return t.capitaliseFirstLetter(e)}}]),ngObibaMica.sets=angular.module("obiba.mica.sets",["obiba.alert","ui.bootstrap","pascalprecht.translate","templates-ngObibaMica","LocalStorageModule"]),ngObibaMica.sets.config(["$provide",function(e){e.provider("ngObibaMicaSetsTemplateUrl",(new NgObibaMicaTemplateUrlFactory).create({cart:{header:null,footer:null}}))}]),ngObibaMica.sets.factory("SetResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetResource"),{},{get:{method:"GET",params:{type:"@type",id:"@id"},errorHandler:!0}})}]).factory("SetDocumentsResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetDocumentsResource"),{},{get:{method:"GET",params:{type:"@type",id:"@id",from:"@from",limit:"@limit"},errorHandler:!0}})}]).factory("SetClearResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetClearResource"),{},{clear:{method:"DELETE",params:{type:"@type",id:"@id"},errorHandler:!0}})}]).factory("SetExistsResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetExistsResource"),{},{get:{method:"GET",params:{type:"@type",id:"@id",did:"@did"},errorHandler:!0}})}]).factory("SetImportResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetImportResource"),{},{save:{method:"POST",params:{type:"@type",id:"@id"},headers:{"Content-Type":"text/plain"},errorHandler:!0}})}]).factory("SetImportQueryResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetImportQueryResource"),{},{save:{method:"POST",params:{type:"@type",id:"@id"},headers:{"Content-Type":"application/x-www-form-urlencoded"},errorHandler:!0,transformRequest:function(e){var t=[];for(var r in e)t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")}}})}]).factory("SetRemoveResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetRemoveResource"),{},{delete:{method:"POST",params:{type:"@type",id:"@id"},headers:{"Content-Type":"text/plain"},errorHandler:!0}})}]),ngObibaMica.sets.factory("SetsResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetsResource"),{},{save:{method:"POST",params:{type:"@type"},errorHandler:!0}})}]).factory("SetsImportResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("SetsImportResource"),{},{save:{method:"POST",params:{type:"@type"},headers:{"Content-Type":"text/plain"},errorHandler:!0}})}]);var SetService=function(){function e(e,t,r,a,n,i,s,o,c,l,u,d,h,m,p,f){this.$location=e,this.$window=t,this.$log=r,this.$translate=a,this.localStorageService=n,this.PageUrlService=i,this.AlertService=s,this.SetsImportResource=o,this.SetResource=c,this.SetDocumentsResource=l,this.SetClearResource=u,this.SetExistsResource=d,this.SetImportResource=h,this.SetImportQueryResource=m,this.SetRemoveResource=p,this.ObibaServerConfigResource=f;var g=this;f.get(function(e){g.hasMultipleStudies=!e.isSingleStudyEnabled||e.isHarmonizedDatasetEnabled,g.hasHarmonization=e.isHarmonizedDatasetEnabled})}return e.prototype.isSingleStudy=function(){return!this.hasMultipleStudies},e.prototype.hasHarmonizedDatasets=function(){return this.hasHarmonization},e.prototype.getCartDocuments=function(t,r,a){var n=this;return this.getOrCreateCart(t).then(function(e){return n.SetDocumentsResource.get({from:r,id:e.id,limit:a,type:t}).$promise})},e.prototype.isDocumentInCart=function(t,r){var a=this;return this.getOrCreateCart(t).then(function(e){return a.SetExistsResource.get({type:t,id:e.id,did:r}).$promise})},e.prototype.addDocumentToCart=function(t,e){var r=this,a=Array.isArray(e)?e.join("\n"):e;return this.getOrCreateCart(t).then(function(e){return r.SetImportResource.save({type:t,id:e.id},a).$promise}).then(function(e){return r.saveCart(t,e)})},e.prototype.addDocumentQueryToCart=function(t,r){var a=this;return this.$log.info("query="+r),this.getOrCreateCart(t).then(function(e){return a.SetImportQueryResource.save({type:t,id:e.id,query:r}).$promise}).then(function(e){return a.saveCart(t,e)})},e.prototype.removeDocumentFromCart=function(t,e){var r=this,a=Array.isArray(e)?e.join("\n"):e;return this.getOrCreateCart(t).then(function(e){return r.SetRemoveResource.delete({type:t,id:e.id},a).$promise}).then(function(e){return r.saveCart(t,e)})},e.prototype.clearCart=function(t){var r=this;return this.getOrCreateCart(t).then(function(e){return r.SetClearResource.clear({type:t,id:e.id}).$promise}).then(function(){return r.notifyCartChanged(t),r.getOrCreateCart(t)})},e.prototype.gotoSetEntitiesCount=function(e,t){var r=this,a=e;if(!a){var n=this.getCartSet("variables");n&&(a=n.id)}if(t){var i=Array.isArray(t)?t:[t];this.gotoEntitiesCount(i.slice(0,20))}else this.SetDocumentsResource.get({type:"variables",id:a,from:0,limit:20}).$promise.then(function(e){r.gotoEntitiesCount(e.variables.map(function(e){return e.id}))})},e.prototype.gotoEntitiesCount=function(e){if(e){var t=e.map(function(e){return"all("+e+")"}).join(",");this.$window.location.href=this.PageUrlService.entitiesCountPage(t)}},e.prototype.getDownloadUrl=function(e,t){var r=t;if(!r){var a=this.getCartSet(e);a&&(r=a.id)}if(r){var n="variable(in(Mica_variable.sets,"+r+"),limit(0,20000),fields((attributes.label.*,variableType,datasetId,datasetAcronym)),sort(variableType,containerId,populationWeight,dataCollectionEventWeight,datasetId,index,name)),locale("+this.$translate.use()+")";return this.PageUrlService.downloadList(e,n)}return null},e.prototype.gotoSearch=function(e,t){var r=t;if(!r){var a=this.getCartSet(e);a&&(r=a.id)}if(r){var n="variable(in(Mica_variable.sets,"+r+"))";this.$window.location.href=this.PageUrlService.searchPage(n)}},e.prototype.getCartSet=function(e){return this.localStorageService.get(this.getCartKey(e))},e.prototype.getOrCreateCart=function(t){var r=this,e=this.localStorageService.get(this.getCartKey(t));return e?this.SetResource.get({type:t,id:e.id}).$promise.then(function(e){return r.saveCart(t,e)}).catch(function(){return r.createCart(t,"")}):this.createCart(t,"")},e.prototype.createCart=function(t,e){var r=this;return this.SetsImportResource.save({type:t},e).$promise.then(function(e){return r.saveCart(t,e)})},e.prototype.saveCart=function(e,t){if(t&&t.id)return this.localStorageService.set(this.getCartKey(e),t),this.notifyCartChanged(e),t},e.prototype.getCartKey=function(e){return"cart."+e},e.prototype.notifyCartChanged=function(t){var r;try{r=new CustomEvent("cart-updated",{detail:t})}catch(e){(r=document.createEvent("Event")).initEvent("cart-updated",!0,!0),r.detail=t}document.dispatchEvent(r)},e.$inject=["$location","$window","$log","$translate","localStorageService","PageUrlService","AlertService","SetsImportResource","SetResource","SetDocumentsResource","SetClearResource","SetExistsResource","SetImportResource","SetImportQueryResource","SetRemoveResource","ObibaServerConfigResource"],e}();ngObibaMica.sets.service("SetService",["$location","$window","$log","$translate","localStorageService","PageUrlService","AlertService","SetsImportResource","SetResource","SetDocumentsResource","SetClearResource","SetExistsResource","SetImportResource","SetImportQueryResource","SetRemoveResource","ObibaServerConfigResource",SetService]);var CartDocumentsTableController=function(){function e(e,t,r,a,n,i,s,o,c){this.PageUrlService=e,this.LocalizedValues=t,this.SetService=r,this.AnalysisConfigService=a,this.$translate=n,this.$log=i,this.$scope=s,this.$location=o,this.$window=c,this.allSelected=!1,this.allPageSelected={},this.selections={},this.documents={from:0,limit:0,total:0},this.pagination={currentPage:1,from:0,itemsPerPage:10,maxSize:10,to:0,totalHits:0}}return e.prototype.hasSelections=function(){return this.allSelected||0<this.getSelectedDocumentIds().length},e.prototype.updateAllSelected=function(){this.$log.info("ALL="+this.allSelected),this.allSelected=!this.allSelected,this.allSelected?(this.allPageSelected[this.pagination.currentPage]=!0,this.updateAllCurrentPageSelected()):(this.allPageSelected={},this.selections={})},e.prototype.updateAllCurrentPageSelected=function(){var t=this;this.$log.info("ALLPAGE="+JSON.stringify(this.allPageSelected)),this.allSelected&&!this.allPageSelected[this.pagination.currentPage]?(this.allSelected=!1,this.allPageSelected={},this.selections={}):this.documents&&this.documents[this.type]&&this.documents[this.type].forEach(function(e){t.selections[e.id]=t.allPageSelected[t.pagination.currentPage]})},e.prototype.updateSelection=function(e){this.selections[e]||(this.allPageSelected[this.pagination.currentPage]=!1,this.allSelected=!1)},e.prototype.showAnalysis=function(){return this.AnalysisConfigService.showAnalysis()},e.prototype.showStudies=function(){return!this.SetService.isSingleStudy()},e.prototype.showVariableType=function(){return this.SetService.hasHarmonizedDatasets()},e.prototype.entitiesCount=function(){if(this.pagination.totalHits){var e=this.getSelectedDocumentIds();this.SetService.gotoSetEntitiesCount(void 0,e&&0<e.length?e:void 0)}},e.prototype.download=function(){return this.SetService.getDownloadUrl(this.type)},e.prototype.search=function(){this.SetService.gotoSearch(this.type)},e.prototype.clearSet=function(){var e=this;if(this.hasSelections()){var t=this.getSelectedDocumentIds();t&&0<t.length?this.SetService.removeDocumentFromCart(this.type,t).then(function(){e.allSelected=!1,e.allPageSelected={},e.selections={},e.$scope.$emit("cart-cleared",e.type)}):this.SetService.clearCart(this.type).then(function(){e.allSelected=!1,e.allPageSelected={},e.selections={},e.$scope.$emit("cart-cleared",e.type)})}},e.prototype.pageChanged=function(){var e=(this.pagination.currentPage-1)*this.documents.limit;this.onPageChange(this.type,e)},e.prototype.$onInit=function(){this.table={rows:new Array}},e.prototype.$onChanges=function(){this.table=this.asTable(),this.localizedTotal=this.LocalizedValues.formatNumber(this.documents&&this.documents.total?this.documents.total:0)},e.prototype.getSelectedDocumentIds=function(){var t=this;return this.allSelected?[]:Object.keys(this.selections).filter(function(e){return t.selections[e]})},e.prototype.localize=function(e){return this.LocalizedValues.forLang(e,this.$translate.use())},e.prototype.asTable=function(){var u=this,d={rows:new Array};this.pagination.totalHits=this.documents?this.documents.total:0,this.pagination.currentPage=this.documents?this.documents.from/this.documents.limit+1:0,this.pagination.itemsPerPage=this.documents?this.documents.limit:0,this.pagination.from=this.documents?this.documents.from+1:0;var e=this.documents&&this.documents[this.type]?this.documents[this.type].length:0;return this.pagination.to=this.documents?this.documents.from+e:0,e&&(this.allSelected&&(this.allPageSelected[this.pagination.currentPage]=!0),this.documents[this.type].forEach(function(e){u.allSelected&&(u.selections[e.id]=!0);var t=u.localize(e.studySummary.acronym),r=(u.localize(e.studySummary.name),"Dataschema"===e.variableType?"harmonization":"individual"),a=u.PageUrlService.studyPage(e.studyId,r),n=u.localize(e.datasetName),i=u.PageUrlService.datasetPage(e.datasetId,e.variableType),s=u.PageUrlService.variablePage(e.id),o=e.attributes.filter(function(e){return"label"===e.name}),c=o&&0<o.length?u.localize(o[0].values):"",l=new Array({link:void 0,value:e.id},{link:s||i,value:e.name},{link:void 0,value:c},{link:void 0,value:e.variableType},{link:a,value:t},{link:i,value:n});d.rows.push(l)})),d},e.$inject=["PageUrlService","LocalizedValues","SetService","AnalysisConfigService","$translate","$log","$scope","$location","$window"],e}(),CartDocumentsTableComponent=function(){this.transclude=!0,this.bindings={documents:"<",onPageChange:"<",type:"<"},this.controller=CartDocumentsTableController,this.controllerAs="$ctrl",this.templateUrl="sets/components/cart-documents-table/component.html"};ngObibaMica.sets.component("cartDocumentsTable",new CartDocumentsTableComponent),ngObibaMica.sets.controller("CartController",["$scope","$location","$translate","$cookies","SetService","ngObibaMicaSetsTemplateUrl",function(r,e,t,a,n,i){var s,o,c;r.options={},s=r,o=a,c="micaHideCartHelpText",t(["sets.cart.help"]).then(function(e){s.options.CartHelpText||o.get(c)||(s.options.CartHelpText=e["sets.cart.help"])}),s.closeHelpBox=function(){o.put(c,!0),s.options.CartHelpText=null},o.get(c)&&(s.options.CartHelpText=null),r.cartHeaderTemplateUrl=i.getHeaderUrl("cart"),r.loading=!0;var l=function(e){r.loading=!1,r.variables=e},u=n.getCartDocuments("variables",0,100);u?u.then(l):r.variables={total:0},r.$on("cart-cleared",function(e,t){r.loading=!0,n.getCartDocuments(t,0,100).then(l)}),r.onPaginate=function(e,t){n.getCartDocuments(e,t,100).then(l)}}]).controller("VariableToCartController",["$scope","SetService","AlertService",function(n,t,i){n.canBeAdded=!1,n.canBeRemoved=!1,n.loading=!0,n.onInit=function(e){t.isDocumentInCart("variables",e).then(function(){n.loading=!1,n.canBeRemoved=!0}).catch(function(){n.loading=!1,n.canBeAdded=!0})},n.onAdd=function(e){n.loading=!0;var a=t.getCartSet("variables");t.addDocumentToCart("variables",e).then(function(e){n.loading=!1;var t=e.count-(a?a.count:0),r=0===t?"sets.cart.no-variable-added":"sets.cart.variable-added";n.canBeRemoved=0<t,n.canBeAdded=!n.canBeRemoved,i.growl({id:"VariableToCartControllerGrowl",type:"info",msgKey:r,msgArgs:[],delay:3e3})}).catch(function(){n.loading=!1})},n.onRemove=function(e){n.loading=!0;var a=t.getCartSet("variables");t.removeDocumentFromCart("variables",e).then(function(e){n.loading=!1;var t=(a?a.count:0)-e.count,r=0<t?"sets.cart.variable-removed":"sets.cart.no-variable-removed";n.canBeAdded=0<t,n.canBeRemoved=!n.canBeAdded,i.growl({id:"VariableToCartControllerGrowl",type:"info",msgKey:r,msgArgs:[],delay:3e3})}).catch(function(){n.loading=!1})}}]),ngObibaMica.sets.config(["$routeProvider",function(e){e.when("/cart",{templateUrl:"sets/views/cart.html",controller:"CartController",reloadOnSearch:!1})}]);var DISPLAY_TYPES={LIST:"list",COVERAGE:"coverage",GRAPHICS:"graphics"};function CriteriaBuilder(t,r,a,n,i,s){this.newCriteriaItemBuilder=function(){return new CriteriaItemBuilder(n,i,s)},this.initialize=function(e){this.leafItemMap={},this.target=e,this.rootRql=t,this.taxonomies=a,this.LocalizedValues=n,this.lang=i,this.SetService=s,this.rootItem=this.newCriteriaItemBuilder().parent(r).type(this.target).rqlQuery(this.rootRql).target(this.target).build()},this.buildLeafItem=function(e,t,r,a,n){var i=new CriteriaItemBuilder(this.LocalizedValues,this.lang,this.SetService).type(a.name).target(this.target).taxonomy(e).vocabulary(t).rqlQuery(a).parent(n);return i.selectedTerms(r).build(),i.build()}}function CriteriaIdGenerator(){}function CriteriaItemBuilder(e,t,i){var r={type:null,rqlQuery:null,lang:t||"en",parent:null,children:[]},a=this;function n(e,t){var r=i.getCartSet(t);if(r){var a;if(e.vocabulary.terms){var n=e.vocabulary.terms.filter(function(e){return"cart"===e.name});0<n.length&&(a=n[0])}a||(a={title:[{locale:"en",text:"Cart"},{locale:"fr",text:"Panier"}]}),a.name=r.id,e.vocabulary.terms=[a]}else e.vocabulary.terms=[]}this.type=function(e){if(!RQL_NODE[e.toUpperCase()])throw new Error("Invalid node type:",e);return r.type=e,this},this.target=function(e){return r.target=e,this},this.parent=function(e){return r.parent=e,this},this.taxonomy=function(e){return r.taxonomy=e,this},this.vocabulary=function(e){if(r.vocabulary=e,"sets"===r.vocabulary.name)switch(r.taxonomy.name){case"Mica_variable":n(r,"variables");break;case"Mica_dataset":n(r,"datasets");break;case"Mica_study":n(r,"studies");break;case"Mica_network":n(r,"networks")}return this},this.term=function(e){return Array.isArray(e)?a.selectedTerms(e):(r.term=e,this)},this.rqlQuery=function(e){return r.rqlQuery=e,this},this.selectedTerm=function(e){return r.selectedTerms||(r.selectedTerms=[]),r.selectedTerms.push("string"==typeof e||"number"==typeof e?e:e.name),this},this.selectedTerms=function(e){return r.selectedTerms=e.filter(function(e){return e}).map(function(e){return"string"==typeof e||"number"==typeof e?e:e.name}),this},this.build=function(){return r.taxonomy&&r.vocabulary&&(r.term?(r.itemTitle=e.forLocale(r.term.title,r.lang),r.itemDescription=e.forLocale(r.term.description,r.lang),r.itemParentTitle=e.forLocale(r.vocabulary.title,r.lang),r.itemParentDescription=e.forLocale(r.vocabulary.description,r.lang),r.itemTitle||(r.itemTitle=r.term.name),r.itemParentTitle||(r.itemParentTitle=r.vocabulary.name)):(r.itemTitle=e.forLocale(r.vocabulary.title,r.lang),r.itemDescription=e.forLocale(r.vocabulary.description,r.lang),r.itemParentTitle=e.forLocale(r.taxonomy.title,r.lang),r.itemParentDescription=e.forLocale(r.taxonomy.description,r.lang),r.itemTitle||(r.itemTitle=r.vocabulary.name),r.itemParentTitle||(r.itemParentTitle=r.taxonomy.name)),r.id=CriteriaIdGenerator.generate(r.taxonomy,r.vocabulary,r.term)),new CriteriaItem(r)}}function CriteriaItem(t){var r=this;Object.keys(t).forEach(function(e){r[e]=t[e]})}function RepeatableCriteriaItem(){CriteriaItem.call(this,{}),this.list=[]}ngObibaMica.search=angular.module("obiba.mica.search",["obiba.alert","ui.bootstrap","pascalprecht.translate","ngclipboard","templates-ngObibaMica","obiba.mica.sets"]),ngObibaMica.search.run(["GraphicChartsConfigurations",function(e){e.setClientConfig()}]),function(){var a=["name","title","description","keywords"];function t(){var r={searchLayout:"layout2",taxonomyPanelOptions:{network:{taxonomies:{Mica_network:{trKey:"properties"}}},study:{taxonomies:{Mica_study:{trKey:"properties"}}},dataset:{taxonomies:{Mica_dataset:{trKey:"properties"}}},variable:{taxonomies:{Mica_variable:{trKey:"properties"}}},fieldsToFilter:a},obibaListOptions:{countCaption:!0,searchForm:!0,supplInfoDetails:!0,trimmedDescription:!0},targetTabsOrder:[QUERY_TARGETS.VARIABLE,QUERY_TARGETS.DATASET,QUERY_TARGETS.STUDY,QUERY_TARGETS.NETWORK],searchTabsOrder:[DISPLAY_TYPES.LIST,DISPLAY_TYPES.COVERAGE,DISPLAY_TYPES.GRAPHICS],resultTabsOrder:[QUERY_TARGETS.VARIABLE,QUERY_TARGETS.DATASET,QUERY_TARGETS.STUDY,QUERY_TARGETS.NETWORK],showAllFacetedTaxonomies:!0,showFacetTermsWithZeroCount:!1,showSearchBox:!0,showSearchBrowser:!0,showSearchRefreshButton:!1,variableTaxonomiesOrder:[],studyTaxonomiesOrder:[],datasetTaxonomiesOrder:[],networkTaxonomiesOrder:[],hideNavigate:[],hideSearch:["studyId","dceId","datasetId","networkId"],variables:{showSearchTab:!0,listPageSize:20,variablesColumn:{showVariablesTypeColumn:!0,showVariablesStudiesColumn:!0,showVariablesDatasetsColumn:!0,showDatasetsStudiesColumn:!0,showDatasetsVariablesColumn:!0},showCart:!0},datasets:{showSearchTab:!0,listPageSize:20,showDatasetsSearchFilter:!0,datasetsColumn:{showDatasetsAcronymColumn:!0,showDatasetsTypeColumn:!0,showDatasetsNetworkColumn:!0,showDatasetsStudiesColumn:!0,showDatasetsVariablesColumn:!0},fields:["acronym.*","name.*","variableType","studyTable.studyId","studyTable.project","studyTable.table","studyTable.populationId","studyTable.dataCollectionEventId","harmonizationTable.studyId","harmonizationTable.project","harmonizationTable.table","harmonizationTable.populationId"]},studies:{showSearchTab:!0,listPageSize:20,showStudiesSearchFilter:!0,studiesColumn:{showStudiesTypeColumn:!0,showStudiesDesignColumn:!0,showStudiesQuestionnaireColumn:!0,showStudiesPmColumn:!0,showStudiesBioColumn:!0,showStudiesOtherColumn:!0,showStudiesParticipantsColumn:!0,showStudiesNetworksColumn:!0,showStudiesStudyDatasetsColumn:!0,showStudiesHarmonizationDatasetsColumn:!0,showStudiesVariablesColumn:!1,showStudiesStudyVariablesColumn:!0,showStudiesDataschemaVariablesColumn:!0},fields:["acronym.*","name.*","model.methods.design","populations.dataCollectionEvents.model.dataSources","model.numberOfParticipants.participant"]},networks:{showSearchTab:!0,listPageSize:20,networksColumn:{showNetworksStudiesColumn:!0,showNetworksStudyDatasetColumn:!0,showNetworksHarmonizationDatasetColumn:!0,showNetworksVariablesColumn:!1,showNetworksStudyVariablesColumn:!0,showNetworksDataschemaVariablesColumn:!0},fields:["acronym.*","name.*","studyIds"]},coverage:{groupBy:{study:!0,dce:!0,dataset:!0}}};this.setOptions=function(e){var t;(r=angular.merge(r,e)).targetTabsOrder=e.targetTabsOrder||r.targetTabsOrder,r.searchTabsOrder=e.searchTabsOrder||r.searchTabsOrder,r.resultTabsOrder=e.resultTabsOrder||r.resultTabsOrder,r.variableTaxonomiesOrder=e.variableTaxonomiesOrder||r.variableTaxonomiesOrder,r.studyTaxonomiesOrder=e.studyTaxonomiesOrder||r.studyTaxonomiesOrder,r.datasetTaxonomiesOrder=e.datasetTaxonomiesOrder||r.datasetTaxonomiesOrder,r.networkTaxonomiesOrder=e.networkTaxonomiesOrder||r.networkTaxonomiesOrder,r.hideNavigate=e.hideNavigate||r.hideNavigate,r.hideSearch=e.hideSearch||r.hideSearch,r.studies.fields=e.studies&&e.studies.fields||r.studies.fields,r.networks.fields=e.networks&&e.networks.fields||r.networks.fields,r.datasets.fields=e.datasets&&e.datasets.fields||r.datasets.fields,e.taxonomyPanelOptions&&(r.taxonomyPanelOptions.fieldsToFilter=((t=e.taxonomyPanelOptions.fieldsToFilter)?t.filter(function(e){return-1<a.indexOf(e)}):null)||r.taxonomyPanelOptions.fieldsToFilter),e.studies&&e.studies.obibaListOptions&&(r.obibaListOptions.countCaption=0!==e.studies.obibaListOptions.studiesCountCaption||e.studies.obibaListOptions.studiesCountCaption,r.obibaListOptions.searchForm=0!==e.studies.obibaListOptions.studiesSearchForm||e.studies.obibaListOptions.studiesSearchForm,r.obibaListOptions.supplInfoDetails=0!==e.studies.obibaListOptions.studiesSupplInfoDetails||e.studies.obibaListOptions.studiesSupplInfoDetails,r.obibaListOptions.trimmedDescription=0!==e.studies.obibaListOptions.studiesTrimmedDescription||e.studies.obibaListOptions.studiesTrimmedDescription,r.searchLayout=e.searchLayout?e.searchLayout:r.searchLayout),function(){function e(e,t){var r=e.indexOf(t);return-1<r&&e.splice(r,1),e}r.coverage.groupBy.dce=r.coverage.groupBy.study&&r.coverage.groupBy.dce,0<Object.keys(r.coverage.groupBy).filter(function(e){return r.coverage.groupBy[e]}).length||e(r.searchTabsOrder,DISPLAY_TYPES.COVERAGE),r.networks.showSearchTab||(e(r.targetTabsOrder,QUERY_TARGETS.NETWORK),e(r.resultTabsOrder,QUERY_TARGETS.NETWORK)),r.studies.showSearchTab||(e(r.searchTabsOrder,DISPLAY_TYPES.GRAPHICS),e(r.targetTabsOrder,QUERY_TARGETS.STUDY),e(r.resultTabsOrder,QUERY_TARGETS.STUDY))}()},this.getOptions=function(){return angular.copy(r)}}function n(e,s,o,t){var c=e.defer(),l=!1;return{getOptionsAsyn:function(){return i=o.getOptions(),l?e.when(o.getOptions()):(t.get(function(e){var t=e.isNetworkEnabled&&!e.isSingleNetworkEnabled,r=!e.isSingleStudyEnabled||e.isHarmonizedDatasetEnabled,a=e.isCollectedDatasetEnabled||e.isHarmonizedDatasetEnabled,n={searchLayout:e.searchLayout,locale:e.languages||s.use(),showSearchRefreshButton:!0,networks:{showSearchTab:t},studies:{showSearchTab:r,studiesColumn:{showStudiesTypeColumn:e.isCollectedDatasetEnabled&&e.isHarmonizedDatasetEnabled,showStudiesNetworksColumn:t&&i.studies.studiesColumn.showStudiesNetworksColumn,showStudiesVariablesColumn:a&&i.studies.studiesColumn.showStudiesVariablesColumn,showStudiesStudyDatasetsColumn:!1!==(a&&e.isCollectedDatasetEnabled)&&i.studies.studiesColumn.showStudiesStudyDatasetsColumn,showStudiesStudyVariablesColumn:!1!==(a&&e.isCollectedDatasetEnabled)&&i.studies.studiesColumn.showStudiesStudyVariablesColumn,showStudiesHarmonizationDatasetsColumn:!1!==(a&&e.isHarmonizedDatasetEnabled)&&i.studies.studiesColumn.showStudiesHarmonizationDatasetsColumn,showStudiesDataschemaVariablesColumn:!1!==(a&&e.isHarmonizedDatasetEnabled)&&i.studies.studiesColumn.showStudiesDataschemaVariablesColumn}},datasets:{showSearchTab:a,datasetsColumn:{showDatasetsTypeColumn:e.isCollectedDatasetEnabled&&e.isHarmonizedDatasetEnabled,showDatasetsNetworkColumn:t&&i.datasets.datasetsColumn.showDatasetsNetworkColumn,showDatasetsStudiesColumn:r&&i.datasets.datasetsColumn.showDatasetsStudiesColumn,showDatasetsVariablesColumn:i.datasets.datasetsColumn.showDatasetsVariablesColumn}},variables:{showSearchTab:a,variablesColumn:{showVariablesTypeColumn:e.isCollectedDatasetEnabled&&e.isHarmonizedDatasetEnabled,showVariablesStudiesColumn:r}}};o.setOptions(n),c.resolve(o.getOptions()),l=!0}),c.promise);var i},getOptions:function(){return o.getOptions()},getDefaultListPageSize:function(e){var t=o.getOptions();switch(e){case QUERY_TARGETS.VARIABLE:return t.variables.listPageSize;case QUERY_TARGETS.DATASET:return t.datasets.listPageSize;case QUERY_TARGETS.STUDY:return t.studies.listPageSize;case QUERY_TARGETS.NETWORK:return t.networks.listPageSize}return 20}}}ngObibaMica.search.config(["$provide",function(e){e.provider("ngObibaMicaSearch",function(){var a=new t;this.initialize=function(e){a.setOptions(e)},this.$get=["$q","$translate","ObibaServerConfigResource",function(e,t,r){return new n(e,t,a,r)}]})}])}(),ngObibaMica.search.config(["$provide",function(e){e.provider("ngObibaMicaSearchTemplateUrl",(new NgObibaMicaTemplateUrlFactory).create({search:{header:null,footer:null},searchStudiesResultTable:{template:null},searchNetworksResultTable:{template:null},searchDatasetsResultTable:{template:null},searchCriteriaRegionTemplate:{template:null},vocabularyFilterDetailHeading:{template:null},CriterionDropdownTemplate:{template:null},searchResultList:{template:null},searchInputList:{template:null},searchResultCoverage:{template:null},searchResultGraphics:{template:null},classifications:{header:null,footer:null},searchCellStatValue:{template:null}}))}]),ngObibaMica.search.service("SearchControllerFacetHelperService",["MetaTaxonomyService","ngObibaMicaSearch",function(e,t){var i,s,r,a,o=e.getMetaTaxonomiesPromise(),n=t.getOptions();function c(){return o.then(function(e){a=!(r={}),e.vocabularies.reduce(function(e,t){var r=function r(e,t){return t.reduce(function(e,t){return Array.isArray(t.terms)?r(e,t.terms):(e.push(t),e)},e||[])}([],t.terms);return n.showAllFacetedTaxonomies?e[t.name]=r.filter(function(e){return e.attributes&&e.attributes.some(function(e){return"showFacetedNavigation"===e.key&&"true"===e.value.toString()})}):e[t.name]=(n[t.name+"TaxonomiesOrder"]||[]).map(function(t){return r.filter(function(e){return e.name===t})[0]}).filter(function(e){return null!=e}),a=a||e[t.name].length,e},r)})}function l(){return i}function u(){return r}function d(){return s}function h(){return a}this.help=function(e,t){return Promise.all([c(),(r=e,n=t,o.then(function(t){i=[],s=[],r.forEach(function(a){var e=t.vocabularies.filter(function(e){if(e.name===a)return s.push(a),!0}).pop();e&&e.terms&&e.terms.forEach(function(e){e.target=a;var t=e.title.filter(function(e){return e.locale===n})[0],r=e.description?e.description.filter(function(e){return e.locale===n})[0]:void 0;e.locale={title:t,description:r},e.terms&&e.terms.forEach(function(e){var t=e.title.filter(function(e){return e.locale===n})[0],r=e.description?e.description.filter(function(e){return e.locale===n})[0]:void 0;e.locale={title:t,description:r}}),i.push(e)})})}))]).then(function(){return{getTaxonomyNav:l,getFacetedTaxonomies:u,getTabOrderTodisplay:d,getHasFacetedTaxonomies:h}});var r,n}}]),CriteriaBuilder.prototype.fieldToVocabulary=function(e){var t={taxonomy:null,vocabulary:null},r=e;e.indexOf(".")<0&&(r="Mica_"+this.target+"."+e);var a=r.split(".",2),n=a[0],i=a[1],s=this.taxonomies.filter(function(e){return n===e.name});if(0===s.length)throw new Error("Could not find taxonomy:",n);t.taxonomy=s[0];var o=t.taxonomy.vocabularies.filter(function(e){return i===e.name});if(0===o.length)throw new Error("Could not find vocabulary:",i);return t.vocabulary=o[0],t},CriteriaBuilder.prototype.visitLeaf=function(e,t){var r=RQL_NODE.MATCH===e.name,a=e.args[r?1:0],n=e.args[r?0:1],i=this.fieldToVocabulary(a),s=this.buildLeafItem(i.taxonomy,i.vocabulary,n instanceof Array?n:[n],e,t),o=this.leafItemMap[s.id];o?o.isRepeatable()?o.addItem(s):(console.error("Non-repeatable criteria items must be unique,",o.id,"will be overwritten."),o=s):o=s.vocabulary.repeatable?(new RepeatableCriteriaItem).addItem(s):s,this.leafItemMap[s.id]=o,t.children.push(s)},CriteriaBuilder.prototype.getRootItem=function(){return this.rootItem},CriteriaBuilder.prototype.getLeafItemMap=function(){return this.leafItemMap},CriteriaBuilder.prototype.visitCondition=function(e,t){var r=this.newCriteriaItemBuilder().parent(t).rqlQuery(e).type(e.name).build();t.children.push(r),this.visit(e.args[0],r),this.visit(e.args[1],r)},CriteriaBuilder.prototype.visitNot=function(e,t){var r=this.newCriteriaItemBuilder().parent(t).rqlQuery(e).type(e.name).build();t.children.push(r),this.visit(e.args[0],r)},CriteriaBuilder.prototype.visit=function(e,t){switch(e.name){case RQL_NODE.NOT:this.visitNot(e,t);break;case RQL_NODE.AND:case RQL_NODE.NAND:case RQL_NODE.OR:case RQL_NODE.NOR:this.visitCondition(e,t);break;case RQL_NODE.CONTAINS:case RQL_NODE.IN:case RQL_NODE.OUT:case RQL_NODE.EQ:case RQL_NODE.LE:case RQL_NODE.LT:case RQL_NODE.GE:case RQL_NODE.GT:case RQL_NODE.BETWEEN:case RQL_NODE.EXISTS:case RQL_NODE.MISSING:case RQL_NODE.MATCH:this.visitLeaf(e,t);break;case RQL_NODE.FILTER:}},CriteriaBuilder.prototype.build=function(){var t=this;this.rootRql.args.forEach(function(e){t.visit(e,t.rootItem)})},CriteriaIdGenerator.generate=function(e,t,r){return e&&t?e.name+"."+t.name+(r?"."+r.name:""):void 0},CriteriaItem.prototype.isRepeatable=function(){return!1},CriteriaItem.prototype.getTarget=function(){return this.target||null},CriteriaItem.prototype.getRangeTerms=function(){var e={from:null,to:null};return this.type===RQL_NODE.BETWEEN?(e.from=this.selectedTerms[0],e.to=this.selectedTerms[1]):this.type===RQL_NODE.GE?(e.from=this.selectedTerms[0],e.to=null):this.type===RQL_NODE.LE&&(e.from=null,e.to=this.selectedTerms[0]),e},function(){function o(){}o.reduce=function(e,t){if(e.type===RQL_NODE.OR){var r=e.parent,a=r.children.indexOf(e);r.children[a]=t;var n=e.rqlQuery,i=r.rqlQuery,s=i.args.indexOf(n);i.args[s]=t.rqlQuery,r.type!==QUERY_TARGETS.VARIABLE&&o.reduce(r,t)}else t.type!==RQL_NODE.VARIABLE&&e.type===RQL_NODE.AND&&o.reduce(e.parent,e)},ngObibaMica.search.CriteriaReducer=o}(),RepeatableCriteriaItem.prototype=Object.create(CriteriaItem.prototype),RepeatableCriteriaItem.prototype.isRepeatable=function(){return!0},RepeatableCriteriaItem.prototype.addItem=function(e){return this.list.push(e),this},RepeatableCriteriaItem.prototype.items=function(){return this.list},RepeatableCriteriaItem.prototype.first=function(){return this.list[0]},RepeatableCriteriaItem.prototype.getTarget=function(){return 0<this.list.length?this.list[0].getTarget():null},function(){var r=[{label:"10",value:10},{label:"20",value:20},{label:"50",value:50},{label:"100",value:100}];ngObibaMica.search.PaginationState=function(e,t){this.target=e,this.initialPageSize=t,this.currentPage=1,this.from=0,this.to=0,this.selected=this.findPageSize(t),this.totalHits=null,this.pageCount=0,this.maxSize=3},ngObibaMica.search.PaginationState.prototype.updateRange=function(){var e=this.selected.value,t=this.currentPage;this.from=e*(t-1)+1,this.to=Math.min(this.totalHits,e*t)},ngObibaMica.search.PaginationState.prototype.initializeCurrentPage=function(e){e&&e.hasOwnProperty("from")?(this.selected=this.findPageSize(e.size),this.currentPage=1+e.from/this.selected.value):(this.selected=this.findPageSize(this.initialPageSize),this.currentPage=1)},ngObibaMica.search.PaginationState.prototype.update=function(e,t){this.totalHits=t||null,this.initializeCurrentPage(e),this.updateRange(),this.updatePageCount(),this.updateMaxSize()},ngObibaMica.search.PaginationState.prototype.findPageSize=function(t){var e=r.filter(function(e){return e.value===t}).pop();return e||r[0]},ngObibaMica.search.PaginationState.prototype.totalHitsChanged=function(e){return null!==this.totalHits&&this.totalHits!==e},ngObibaMica.search.PaginationState.prototype.updatePageCount=function(){this.pageCount=Math.ceil(this.totalHits/this.selected.value)},ngObibaMica.search.PaginationState.prototype.updateMaxSize=function(){this.maxSize=Math.min(3,this.pageCount)},ngObibaMica.search.PaginationState.prototype.data=function(){return{target:this.target,initialPageSize:this.initialPageSize,currentPage:this.currentPage,from:this.from,to:this.to,selected:this.selected,totalHits:this.totalHits,maxSize:this.maxSize,pageCount:this.pageCount,pageSizes:r}}}(),function(){function i(e){var t=0;if(e.attributes){var r=e.attributes.filter(function(e){return"weight"===e.key})[0];t=r&&parseInt(r.value)||0}return t}ngObibaMica.search.MetaTaxonomyParser=function(e){this.config=e,this.parseTerms=function(n,e){return e.map(function(e,t){var r={state:new ngObibaMica.search.PanelTaxonomyState(t+""),info:{name:e.name||"",title:e.title||"",description:e.description||"",weight:i(e)},taxonomies:[e]},a=n.taxonomies[e.name];return a&&a.hasOwnProperty("trKey")&&(r.info.trKey=a.trKey),r})},this.createResultObject=function(e,t){return{name:e.name,title:e.title,taxonomies:t}},this.sortTaxonomies=function(e){e.sort(function(e,t){return e.info.weight-t.info.weight})}},ngObibaMica.search.MetaTaxonomyParser.prototype.parseEntityTaxonomies=function(e){return this.createResultObject(e,this.parseTerms(this.config[e.name],e.terms||[]))},ngObibaMica.search.MetaTaxonomyParser.prototype.parseVariableTaxonomies=function(e){var t=e.terms.filter(function(e){return-1<["Variable_chars","Scales"].indexOf(e.name)}).reduce(function(e,t){return e[(new obiba.utils.NgObibaStringUtils).camelize(t.name)]=t,e},{}),r=this.parseTerms(this.config[QUERY_TARGETS.VARIABLE],t.variableChars.terms),a=t.scales;return a&&a.terms&&r.push({state:new ngObibaMica.search.PanelTaxonomyState,info:{name:a.name,names:a.terms.map(function(e){return e.name}),title:a.title,description:a.description||"",weight:i(a)},taxonomies:a.terms}),this.sortTaxonomies(r),this.createResultObject(e,r)}}(),ngObibaMica.search.PanelTaxonomyState=function(e){var t={NONE:0,ACTIVE:1,LOADING:2};this.id=e,this.STATES=t,this.state=t.NONE},ngObibaMica.search.PanelTaxonomyState.prototype.isLoading=function(){return this.STATES.LOADING===(this.state&this.STATES.LOADING)},ngObibaMica.search.PanelTaxonomyState.prototype.isActive=function(){return this.STATES.ACTIVE===(this.state&this.STATES.ACTIVE)},ngObibaMica.search.PanelTaxonomyState.prototype.active=function(){this.state=this.state|this.STATES.ACTIVE},ngObibaMica.search.PanelTaxonomyState.prototype.inactive=function(){this.state=this.state&~this.STATES.ACTIVE},ngObibaMica.search.PanelTaxonomyState.prototype.loading=function(){this.state=this.state|this.STATES.LOADING},ngObibaMica.search.PanelTaxonomyState.prototype.loaded=function(){this.state=this.state&~this.STATES.LOADING},ngObibaMica.search.PanelTaxonomyState.prototype.none=function(){this.state=this.STATES.NONE},ngObibaMica.search.factory("DocumentSuggestionResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DocumentSuggestion"),{},{query:{method:"GET",errorHandler:!0,isArray:!0}})}]),ngObibaMica.search.factory("JoinQueryCoverageResource",["$resource","ngObibaMicaUrl",function(e,t){var r=t.getUrl("JoinQueryCoverageResource"),a=-1===r.indexOf(":query")?"POST":"GET";return e(r,{},{get:{method:a,headers:{"Content-Type":"POST"===a?"application/x-www-form-urlencoded":"application/json"},transformRequest:function(e){var t=[];for(var r in e)t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")},errorHandler:!0}})}]),ngObibaMica.search.factory("JoinQuerySearchResource",["$resource","ngObibaMicaUrl",function(e,t){var r=t.getUrl("JoinQuerySearchResource"),a=function(e){var t=-1===r.indexOf(":query")?"POST":"GET";return{method:t,headers:{"Content-Type":"POST"===t?"application/x-www-form-urlencoded":"application/json"},errorHandler:!0,params:{type:e},transformRequest:function(e){var t=[];for(var r in e)t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")}}};return e(r,{},{variables:a("variables"),studies:a("studies"),networks:a("networks"),datasets:a("datasets")})}]),ngObibaMica.search.factory("TaxonomiesResource",["$resource","ngObibaMicaUrl","$cacheFactory",function(e,t,r){return e(t.getUrl("TaxonomiesResource"),{},{get:{method:"GET",isArray:!0,errorHandler:!0,cache:r("taxonomiesResource")}})}]),ngObibaMica.search.factory("TaxonomiesSearchResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("TaxonomiesSearchResource"),{},{get:{method:"GET",isArray:!0,errorHandler:!0}})}]),ngObibaMica.search.factory("TaxonomyResource",["$resource","ngObibaMicaUrl","$cacheFactory",function(e,t,r){return e(t.getUrl("TaxonomyResource"),{},{get:{method:"GET",errorHandler:!0,cache:r("taxonomyResource")}})}]),ngObibaMica.search.factory("VocabularyResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("VocabularyResource"),{},{get:{method:"GET",errorHandler:!0}})}]),ngObibaMica.search.controller("SearchController",["$timeout","$scope","$rootScope","$location","$translate","$filter","$cookies","ngObibaMicaSearchTemplateUrl","ObibaServerConfigResource","JoinQuerySearchResource","JoinQueryCoverageResource","AlertService","ServerErrorUtils","LocalizedValues","RqlQueryService","RqlQueryUtils","SearchContext","CoverageGroupByService","VocabularyService","EntitySuggestionRqlUtilityService","SearchControllerFacetHelperService","options","PaginationService",function(n,u,e,o,r,c,t,a,i,s,l,d,h,m,p,f,g,y,b,v,S,T,E){var O,R,C,D;u.options=T,O=u,R=t,C="micaHideSearchHelpText",D="micaHideClassificationHelpBox",r(["search.help","search.coverage-help"]).then(function(e){O.options.SearchHelpText||R.get(C)||(O.options.SearchHelpText=e["search.help"]),O.options.ClassificationHelpText||R.get(D)||(O.options.ClassificationHelpText=e["classifications.help"])}),O.closeHelpBox=function(){R.put(C,!0),O.options.SearchHelpText=null},O.closeClassificationHelpBox=function(){R.put(D,!0),O.options.ClassificationHelpText=null},R.get(C)&&(O.options.SearchHelpText=null),R.get(D)&&(O.options.ClassificationHelpText=null),u.taxonomyTypeMap={variable:"variables",study:"studies",network:"networks",dataset:"datasets"},r(["search.classifications-title","search.classifications-link","search.faceted-navigation-help"]).then(function(e){u.hasClassificationsTitle=e["search.classifications-title"],u.hasClassificationsLinkLabel=e["search.classifications-link"],u.hasFacetedNavigationHelp=e["search.faceted-navigation-help"]});var A={variable:u.options.variables.showSearchTab,dataset:u.options.datasets.showSearchTab,study:u.options.studies.showSearchTab,network:u.options.networks.showSearchTab},w=Object.keys(u.taxonomyTypeMap).reduce(function(e,t){return e[u.taxonomyTypeMap[t]]=t,e},{});function I(e){u.search.result={},u.search.loading=!1,d.alert({id:"SearchController",type:"danger",msg:h.buildMessage(e),delay:5e3})}function N(){return"layout2"===u.search.layout||u.search.query}function U(e){if(!e||!QUERY_TYPES[e.toUpperCase()])throw new Error("Invalid type: "+e)}function q(e){if(e&&(!BUCKET_TYPES[e.replace("-","_").toUpperCase()]||!y.canGroupBy(e)))throw new Error("Invalid bucket "+e)}function L(e){if(!e||!DISPLAY_TYPES[e.toUpperCase()])throw new Error("Invalid display: "+e)}function Q(){try{var e=o.search(),t=-1<u.resultTabsOrder.indexOf(w[e.type])?e.type:u.taxonomyTypeMap[u.resultTabsOrder[0]],r=e.bucket&&y.canGroupBy(e.bucket)?e.bucket:y.defaultBucket(),a=-1<u.searchTabsOrder.indexOf(e.display)?e.display:u.searchTabsOrder[0]||DISPLAY_TYPES.LIST,n=e.query||"";return U(t),q(r),L(a),u.search.type=t,u.search.bucket=r,u.search.display=a,u.search.query=n,u.search.rqlQuery=p.parseQuery(n),u.search.layout=(i=e.layout?e.layout:(s=u.options).listLayout?s.listLayout:s.searchLayout?s.searchLayout:"layout2")&&-1<["layout1","layout2"].indexOf(i)?i:"layout2",!0}catch(e){d.alert({id:"SearchController",type:"danger",msg:e.message,delay:5e3})}var i,s;return!1}function x(){if("/search"===o.path()){var e,t,r=p.prepareSearchQueryAndSerialize(u.search.display,u.search.type,u.search.rqlQuery,u.lang,(e=p.getTargetQuerySort(u.search.type,u.search.rqlQuery),(t=e&&e.args?e.args:null)||(t=u.search.type===QUERY_TYPES.VARIABLES?SORT_FIELDS.NAME:SORT_FIELDS.ACRONYM,u.search.type===QUERY_TYPES.VARIABLES?t=[SORT_FIELDS.VARIABLE_TYPE,SORT_FIELDS.CONTAINER_ID,SORT_FIELDS.POPULATION_WEIGHT,SORT_FIELDS.DATA_COLLECTION_EVENT_WEIGHT,SORT_FIELDS.DATASET_ID,SORT_FIELDS.INDEX,SORT_FIELDS.NAME]:u.search.type===QUERY_TYPES.DATASETS&&(t=[SORT_FIELDS.STUDY_TABLE.STUDY_ID,SORT_FIELDS.STUDY_TABLE.POPULATION_WEIGHT,SORT_FIELDS.STUDY_TABLE.DATA_COLLECTION_EVENT_WEIGHT,SORT_FIELDS.ACRONYM])),t));switch(u.search.display){case DISPLAY_TYPES.LIST:u.search.loading=!0,u.search.executedQuery=r,s[u.search.type]({query:r},function(e){u.search.result.list=e,u.search.loading=!1,u.search.countResult=a(e),n(function(){var e=p.getQueryPaginations(u.search.rqlQuery);E.update(e,u.search.countResult)})},I);break;case DISPLAY_TYPES.COVERAGE:0<Object.keys(u.search.criteriaItemMap).map(function(e){return u.search.criteriaItemMap[e]}).filter(function(e){return QUERY_TARGETS.VARIABLE===e.getTarget()&&"Mica_variable"!==e.taxonomy.name}).length?(u.search.loading=!0,u.search.executedQuery=p.prepareCoverageQuery(r,u.search.bucket),l.get({query:u.search.executedQuery},function(e){u.search.result.coverage=e,u.search.loading=!1,u.search.countResult=e.totalCounts},I)):u.search.result={};break;case DISPLAY_TYPES.GRAPHICS:u.search.loading=!0,u.search.executedQuery=p.prepareGraphicsQuery(r,["Mica_study.populations-selectionCriteria-countriesIso","Mica_study.populations-dataCollectionEvents-bioSamples","Mica_study.numberOfParticipants-participant-number"],["Mica_study.methods-design"]),s.studies({query:u.search.executedQuery},function(e){u.search.result.graphics=e,u.search.loading=!1,u.search.countResult=a(e)},I)}}function a(e){return{studyTotalCount:{total:e.studyResultDto.totalCount,hits:e.studyResultDto.totalHits},datasetTotalCount:{total:e.datasetResultDto.totalCount,hits:e.datasetResultDto.totalHits},variableTotalCount:{total:e.variableResultDto.totalCount,hits:e.variableResultDto.totalHits},networkTotalCount:{total:e.networkResultDto.totalCount,hits:e.networkResultDto.totalHits}}}}function M(){Q()&&p.createCriteria(u.search.rqlQuery,u.lang).then(function(e){var r,t;u.search.criteria=e.root,u.search.criteria&&u.search.criteria.children&&u.search.criteria.children.sort(function(e,t){return"network"===e.target||"variable"===t.target?-1:"variable"===e.target||"network"===t.target?1:e.target<t.target?1:e.target>t.target?-1:0}),u.search.criteriaItemMap=e.map,N()&&x(),u.search.selectedTarget&&u.search.selectedTaxonomy&&(r=u.search.selectedTarget,t=u.search.selectedTaxonomy,Array.isArray(t)?t.forEach(function(t){t.vocabularies.forEach(function(e){e.existingItem=p.findCriteriaItemFromTreeById(r,CriteriaIdGenerator.generate(t,e),u.search.criteria,!0)})}):t.vocabularies.forEach(function(e){e.existingItem=p.findCriteriaItemFromTreeById(r,CriteriaIdGenerator.generate(t,e),u.search.criteria,!0)})),u.$broadcast("ngObibaMicaQueryUpdated",u.search.criteria)})}function P(e,t,r){r.__defineSetter__("existingItem",function(t){t?(b.isNumericVocabulary(r)&&(r.rangeTerms=t.getRangeTerms()),b.isMatchVocabulary(r)&&(r.matchString=t.selectedTerms.join("")),r.wholeVocabularyIsSelected=-1<["exists","match"].indexOf(t.type),(r.terms||[]).forEach(function(e){e.selected="exists"===t.type||-1<t.selectedTerms.indexOf(e.name)})):(r.rangeTerms={},r.matchString=null,r.wholeVocabularyIsSelected=!1,(r.terms||[]).forEach(function(e){e.selected=!1})),r._existingItem=t}),r.__defineGetter__("existingItem",function(){return r._existingItem}),r.existingItem=p.findCriteriaItemFromTreeById(e,CriteriaIdGenerator.generate(t,r),u.search.criteria,!0)}u.targets=[],u.lang=r.use(),e.$on("$translateChangeSuccess",function(e,t){t.language!==g.currentLocale()&&(u.lang=r.use(),g.setLocale(u.lang),M())});var _=function(){var e=(new RqlQuery).serializeArgs(u.search.rqlQuery.args),t=o.search();""===e?delete t.query:t.query=e,o.search(t)},$=function(e){p.removeCriteriaItem(e),_()},V=function(e,t,r,a,n){if(angular.isUndefined(a)&&(a=!0),e.id){var i,s=CriteriaIdGenerator.generate(e.taxonomy,e.vocabulary),o=p.findCriteriaItemFromTree(e,u.search.criteria);o&&-1!==s.indexOf("dceId")&&n?($(o),i="search.criterion.updated",p.addCriteriaItem(u.search.rqlQuery,e,t)):o?(i="search.criterion.updated",p.updateCriteriaItem(o,e,r)):(i="search.criterion.created",p.addCriteriaItem(u.search.rqlQuery,e,t)),a&&d.growl({id:"SearchControllerGrowl",type:"info",msgKey:i,msgArgs:[m.forLocale(e.vocabulary.title,u.lang),c("translate")("taxonomy.target."+e.target)],delay:3e3}),_()}},F=function(e){if(e){U(e);var t=o.search();t.type=e,t.display=DISPLAY_TYPES.LIST,o.search(t)}},k=function(e){if(e){L(e);var t=o.search();t.display=e,o.search(t)}},B="search",H="classification",G=new Map([[QUERY_TARGETS.NETWORK,["acronym","name"]],[QUERY_TARGETS.STUDY,["acronym","name"]],[QUERY_TARGETS.DATASET,["acronym","name"]],[QUERY_TARGETS.VARIABLE,["name","label"]]]);function z(e,t,r){var a,n=u.search.rqlQuery,i=p.findTargetQuery(e,n);i||(i=new RqlQuery(e),n.push(i)),r&&(a=G.get(e));var s=v.createMatchQuery(t,a);if(s){var o=v.givenTargetQueryGetFilterQuery(i);if(o){var c=v.givenFilterQueryGetMatchQuery(o);c?c.args=s.args:o.push(s)}else i.push(new RqlQuery(RQL_NODE.FILTER).push(s))}else v.removeFilteredMatchQueryFromTargetQuery(i);_()}u.searchSuggestion=z,u.goToSearch=function(){u.viewMode=B,o.search("taxonomy",null),o.search("vocabulary",null),o.search("target",null),o.path("/search")},u.goToClassifications=function(){u.viewMode=H,o.path("/classifications"),o.search("target",u.targetTabsOrder[0])},u.navigateToTarget=function(e){o.search("target",e),o.search("taxonomy",null),o.search("vocabulary",null),u.target=e},u.QUERY_TYPES=QUERY_TYPES,u.BUCKET_TYPES=BUCKET_TYPES,u.search={layout:"layout2",query:null,advanced:!1,rqlQuery:new RqlQuery,executedQuery:null,type:null,bucket:null,result:{list:null,coverage:null,graphics:null},criteria:[],criteriaItemMap:{},loading:!1},u.viewMode=B,u.searchHeaderTemplateUrl=a.getHeaderUrl("search"),u.classificationsHeaderTemplateUrl=a.getHeaderUrl("classifications"),u.onTaxonomyFilterPanelToggleVisibility=function(r,t){r&&t&&(Array.isArray(t)?t.forEach(function(t){t.vocabularies.forEach(function(e){P(r,t,e)})}):t.vocabularies.forEach(function(e){P(r,t,e)})),u.search.selectedTarget=r,u.search.selectedTaxonomy=t,u.search.showTaxonomyPanel=null!==t,u.search.showTaxonomyPanel||x()},u.selectDisplay=k,u.selectCriteria=V,u.removeCriteriaItem=$,u.refreshQuery=_,u.clearSearchQuery=function(){var e=o.search();delete e.query,o.search(e)},u.toggleSearchQuery=function(){u.search.advanced=!u.search.advanced},u.showAdvanced=function(){for(var e=u.search.criteria.children||[],t=e.length;t--;)for(var r=e[t].children||[],a=r.length;a--;)if(r[a].type===RQL_NODE.OR||r[a].type===RQL_NODE.AND)return!0},u.onTypeChanged=F,u.onBucketChanged=function(e){if(e){q(e);var t=o.search();t.bucket=e,o.search(t)}},u.onDisplayChanged=k,u.onUpdateCriteria=function(e,t,r,a,n,i){if(t&&F(t),a){var s=p.findCriteriaItemFromTree(e,u.search.criteria);s&&ngObibaMica.search.CriteriaReducer.reduce(s.parent,s)}k(r&&u.search.display?u.search.display:DISPLAY_TYPES.LIST),V(e,RQL_NODE.AND,!0,n,i)},u.onRemoveCriteria=function(e){var t=p.findCriterion(u.search.criteria,e.id);$(t)},u.onSelectTerm=function(e,t,r,a){if((a=a||{}).text&&(a.text=a.text.replace(/[^a-zA-Z0-9" _-]/g,"")),angular.isString(a)&&(a={term:a}),r){var n;if(b.isNumericVocabulary(r))return(n=p.createCriteriaItem(e,t,r,null,u.lang)).rqlQuery=f.buildRqlQuery(n),f.updateRangeQuery(n.rqlQuery,a.from,a.to),void V(n,null,!0);if(b.isMatchVocabulary(r))return(n=p.createCriteriaItem(e,t,r,null,u.lang)).rqlQuery=f.buildRqlQuery(n),f.updateMatchQuery(n.rqlQuery,a.text),void V(n,null,!0)}if("layout1"===T.searchLayout)V(p.createCriteriaItem(e,t,r,a&&a.term,u.lang));else{var i=r.terms.filter(function(e){return e.selected}).map(function(e){return e.name}),s=p.findCriterion(u.search.criteria,CriteriaIdGenerator.generate(t,r));if(s&&a.term){if(s.rqlQuery.name=RQL_NODE.IN,a.term.selected)s.rqlQuery=f.mergeInQueryArgValues(s.rqlQuery,[a.term.name]);else{var o=s.rqlQuery.args[1]||[];s.type===RQL_NODE.EXISTS&&(o=s.vocabulary.terms.map(function(e){return e.name}));var c=o.indexOf(a.term.name);o=Array.isArray(o)?o:[o],-1<c?(o.splice(c,1),0===o.length&&(s.rqlQuery.name=RQL_NODE.EXISTS)):o.push(a.term.name),s.rqlQuery=f.mergeInQueryArgValues(s.rqlQuery,o)}1<r.terms.length&&i.length===r.terms.length&&(s.rqlQuery.name=RQL_NODE.EXISTS,s.rqlQuery.args.pop()),u.refreshQuery()}else{var l=1<r.terms.length&&i.length===r.terms.length;V(p.createCriteriaItem(e,t,r,!l&&a&&a.term,u.lang))}}},u.QUERY_TARGETS=QUERY_TARGETS,u.onPaginate=function(e,t,r,a){var n,i;u.search.rqlQuery=u.search.rqlQuery||new f(RQL_NODE.AND),p.prepareQueryPagination(u.search.rqlQuery,e,t,r),a?(n=(new RqlQuery).serializeArgs(u.search.rqlQuery.args),i=o.search(),""===n?delete i.query:i.query=n,o.search(i).replace()):_()},u.canExecuteWithEmptyQuery=N,u.inSearchMode=function(){return u.viewMode===B},u.toggleFullscreen=function(){u.isFullscreen=!u.isFullscreen},u.isSearchAvailable=!0,i.get(function(e){u.isSearchAvailable=!e.isSingleStudyEnabled||e.isNetworkEnabled&&!e.isSingleNetworkEnabled||e.isCollectedDatasetEnabled||e.isHarmonizedDatasetEnabled}),u.unbindLocationChange=u.$on("$locationChangeSuccess",function(e,t,r){if(t!==r)try{q(o.search().bucket),M()}catch(e){var a=y.defaultBucket();o.search("bucket",a).replace()}}),e.$on("ngObibaMicaSearch.fullscreenChange",function(e,t){u.isFullscreen=t}),e.$on("ngObibaMicaSearch.sortChange",function(e,t){u.search.rqlQuery=p.prepareSearchQueryNoFields(u.search.display,u.search.type,u.search.rqlQuery,u.lang,t),_()}),e.$on("ngObibaMicaSearch.searchSuggestion",function(e,t,r,a){z(r,t,a)}),u.taxonomyNav=[],u.lang=r.use(),g.setLocale(u.lang),function(){function e(e){var t=o.search()[e];return t&&t.split(",").filter(function(e){return e}).map(function(e){return e.trim()})}var t=e("targetTabsOrder");u.targetTabsOrder=(t||u.options.targetTabsOrder).filter(function(e){return A[e]});var r=e("searchTabsOrder");u.searchTabsOrder=r||u.options.searchTabsOrder;var a=e("resultTabsOrder");u.resultTabsOrder=(a||u.options.resultTabsOrder).filter(function(e){return A[e]}),o.search().target?u.target=o.search().target:u.target||(u.target=u.targetTabsOrder[0])}(),S.help(u.targetTabsOrder,u.lang).then(function(e){u.facetedTaxonomies=e.getFacetedTaxonomies(),u.hasFacetedTaxonomies=e.getHasFacetedTaxonomies(),u.targetTabsOrder=e.getTabOrderTodisplay(),u.taxonomyNav=e.getTaxonomyNav()}),M()}]).controller("ResultTabsOrderCountController",[function(){}]),ngObibaMica.search.config(["$routeProvider",function(e){var t=["ngObibaMicaSearch",function(e){return e.getOptionsAsyn()}];e.when("/search",{templateUrl:"search/views/search-layout.html",controller:"SearchController",reloadOnSearch:!1,resolve:{options:t}}).when("/classifications",{templateUrl:"search/views/classifications.html",controller:"SearchController",reloadOnSearch:!1,resolve:{options:t}})}]);var CoverageGroupByService=function(){function e(e){this.options=e.getOptions(),this.groupByOptions=this.options.coverage.groupBy}return e.prototype.isSingleStudy=function(){return!this.options.studies.showSearchTab},e.prototype.canShowStudyType=function(){return this.options.studies.studiesColumn.showStudiesTypeColumn},e.prototype.canShowStudy=function(){return this.groupByOptions.study||this.groupByOptions.dce},e.prototype.canShowDce=function(e){return(-1<e.indexOf("study")||-1<e.indexOf("dce"))&&this.groupByOptions.study&&this.groupByOptions.dce},e.prototype.canShowDataset=function(){return this.groupByOptions.dataset},e.prototype.canShowVariableTypeFilter=function(e){var t=(-1<e.indexOf("study")||-1<e.indexOf("dce"))&&this.groupByOptions.study,r=-1<e.indexOf("dataset")&&this.groupByOptions.dataset;return t||r},e.prototype.studyTitle=function(){return"search.coverage-buckets.study"},e.prototype.studyBucket=function(){return BUCKET_TYPES.STUDY},e.prototype.dceBucket=function(){return this.groupByOptions.study&&this.groupByOptions.dce?BUCKET_TYPES.DCE:this.studyBucket()},e.prototype.datasetTitle=function(){return"search.coverage-buckets.dataset"},e.prototype.datasetBucket=function(){return BUCKET_TYPES.DATASET},e.prototype.canGroupBy=function(e){var t=!1;switch(e){case BUCKET_TYPES.STUDY:case BUCKET_TYPES.STUDY_INDIVIDUAL:case BUCKET_TYPES.STUDY_HARMONIZATION:t=this.groupByOptions.study;break;case BUCKET_TYPES.DCE:case BUCKET_TYPES.DCE_INDIVIDUAL:case BUCKET_TYPES.DCE_HARMONIZATION:t=this.groupByOptions.dce;break;case BUCKET_TYPES.DATASET:case BUCKET_TYPES.DATASET_COLLECTED:case BUCKET_TYPES.DATASCHEMA:case BUCKET_TYPES.DATASET_HARMONIZED:t=this.groupByOptions.dataset}return t},e.prototype.defaultBucket=function(){return this.groupByOptions.study?this.options.studies.showSearchTab?this.studyBucket():this.dceBucket():this.groupByOptions.dataset?this.datasetBucket():""},e}();ngObibaMica.search.service("CoverageGroupByService",["ngObibaMicaSearch",CoverageGroupByService]),ngObibaMica.search.factory("CriteriaNodeCompileService",["$templateCache","$compile",function(n,i){return{compile:function(e,t,r){var a="";a=e.item.type===RQL_NODE.OR||e.item.type===RQL_NODE.AND||e.item.type===RQL_NODE.NAND||e.item.type===RQL_NODE.NOR?angular.element(n.get(r)):angular.element('<criterion-dropdown criterion="item" query="query"></criterion-dropdown>'),e.item.rqlQuery.args&&i(a)(e,function(e){t.replaceWith(e)})}}}]),ngObibaMica.search.service("EntitySuggestionRqlUtilityService",function(){function r(e){return e?e.args.filter(function(e){return e.name===RQL_NODE.FILTER}).pop():null}this.createMatchQuery=function(e,t){var r,a,n=null,i=e.trim();return i.length&&((n=new RqlQuery(RQL_NODE.MATCH)).args=(r=t,(a=[]).push([i]),Array.isArray(r)?a.push(r):r&&a.push([r]),a)),n},this.givenTargetQueryGetFilterQuery=r,this.givenFilterQueryGetMatchQuery=function(e){return e?e.args.filter(function(e){return e.name===RQL_NODE.MATCH}).pop():null},this.removeFilteredMatchQueryFromTargetQuery=function(e){var t=r(e);t&&(1===t.args.length&&t.args[0].name===RQL_NODE.MATCH?e.args=e.args.filter(function(e){return e.name!==RQL_NODE.FILTER}):t.args=t.args.filter(function(e){return e.name!==RQL_NODE.MATCH}))}}),ngObibaMica.search.service("EntitySuggestionService",["$rootScope","$location","$translate","DocumentSuggestionResource","RqlQueryService","EntitySuggestionRqlUtilityService","AlertService","ServerErrorUtils",function(i,s,n,o,c,l,u,d){function h(e,t){var a=new obiba.utils.NgObibaStringUtils,r=a.cleanDoubleQuotesLeftUnclosed(t);return r=a.cleanOrEscapeSpecialLuceneBrackets(r),r=a.cleanSpecialLuceneCharacters(r),e&&t&&1<r.length?o.query({locale:n.use(),documentType:e,query:r}).$promise.then(function(e){for(var t=Array.isArray(e)?e:[],r=0;r<t.length;r++)t[r]=a.quoteQuery(t[r].replace(/\/.*/,""));return t},function(e){u.alert({id:"SearchController",type:"danger",msg:d.buildMessage(e),delay:5e3})}):[]}this.getCurrentSuggestion=function(e,t){if(t){var r=c.findTargetQuery(e,t);if(r){var a=l.givenFilterQueryGetMatchQuery(l.givenTargetQueryGetFilterQuery(r));return a&&a.args?Array.isArray(a.args[0])&&1===a.args[0].length?a.args[0][0]:Array.isArray(a.args[0])&&1<a.args[0].length?a.args[0].join(","):a.args[0].length?a.args[0][0]:"":""}}return""},this.suggest=h,this.selectSuggestion=function(e,t,r){var a=new obiba.utils.NgObibaStringUtils,n=a.cleanDoubleQuotesLeftUnclosed(t);n=a.cleanOrEscapeSpecialLuceneBrackets(n),n=a.cleanSpecialLuceneCharacters(n),i.$new().$emit("ngObibaMicaSearch.searchSuggestion",n,e,r)},this.suggestForTargetQuery=function(e,t){var r=c.parseQuery(s.search().query),a=c.findTargetQuery(typeToTarget(e),r),n=c.findQueryInTargetByVocabulary(a,"className");return n&&(t="className:"+n.args[1]+" AND ("+t.replace(/\/.*/,"")+")"),h(e,t)}}]),ngObibaMica.search.factory("FullScreenService",["$document","$window","$rootScope",function(e,t,r){var a=e[0],n=void 0!==t.Element&&"ALLOW_KEYBOARD_INPUT"in t.Element&&t.Element.ALLOW_KEYBOARD_INPUT,i=r.$new(),s={$on:angular.bind(i,i.$on),enable:function(e){e.requestFullScreen?e.requestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?/Version\/[\d]{1,2}(\.[\d]{1,2}){1}(\.(\d){1,2}){0,1} Safari/.test(t.navigator.userAgent)?e.webkitRequestFullscreen():e.webkitRequestFullscreen(n):e.msRequestFullscreen&&e.msRequestFullscreen()},cancel:function(){a.cancelFullScreen?a.cancelFullScreen():a.mozCancelFullScreen?a.mozCancelFullScreen():a.webkitExitFullscreen?a.webkitExitFullscreen():a.msExitFullscreen&&a.msExitFullscreen()},isEnabled:function(){return!!(a.fullscreenElement||a.mozFullScreenElement||a.webkitFullscreenElement||a.msFullscreenElement)}};return e.on("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",function(){i.$emit("ngObibaMicaSearch.fullscreenChange",s.isEnabled())}),s}]),ngObibaMica.search.service("MetaTaxonomyService",["$q","$translate","TaxonomyResource","ngObibaMicaSearch",function(e,t,r,a){var n=a.getOptions().taxonomyPanelOptions,i=new ngObibaMica.search.MetaTaxonomyParser(n);function s(){return r.get({target:QUERY_TARGETS.TAXONOMY,taxonomy:"Mica_taxonomy"}).$promise}this.getTaxonomyPanelOptions=function(){return n},this.getMetaTaxonomyForTargets=function(r){var a=e.defer();return s().then(function(e){var t=(e.vocabularies||[]).filter(function(e){return-1<r.indexOf(e.name)}).map(function(e){switch(e.name){case QUERY_TARGETS.VARIABLE:return i.parseVariableTaxonomies(e);case QUERY_TARGETS.NETWORK:case QUERY_TARGETS.STUDY:case QUERY_TARGETS.DATASET:return i.parseEntityTaxonomies(e)}});t.sort(function(e,t){return r.indexOf(e.name)-r.indexOf(t.name)}),a.resolve(t||[])}),a.promise},this.getMetaTaxonomiesPromise=s}]),ngObibaMica.search.service("ObibaSearchConfig",function(){var r={networks:{showSearchTab:1},studies:{showSearchTab:1},datasets:{showSearchTab:1},variables:{showSearchTab:1}};this.setOptions=function(t){"object"==typeof t&&Object.keys(t).forEach(function(e){e in r&&(r[e]=t[e])})},this.getOptions=function(){return angular.copy(r)}}),ngObibaMica.search.service("PageUrlService",["ngObibaMicaUrl","StringUtils","urlEncode",function(n,i,s){return this.studyPage=function(e,t){var r=(-1<t.toLowerCase().indexOf("individual")?"individual":"harmonization")+"-study";return e?i.replaceAll(n.getUrl("StudyPage"),{":type":s(r),":study":s(e)}):""},this.studyPopulationPage=function(e,t,r){var a=("individual"===t.toLowerCase()?"individual":"harmonization")+"-study";return e?i.replaceAll(n.getUrl("StudyPopulationsPage"),{":type":s(a),":study":s(e),":population":s(r)}):""},this.networkPage=function(e){return e?i.replaceAll(n.getUrl("NetworkPage"),{":network":s(e)}):""},this.datasetPage=function(e,t){var r=("collected"===t.toLowerCase()?"collected":"harmonized")+"-dataset";return e?i.replaceAll(n.getUrl("DatasetPage"),{":type":s(r),":dataset":s(e)}):""},this.variablePage=function(e){return e?i.replaceAll(n.getUrl("VariablePage"),{":variable":s(e)}):""},this.downloadList=function(e,t){return i.replaceAll(n.getUrl("JoinQuerySearchCsvResource"),{":type":e,":query":t})},this.downloadCoverage=function(e){return i.replaceAll(n.getUrl("JoinQueryCoverageDownloadResource"),{":query":e})},this.entitiesCountPage=function(e){var t=n.getUrl("BaseUrl")+n.getUrl("EntitiesCountBaseUrl");return e&&(t=t+"?query="+s(e)),t},this.searchPage=function(e){var t=n.getUrl("BaseUrl")+n.getUrl("SearchBaseUrl");return e&&(t=t+"?query="+s(e)),t},this}]),ngObibaMica.search.service("PaginationService",["ngObibaMicaSearch",function(a){var c={},l=Object.keys(QUERY_TARGETS).reduce(function(e,t){if(null===/TAXONOMY/.exec(t)){var r=QUERY_TARGETS[t];e[r]=new ngObibaMica.search.PaginationState(r,a.getDefaultListPageSize(r))}return e},{});this.registerListener=function(e,t){if(t){if(!t.onUpdate)throw new Error("PaginationService::registerListener() - listener must implement onUpdate()");c[e]=t}},this.update=function(e,t){var r,a=!1;for(r in l){var n=l[r],i=t[r+"TotalCount"].hits||0,s=e[r],o=n.totalHitsChanged(i);a=a||o,n.update(s,i)}for(r in l)c[r]&&c[r].onUpdate(l[r].data(),a)}}]);var QUERY_TYPES={NETWORKS:"networks",STUDIES:"studies",DATASETS:"datasets",VARIABLES:"variables"},QUERY_TARGETS={NETWORK:"network",STUDY:"study",DATASET:"dataset",VARIABLE:"variable",TAXONOMY:"taxonomy"},BUCKET_TYPES={NETWORK:"network",STUDY:"study",STUDY_INDIVIDUAL:"study-individual",STUDY_HARMONIZATION:"study-harmonization",DCE:"dce",DCE_INDIVIDUAL:"dce-individual",DCE_HARMONIZATION:"dce-harmonization",DATASET:"dataset",DATASET_COLLECTED:"dataset-collected",DATASET_HARMONIZED:"dataset-harmonized",DATASCHEMA:"dataschema"},RQL_NODE={VARIABLE:"variable",DATASET:"dataset",STUDY:"study",NETWORK:"network",LIMIT:"limit",SORT:"sort",AND:"and",NAND:"nand",OR:"or",NOR:"nor",NOT:"not",FACET:"facet",LOCALE:"locale",AGGREGATE:"aggregate",BUCKET:"bucket",FIELDS:"fields",FILTER:"filter",CONTAINS:"contains",IN:"in",OUT:"out",EQ:"eq",GT:"gt",GE:"ge",LT:"lt",LE:"le",BETWEEN:"between",MATCH:"match",EXISTS:"exists",MISSING:"missing"},SORT_FIELDS={ACRONYM:"acronym",NAME:"name",CONTAINER_ID:"containerId",POPULATION_WEIGHT:"populationWeight",DATA_COLLECTION_EVENT_WEIGHT:"dataCollectionEventWeight",POPULATION_ID:"populationId",DATASET_ID:"datasetId",VARIABLE_TYPE:"variableType",INDEX:"index",STUDY_TABLE:{POPULATION_WEIGHT:"studyTable.populationWeight",DATA_COLLECTION_EVENT_WEIGHT:"studyTable.dataCollectionEventWeight",STUDY_ID:"studyTable.studyId",POPULATION_ID:"studyTable.populationId"}};function targetToType(e){switch(e.toLocaleString()){case QUERY_TARGETS.NETWORK:return QUERY_TYPES.NETWORKS;case QUERY_TARGETS.STUDY:return QUERY_TYPES.STUDIES;case QUERY_TARGETS.DATASET:return QUERY_TYPES.DATASETS;case QUERY_TARGETS.VARIABLE:return QUERY_TYPES.VARIABLES}throw new Error("Invalid target: "+e)}function typeToTarget(e){switch(e.toLocaleString()){case QUERY_TYPES.NETWORKS:return QUERY_TARGETS.NETWORK;case QUERY_TYPES.STUDIES:return QUERY_TARGETS.STUDY;case QUERY_TYPES.DATASETS:return QUERY_TARGETS.DATASET;case QUERY_TYPES.VARIABLES:return QUERY_TARGETS.VARIABLE}throw new Error("Invalid type: "+e)}function BaseTaxonomiesController(e,i,t,s,r,a,n,o,c,l){i.options=n.getOptions(),i.RqlQueryUtils=o,i.metaTaxonomy=r.get({target:"taxonomy",taxonomy:"Mica_taxonomy"}),i.taxonomies={all:[],search:{text:null,active:!1},target:i.target||"variable",taxonomy:null,vocabulary:null},e.$on("$translateChangeSuccess",function(){i.taxonomies&&i.taxonomies.vocabulary&&l.sortVocabularyTerms(i.taxonomies.vocabulary,t.use())}),i.canNavigate=function(e){return!(-1<i.options.hideNavigate.indexOf(e.name))&&0===(e.attributes||[]).filter(function(e){return"showNavigate"===e.key}).length},this.navigateTaxonomy=function(e,t,r){if(i.taxonomies.term=r,i.isHistoryEnabled){var a=s.search();a.taxonomy=e?e.name:null,t&&a.vocabulary!==t.name?(l.sortVocabularyTerms(t,i.lang),a.vocabulary=t.name):a.vocabulary=null,s.search(a)}else i.taxonomies.taxonomy=e,i.taxonomies.vocabulary&&i.taxonomies.vocabulary.name===t.name||l.sortVocabularyTerms(t,i.lang),i.taxonomies.vocabulary=t},this.updateStateFromLocation=function(){var e=s.search(),t=e.taxonomy,r=e.vocabulary,a=null,n=null;i.taxonomies.all&&(i.taxonomies.all.forEach(function(e){e.name===t&&(a=e).vocabularies.forEach(function(e){e.name===r&&(n=e)})}),angular.equals(i.taxonomies.taxonomy,a)&&angular.equals(i.taxonomies.vocabulary,n)||(i.taxonomies.taxonomy=a,n&&l.sortVocabularyTerms(n,i.lang),i.taxonomies.vocabulary=n))},this.selectTerm=function(e,t,r,a){i.onSelectTerm(e,t,r,a)},this.clearCache=function(){var e=c.get("taxonomyResource");e&&e.removeAll()};var u=this;i.$on("$locationChangeSuccess",function(){i.isHistoryEnabled&&u.updateStateFromLocation()}),i.$watch("taxonomies.vocabulary",function(e){i.taxonomies.isMatchVocabulary=o&&e?(i.taxonomies.isNumericVocabulary=l.isNumericVocabulary(i.taxonomies.vocabulary),l.isMatchVocabulary(i.taxonomies.vocabulary)):i.taxonomies.isNumericVocabulary=null}),i.navigateTaxonomy=this.navigateTaxonomy,i.selectTerm=this.selectTerm,i.clearCache=this.clearCache}ngObibaMica.search.service("RqlQueryService",["$q","$log","TaxonomiesResource","TaxonomyResource","LocalizedValues","VocabularyService","RqlQueryUtils","ngObibaMicaSearch","SetService",function(c,t,a,s,u,d,h,m,o){var l={variable:null,dataset:null,study:null,network:null},p=this,f=m.getOptions();function g(t,e){return e.children.filter(function(e){return e.target===t}).pop()}function y(t,e){return e.args.filter(function(e){return e.name===t}).pop()}function r(e,t,r){if(!e)return null;var a={};return function t(r,a,n){return r.args.some(function(e){return null!==a.exec(e)?(n.parent=r,!0):e instanceof RqlQuery&&t(e,a,n)})}(e,new RegExp((t||"")+"\\."+r+"$"),a),a.parent}function n(e){switch(e){case RQL_NODE.AND:case RQL_NODE.NAND:case RQL_NODE.OR:case RQL_NODE.NOR:return!0}return!1}function i(e){switch(e){case RQL_NODE.CONTAINS:case RQL_NODE.IN:case RQL_NODE.OUT:case RQL_NODE.EQ:case RQL_NODE.GT:case RQL_NODE.GE:case RQL_NODE.LT:case RQL_NODE.LE:case RQL_NODE.BETWEEN:case RQL_NODE.MATCH:case RQL_NODE.EXISTS:case RQL_NODE.MISSING:return!0}return!1}function b(e){var t=e.parent,r=e.rqlQuery,a=r.args,n=e.parent.rqlQuery,i=n.args.indexOf(r),s=t.children.indexOf(e);if(-1===i||-1===s)throw new Error("Criteria node not found: "+e);t.children.splice(s,1),e.children.forEach(function(e){e.parent=t}),t.children.splice.apply(t.children,[s,0].concat(e.children)),n.args.splice(i,1),a&&(a instanceof Array?n.args.splice.apply(n.args,[i,0].concat(a)):n.args.splice(i,0,a)),null!==t.parent&&0===n.args.length&&b(t)}function v(e){var t=e.parent;if(!t)throw new Error("Cannot remove criteria when parent is NULL");var r=e.rqlQuery,a=e.parent.rqlQuery,n=a.args.indexOf(r);if(-1===n)throw new Error("Criteria node not found: "+e);a.args.splice(n,1),-1!==[RQL_NODE.OR,RQL_NODE.AND,RQL_NODE.NAND,RQL_NODE.NOR].indexOf(t.type)?function(e){var t=e.parent,r=e.rqlQuery,a=r.args,n=e.parent.rqlQuery,i=n.args.indexOf(r),s=t.children.indexOf(e);if(-1===i||-1===s)throw new Error("Criteria node not found: "+e);t.children.splice(s,1),e.children.forEach(function(e){e.parent=t}),t.children.splice.apply(t.children,[s,0].concat(e.children)),n.args.splice(i,1),a&&(a instanceof Array?n.args.splice.apply(n.args,[i,0].concat(a)):n.args.splice(i,0,a)),0===n.args.length&&b(t)}(t):0===a.args.length&&b(t)}function S(e){return(e||[]).filter(function(e){return function(e){if(e&&e.args){var t=e.args.filter(function(e){return i(e.name)||n(e.name)});return(1!==t.length||!h.isFreeTextMatch(t[0]))&&0<t.length}return!1}(e.rqlQuery)})}function T(e,t,r,a,n,i){var s=angular.copy(r),o=typeToTarget(t);h.addLocaleQuery(s,a);var c=y(o,s);if(c||(c=new RqlQuery(o),s.args.push(c)),h.getLimitQuery(c)||h.addLimit(c,h.limit(0,m.getDefaultListPageSize(o))),i){var l=function(e,t){switch(e){case DISPLAY_TYPES.LIST:switch(t){case QUERY_TARGETS.STUDY:return h.fields(f.studies.fields);case QUERY_TARGETS.VARIABLE:return h.fields(["attributes.label.*","variableType","datasetId","datasetAcronym"]);case QUERY_TARGETS.DATASET:return h.fields(f.datasets.fields);case QUERY_TARGETS.NETWORK:return h.fields(f.networks.fields)}}return null}(e,o);l&&h.addFields(c,l)}return n&&h.addSort(c,n),s}this.findItemNodeById=function(e,t,r,a){var n=t.split(".");return!!(e&&e.children&&r)&&e.children.some(function(e){return(a?t===e.id:e.id&&e.id.split(".").reduce(function(e,t){return e&&-1<n.indexOf(t)},!0))?(r.item=e,!0):p.findItemNodeById(e,t,r,a)})},this.findItemNode=function(e,t,r){return p.findItemNodeById(e,t.id,r)},this.getRenderableTargetCriteria=S,this.getRenderableTargetCriteriaFromRoot=function(e){return e?S(e.children):[]},this.parseQuery=function(e){try{return(new RqlParser).parse(e)}catch(e){t.error(e.message)}return new RqlQuery},this.removeCriteriaItem=function(e){i(e.type)?v(e):b(e)},this.createCriteriaItem=function(a,e,t,r,n){function i(e,t,r){return new CriteriaItemBuilder(u,n,o).target(a).taxonomy(e).vocabulary(t).term(r)}return angular.isString(e)?s.get({target:a,taxonomy:e}).$promise.then(function(e){return t=e.vocabularies.filter(function(e){return e.name===t||d.vocabularyAlias(e)===t})[0],r=t&&t.terms?t.terms.filter(function(e){return e.name===r})[0]:null,i(e,t,r).build()}):i(e,t,r).build()},this.addCriteriaItem=function(e,t,r){var a=e.args.filter(function(e){return t.target===e.name}).pop();a||(a=new RqlQuery(RQL_NODE[t.target.toUpperCase()]),e.args.push(a));var n=t.rqlQuery?t.rqlQuery:h.buildRqlQuery(t);return h.addQuery(a,n,r)},this.updateCriteriaItem=function(e,t,r){var a,n=e.isRepeatable(),i=!n&&e.rqlQuery.name===RQL_NODE.MATCH;function s(){(e=n?e.first():e).rqlQuery.name=RQL_NODE.EXISTS,e.rqlQuery.args.splice(1,1)}t.rqlQuery&&RQL_NODE.EXISTS===t.rqlQuery.name?s():(r&&t.rqlQuery&&(e.rqlQuery.name=t.rqlQuery.name),t.rqlQuery?a=t.rqlQuery.args[i?0:1]:t.term?a=[t.term.name]:s(),a&&(n?h.updateRepeatableQueryArgValues(e,a):h.updateQueryArgValues(e.rqlQuery,a,r)))},this.getTaxonomyByTarget=function(t){var r=c.defer(),e=l[t];return e?r.resolve(e):a.get({target:t}).$promise.then(function(e){l[t]=e,r.resolve(e)}),r.promise},this.builders=function(t,r,a,n){var i=c.defer();return p.getTaxonomyByTarget(t).then(function(){var e;(e=new CriteriaBuilder(r,a,l[t],u,n,o)).initialize(t),e.build(),i.resolve({root:e.getRootItem(),map:e.getLeafItemMap()})}),i.promise},this.createCriteria=function(e,t){var r=c.defer(),a=(new CriteriaItemBuilder).type(RQL_NODE.AND).rqlQuery(e).build(),n={};if(!h.hasTargetQuery(e))return r.resolve({root:a,map:n}),r.promise;var i=[],s=this,o=0;return e.args.forEach(function(e){QUERY_TARGETS[e.name.toUpperCase()]&&i.push(e)}),i.forEach(function(e){s.builders(e.name,e,a,t).then(function(e){a.children.push(e.root),n=angular.extend(n,e.map),++o===i.length&&r.resolve({root:a,map:n})})}),r.promise},this.prepareCriteriaTermsQuery=function(e,t,r){var a=this.parseQuery(e),n=a.args.filter(function(e){return e.name===t.target}).pop();if(n){var i=new RqlQuery(RQL_NODE.EXISTS),s=h.criteriaId(t.taxonomy,t.vocabulary);i.args.push(s),function e(t,r,a){if(!t||!t.args)return null;if((t.name===RQL_NODE.IN||t.name===RQL_NODE.MISSING||t.name===RQL_NODE.CONTAINS)&&t.args[0]===r)return t;for(var n=t.args.length;n--;)e(t.args[n],r,a)&&(t.args[n]=a)}(n,s,i),n.args.push(h.aggregate([s])),n.args.push(h.limit(0,0))}return a.args.push(new RqlQuery(RQL_NODE.FACET)),r&&h.addLocaleQuery(a,r),a.serializeArgs(a.args)},this.getTargetQuerySort=function(e,t){var r=y(typeToTarget(e),t),a=null;return r&&(a=r.args.filter(function(e){return e.name===RQL_NODE.SORT}).pop()),a},this.isOperator=n,this.isLeaf=i,this.getQueryPaginations=function(e){return e&&0!==e.args.length?e.args.reduce(function(e,t){if(function(e){switch(e){case RQL_NODE.VARIABLE:case RQL_NODE.DATASET:case RQL_NODE.NETWORK:case RQL_NODE.STUDY:return!0}return!1}(t.name)){var r=h.getLimitQuery(t);r&&(e[t.name]={from:r.args[0],size:r.args[1]})}return e},{}):{}},this.prepareQueryPagination=function(e,t,r,a){var n=y(t,e);n||(n=new RqlQuery(t),e.args.push(n)),h.addLimit(n,h.limit(r,a))},this.findCriteriaItemFromTreeById=function(e,t,r,a){var n=g(e,r),i={};return p.findItemNodeById(n,t,i,a)?i.item:null},this.findCriteriaItemFromTree=function(e,t){var r=g(e.target,t),a={};return p.findItemNode(r,e,a)?a.item:null},this.findTargetCriteria=g,this.findTargetQuery=y,this.findQueryInTargetByVocabulary=function(e,t){return r(e,null,t)},this.findQueryInTargetByTaxonomyVocabulary=r,this.prepareSearchQuery=function(e,t,r,a,n){return T(e,t,r,a,n,!0)},this.prepareSearchQueryNoFields=function(e,t,r,a,n){return T(e,t,r,a,n,!1)},this.prepareSearchQueryAndSerialize=function(e,t,r,a,n){return(new RqlQuery).serializeArgs(p.prepareSearchQuery(e,t,r,a,n).args)},this.prepareCoverageQuery=function(e,t){var r,a=this.parseQuery(e),n=new RqlQuery("aggregate"),i=t.split("-"),s=i[0],o=1<i.length?i[1]:void 0;switch(s){case BUCKET_TYPES.NETWORK:r="networkId";break;case BUCKET_TYPES.STUDY:case BUCKET_TYPES.STUDY_INDIVIDUAL:case BUCKET_TYPES.STUDY_HARMONIZATION:r="studyId";break;case BUCKET_TYPES.DCE:case BUCKET_TYPES.DCE_INDIVIDUAL:r="dceId";break;case BUCKET_TYPES.DATASCHEMA:case BUCKET_TYPES.DATASET:case BUCKET_TYPES.DATASET_COLLECTED:case BUCKET_TYPES.DATASET_HARMONIZED:r="datasetId"}var c,l=new RqlQuery("bucket");if(l.args.push(r),n.args.push(l),a.args.forEach(function(e){c||"variable"!==e.name||(c=e)}),c||(c=new RqlQuery("variable"),a.args.push(c)),0<c.args.length&&"limit"!==c.args[0].name){var u=new RqlQuery("in");u.args.push("Mica_variable.variableType"),void 0===o?t===BUCKET_TYPES.DATASET_HARMONIZED||t===BUCKET_TYPES.DATASCHEMA?u.args.push("Dataschema"):u.args.push(["Collected","Dataschema"]):-1<["individual","collected"].indexOf(o)?u.args.push("Collected"):-1<["harmonization","harmonized"].indexOf(o)&&u.args.push("Dataschema");var d=new RqlQuery("and");d.args.push(u),d.args.push(c.args[0]),c.args[0]=d}return c.args.push(n),a.serializeArgs(a.args)},this.prepareGraphicsQuery=function(e,t,r){var a,n=this.parseQuery(e),i=new RqlQuery(RQL_NODE.AGGREGATE);if(t.forEach(function(e){i.args.push(e)}),r&&0<r.length){var s=new RqlQuery(RQL_NODE.BUCKET);r.forEach(function(e){s.args.push(e)}),i.args.push(s)}var o=!1,c=!1;return n.args.forEach(function(e){if("study"===e.name){c=!0;var r=null;o=e.args.filter(function(e,t){return"limit"===e.name&&(r=t),["limit","sort","aggregate"].indexOf(e.name)<0}).length,null!==r&&e.args.splice(r,1),a=e}}),c||(a=new RqlQuery("study"),n.args.push(a)),o||a.args.push(new RqlQuery(RQL_NODE.MATCH)),a.args.push(i),n.args.push(new RqlQuery("facet")),n.serializeArgs(n.args)},this.getTargetAggregations=function(e,t,i){function r(e,t){var r=t.terms;if(r&&0<r.length){var a=e&&e.map(function(e){return e.key})||[];if(e){var n=[];return r.forEach(function(e){0!==a.length&&-1!==a.indexOf(e.name)||n.push({count:0,default:0,description:u.forLocale(e.description,i),key:e.name,title:u.forLocale(e.title,i)})}),e.concat(n)}return r.map(function(e){return{count:0,default:0,description:u.forLocale(e.description,i),key:e.name,title:u.forLocale(e.title,i)}})}return e}function a(e,t){if(e.children){var r=e.children.filter(function(e){return e.hasOwnProperty(t)}).pop();if(r)return r[t]}return null}var n=d.vocabularyAlias(t.vocabulary),s=e[t.target+"ResultDto"];if(s&&s.aggs){var o=t.taxonomy.name.startsWith("Mica_"),c=o?n:t.taxonomy.name,l=s.aggs.filter(function(e){return e.aggregation===c}).pop();if(l){if(o)return d.isNumericVocabulary(t.vocabulary)?l["obiba.mica.StatsAggregationResultDto.stats"]:d.isRangeVocabulary(t.vocabulary)?r(l["obiba.mica.RangeAggregationResultDto.ranges"],t.vocabulary):r(l["obiba.mica.TermsAggregationResultDto.terms"],t.vocabulary);if(l.children.filter(function(e){return e.aggregation===n}).pop())return d.isRangeVocabulary(t.vocabulary)?r(a(l,"obiba.mica.RangeAggregationResultDto.ranges"),t.vocabulary):r(a(l,"obiba.mica.TermsAggregationResultDto.terms"),t.vocabulary)}}return r([],t.vocabulary)},this.findCriterion=function(e,t){return function e(t,r){var a;if(t.id===r)return t;for(var n=t.children.filter(function(e){return e instanceof CriteriaItem}),i=n.length;i--;)if(a=e(n[i],r))return a}(e,t)},this.cleanQuery=function(e){var t=angular.copy(e);if(t.args){angular.forEach(t.args,function(e){if(e.args)for(var t=e.args.length;t--;)"limit"!==e.args[t].name&&"sort"!==e.args[t].name&&"fields"!==e.args[t].name||e.args.splice(t,1)});for(var r=t.args.length;r--;)"locale"!==t.args[r].name&&t.args[r].args&&0!==t.args[r].args.length||t.args.splice(r,1)}return t}}]),ngObibaMica.search.service("RqlQueryUtils",["VocabularyService",function(r){function c(e,t){var r=new RqlQuery(RQL_NODE.OR);return r.args=[e,t],r}function l(e,t,r){var a=new RqlQuery(e);return a.args.push(t),r&&0<r.length&&a.args.push(r),a}function a(e,t){return l(t&&0<t.length?RQL_NODE.IN:RQL_NODE.EXISTS,e,t)}function n(e,t){var r=new RqlQuery(RQL_NODE.MATCH);return r.args.push(t||"*"),r.args.push(e),r}function u(e){return e.name===RQL_NODE.MATCH&&1===e.args.length}function i(e,t,r){var a=new RqlQuery(RQL_NODE.BETWEEN);return a.args.push(e),o(a,t,r),a}function s(e,t){return t&&0<t.length?e.args[1]=t:e.args.splice(1,1),e}function d(e,t,r){if(t&&0<t.length){var a=e.args[1];if(!a||r)e.args[1]=t;else{a instanceof Array||(a=[a]);var n=t.filter(function(e){return-1===a.indexOf(e)});e.args[1]=a.concat(n)}}else e.args.splice(1,1);return e}function o(e,t,r,a){a?(e.name=RQL_NODE.MISSING,e.args.splice(1,1)):angular.isDefined(t)&&null!==t&&angular.isDefined(r)&&null!==r?(e.name=RQL_NODE.BETWEEN,e.args[1]=[t,r]):angular.isDefined(t)&&null!==t?(e.name=RQL_NODE.GE,e.args[1]=t):angular.isDefined(r)&&null!==r?(e.name=RQL_NODE.LE,e.args[1]=r):(e.name=RQL_NODE.EXISTS,e.args.splice(1,1))}function h(e){return e&&e.args?e.args.filter(function(e){return e.name===RQL_NODE.LIMIT}).pop():null}function m(e,t){return e.name+"."+t.name}this.vocabularyTermNames=function(e){return e&&e.terms?e.terms.map(function(e){return e.name}):[]},this.hasTargetQuery=function(e,t){return 0<e.args.filter(function(e){switch(e.name){case RQL_NODE.VARIABLE:case RQL_NODE.DATASET:case RQL_NODE.STUDY:case RQL_NODE.NETWORK:return!t||t===e.name;default:return!1}}).length},this.variableQuery=function(){return new RqlQuery(QUERY_TARGETS.VARIABLE)},this.eqQuery=function(e,t){var r=new RqlQuery(RQL_NODE.EQ);return r.args.push(t),r},this.orQuery=c,this.aggregate=function(e){var t=new RqlQuery(RQL_NODE.AGGREGATE);return e.forEach(function(e){t.args.push(e)}),t},this.fields=function(e){var t=new RqlQuery(RQL_NODE.FIELDS);return t.args.push(e),t},this.limit=function(e,t){var r=new RqlQuery(RQL_NODE.LIMIT);return r.args.push(e),r.args.push(t),r},this.fieldQuery=l,this.inQuery=a,this.matchQuery=n,this.isFreeTextMatch=u,this.updateMatchQuery=function(e,t){return e.args[0]=t||"*",e},this.rangeQuery=i,this.updateQueryInternal=s,this.mergeInQueryArgValues=d,this.updateRangeQuery=o,this.buildRqlQuery=function(e){return r.isNumericVocabulary(e.vocabulary)?i(m(e.taxonomy,e.vocabulary),null,null):r.isMatchVocabulary(e.vocabulary)?n(m(e.taxonomy,e.vocabulary),null):(Array.isArray(e.selectedTerms)&&0<e.selectedTerms.length?t=e.selectedTerms:e.term&&(t=e.term.name),a(m(e.taxonomy,e.vocabulary),t));var t},this.addQuery=function(e,t,r){if(0===e.args.length)e.args.push(t);else{var a=(c=(o=e).args.filter(function(e){switch(e.name){case RQL_NODE.AND:case RQL_NODE.NAND:case RQL_NODE.OR:case RQL_NODE.NOR:case RQL_NODE.NOT:case RQL_NODE.CONTAINS:case RQL_NODE.IN:case RQL_NODE.OUT:case RQL_NODE.EQ:case RQL_NODE.GT:case RQL_NODE.GE:case RQL_NODE.LT:case RQL_NODE.LE:case RQL_NODE.BETWEEN:case RQL_NODE.EXISTS:case RQL_NODE.MISSING:return!0;case RQL_NODE.MATCH:return 1<e.args.length}return!1}).pop())?o.args.findIndex(function(e){return e.name===c.name}):-1;if(-1===a)e.args.push(t);else{var n=e.args.splice(a,1).pop();if(!r&&t.args&&0<t.args.length){var i="Mica_"+e.name;u(t)||(r=("match"===t.name?t.args[1]:t.args[0]).startsWith(i+".")?RQL_NODE.AND:RQL_NODE.OR)}var s=new RqlQuery(r||RQL_NODE.AND);s.args.push(n,t),e.args.push(s)}}var o,c;return e},this.updateRepeatableQueryArgValues=function(e,o){e.items().forEach(function(e){var t=e.rqlQuery;switch(t.name){case RQL_NODE.EXISTS:t.name=RQL_NODE.CONTAINS,d(t,o,!1);break;case RQL_NODE.CONTAINS:d(t,o,!1);break;case RQL_NODE.IN:var r=t.args[1]?[].concat(t.args[1]):[];if(1===r.length){t.name=RQL_NODE.CONTAINS,d(t,o,!1);break}var a,n=t.args[0],i=r.filter(function(e){return o.indexOf(e)<0}).map(function(e){return l(RQL_NODE.CONTAINS,n,[].concat(e,o))});if(1<i.length){var s=i.splice(0,2);a=c(s[0],s[1]),i.forEach(function(e){a=c(e,a)}),t.name=a.name,t.args=a.args}else t.name=RQL_NODE.CONTAINS,t.args=i[0].args}})},this.updateQueryArgValues=function(e,t,r){switch(e.name){case RQL_NODE.EXISTS:case RQL_NODE.MISSING:e.name=RQL_NODE.IN,d(e,t,r);break;case RQL_NODE.CONTAINS:case RQL_NODE.IN:d(e,t,r);break;case RQL_NODE.BETWEEN:case RQL_NODE.GE:case RQL_NODE.LE:e.args[1]=t;break;case RQL_NODE.MATCH:e.args[0]=t}},this.updateQuery=function(e,t){switch(e.name){case RQL_NODE.CONTAINS:case RQL_NODE.IN:case RQL_NODE.OUT:case RQL_NODE.EXISTS:case RQL_NODE.MISSING:s(e,t)}},this.addLocaleQuery=function(e,t){if(!e.args.filter(function(e){return e.name===RQL_NODE.LOCALE}).pop()){var r=new RqlQuery("locale");r.args.push(t),e.args.push(r)}},this.addFields=function(e,t){if(e&&e.args){var r=e.args.filter(function(e){return e.name===RQL_NODE.FIELDS}).pop();r?r.args=t.args:e.args.push(t)}},this.getLimitQuery=h,this.addLimit=function(e,t){if(e&&e.args){var r=h(e);r?r.args=t.args:e.args.push(t)}},this.addSort=function(e,t){var r=e.args.filter(function(e){return e.name===RQL_NODE.SORT}).pop();r||(r=new RqlQuery("sort"),e.args.push(r)),r.args=Array.isArray(t)?t:[t]},this.criteriaId=m}]),ngObibaMica.search.service("SearchContext",function(){var t=null;this.setLocale=function(e){t=e},this.currentLocale=function(){return t}}),ngObibaMica.search.service("StudyFilterShortcutService",["$location","RqlQueryService",function(c,l){function u(e){e=e||l.parseQuery(c.search().query);var t,r=l.findTargetQuery(QUERY_TARGETS.STUDY,e);return r&&(t=l.findQueryInTargetByVocabulary(r,"className")),t}function t(e,t){return!e||(Array.isArray(e.args[1])?-1<e.args[1].indexOf(t):e.args[1]===t)}function r(e){return t(e,"Study")}function a(e){return t(e,"HarmonizationStudy")}this.filter=function(e){var t,r=l.parseQuery(c.search().query),a=u(r);switch(a?(t=a).name===RQL_NODE.EXISTS&&(t.name=RQL_NODE.IN):t=new RqlQuery(RQL_NODE.IN),t.args=["Mica_study.className"],e){case ngObibaMica.search.STUDY_FILTER_CHOICES.INDIVIDUAL_STUDIES:t.args.push("Study");break;case ngObibaMica.search.STUDY_FILTER_CHOICES.HARMONIZATION_STUDIES:t.args.push("HarmonizationStudy");break;case ngObibaMica.search.STUDY_FILTER_CHOICES.ALL_STUDIES:t.args.push(["Study","HarmonizationStudy"])}if(!a){var n=l.findTargetQuery(QUERY_TARGETS.STUDY,r);if(n||(n=new RqlQuery(QUERY_TARGETS.STUDY),r.args.push(n)),0<n.args.length){var i=n.args.filter(function(e){return l.isLeaf(e.name)||l.isOperator(e.name)}).pop();if(i){var s=new RqlQuery(RQL_NODE.AND),o=n.args.indexOf(i);s.args.push(t,i),n.args[o]=s}else n.args.push(t)}else n.args=[t]}c.search("query",(new RqlQuery).serializeArgs(r.args))},this.getStudyClassNameChoices=function(){return{choseAll:(e=u(),!e||e.name===RQL_NODE.EXISTS||r(e)&&a(e)),choseIndividual:r(u()),choseHarmonization:a(u())};var e}}]),ngObibaMica.search.service("TaxonomyService",["$q","TaxonomiesResource","TaxonomyResource","VocabularyService",function(i,s,o,c){function l(e,t){return o.get({target:e,taxonomy:t}).$promise}this.findVocabularyInTaxonomy=function(e,t,r){var a=i.defer(),n=null;return o.get({target:e,taxonomy:t}).$promise.then(function(e){e.vocabularies.some(function(e){if(e.name===r||c.vocabularyAlias(e)===r)return n=e,!0}),a.resolve(n)}),a.promise},this.getTaxonomy=l,this.getTaxonomies=function(e,t){var r,a,n=i.defer();return Array.isArray(t)?(r=e,a=t,s.get({target:r,query:"taxonomyName:"+a.join(" OR taxonomyName:")}).$promise).then(function(e){var r;e.forEach(function(e){e.vocabularies=c.visibleVocabularies(e.vocabularies)}),r=t,e.sort(function(e,t){return r.indexOf(e.name)-r.indexOf(t.name)}),n.resolve(e)}):l(e,t).then(function(e){e.vocabularies=c.visibleVocabularies(e.vocabularies),n.resolve(e)}),n.promise}}]),ngObibaMica.search.service("VocabularyService",["$translate","LocalizedValues","MetaTaxonomyService",function(s,o,a){var t={STRING:"string",INTEGER:"integer",DECIMAL:"decimal"};function c(e){return e.normalize("NFD").replace(/\//g," ").replace(/[^\w|^\s|^-]/g,"")}function r(e){if(!e)return!1;var t=e.attributes?e.attributes.filter(function(e){return"hidden"===e.key}).pop():null;return!t||"false"===t.value}function n(e){if(!e||!e.attributes)return!1;var t=e.attributes.filter(function(e){return-1<["hidden","facet"].indexOf(e.key)}).reduce(function(e,t){return e[t.key]=t.value,e},{});return"true"===t.facet&&(!t.hidden||"false"===t.hidden)}function l(e,t,r){var a=r;return e.attributes&&e.attributes.some(function(e){return e.key===t&&(a=e.value,!0)}),a}function i(e){return l(e,"type",t.STRING)}function u(e,t,n){var i=l(e,"termsSortKey",null);if(i&&t&&0<t.length)switch(i){case"name":t.sort(function(e,t){return e[i].localeCompare(t[i])});break;case"title":t.sort(function(e,t){var r=o.forLocale(e[i],n),a=o.forLocale(t[i],n);return r.localeCompare(a)})}}return this.filter=function(e,t){if(t){var n=c(t).toLowerCase().split(" ").filter(function(e){return 1<e.length}),r=Array.isArray(e)?e:e.vocabularies,i=a.getTaxonomyPanelOptions().fieldsToFilter;return(r||[]).filter(function(e){return e.filteredTerms=(e.terms||[]).filter(function(a){var r=c(i.reduce(function(e,t){return e+" "+(r=a[t],o.forLocale(r,s.use()));var r},i[0])).trim().toLowerCase();return n.map(function(e){if(e.startsWith("-")){var t=e.substr(1);return t.length<=1||-1===r.indexOf(t)}return 0<=r.indexOf(e)}).reduce(function(e,t){return e&&t},!0)}),!e.terms||0<e.filteredTerms.length})}},this.isVisibleVocabulary=r,this.findVocabularyAttributes=function(e,t){return(e.attributes||[]).filter(function(e){return-1<e.key.search(t)}).reduce(function(e,t){return e[t.key]=t.value,e},{})},this.visibleVocabularies=function(e){return(e||[]).filter(r)},this.visibleFacetVocabularies=function(e){return(e||[]).filter(n)},this.isRangeVocabulary=function(e){return e.terms&&(i(e)===t.INTEGER||i(e)===t.DECIMAL)},this.isTermsVocabulary=function(e){return i(e)===t.STRING&&e.terms},this.isMatchVocabulary=function(e){return i(e)===t.STRING&&!e.terms},this.isNumericVocabulary=function(e){return!e.terms&&(i(e)===t.INTEGER||i(e)===t.DECIMAL)},this.isFacettedVocabulary=function(e){return"true"===l(e,"facet","false")},this.sortVocabularyTerms=function(e,t){u(e,e.terms,t||s.$use())},this.sortFilteredVocabularyTerms=u,this.vocabularyAlias=function(e){return l(e,"alias",e.name)},this.vocabularyField=function(e){return l(e,"field",e.name)},this}]),ngObibaMica.search.filter("dceDescription",function(){return function(e){return e.split(":<p>").map(function(e){return"<p>"+e})[2]}}),ngObibaMica.search.filter("orderBySelection",function(){return function(e,t){if(!e)return[];var r=[],a=[];return e.forEach(function(e){t[e.key]?r.push(e):a.push(e)}),r.concat(a)}}),ngObibaMica.search.filter("regex",function(){return function(e,t,a,n){var r=[];try{var i=new RegExp(t,"i");r=e.filter(function(r){return a.some(function(e){var t=r[e];return angular.isArray(t)&&n?t.filter(function(e){return e.locale===n}).some(function(e){return i.test(e.text)}):i.test(t)})})}catch(e){}return r}}),ngObibaMica.search.filter("renderableTargets",["RqlQueryService",function(t){return function(e){return t.getRenderableTargetCriteria(e)}}]),ngObibaMica.search.STUDY_FILTER_CHOICES={ALL_STUDIES:"all",INDIVIDUAL_STUDIES:"individual",HARMONIZATION_STUDIES:"harmonization"},ngObibaMica.search.filter("visibleVocabularies",["VocabularyService",function(t){return function(e){return t.visibleVocabularies(e)}}]),ngObibaMica.search.SortVocabularyTerms=function(r){return function(e,t){return r.sortFilteredVocabularyTerms(t,e),e}},ngObibaMica.search.filter("sortTerms",["VocabularyService",ngObibaMica.search.SortVocabularyTerms]),ngObibaMica.search.component("entityCounts",{transclude:!0,bindings:{result:"<",target:"<",onSelectType:"&",resultTabsOrder:"<",taxonomyTypeMap:"<"},templateUrl:"search/components/entity-counts/component.html",controller:[function(){var t=this;t.getTotalHits=function(e){return t.result&&t.result[e+"TotalCount"]?t.result[e+"TotalCount"].hits:""},t.selectType=function(e){t.onSelectType({type:targetToType(e)})}}]}),ngObibaMica.search.component("entitySearchTypeahead",{bindings:{target:"<",entityType:"<",rqlQuery:"<",withSpecificFields:"@",placeholderText:"@",showButton:"@"},templateUrl:"search/components/entity-search-typeahead/component.html",controller:["EntitySuggestionService",function(t){var r=this;function a(e){t.selectSuggestion(r.target,e,"true"===r.withSpecificFields)}r.model="",r.suggest=function(e){return t.suggest(r.entityType,e)},r.select=a,r.clear=function(){a(r.model="")},r.onKeyUp=function(e){13===e.keyCode&&a(r.model)},r.$onChanges=function(e){e.rqlQuery.currentValue&&(r.model=t.getCurrentSuggestion(r.target,r.rqlQuery)||"")}}]}),ngObibaMica.search.directive("fullscreen",["FullScreenService",function(a){return{link:function(e,r,t){t.fullscreen&&e.$watch(t.fullscreen,function(e){var t=a.isEnabled();e&&!t?(a.enable(r[0]),r.addClass("isInFullScreen")):!e&&t&&(a.cancel(),r.removeClass("isInFullScreen"))})}}}]),ngObibaMica.search.directive("includeReplace",function(){return{require:"ngInclude",link:function(e,t){t.replaceWith(t.children())}}}),ngObibaMica.search.component("inputSearchFilter",{transclude:!0,bindings:{taxonomiesQuery:"<",taxonomyName:"<",queryString:"<",onFilterChange:"&"},templateUrl:"search/components/input-search-filter/component.html",controller:[function(){var r=this;function e(){r.onFilterChange({queryString:r.queryString})}r.$onChanges=function(e){if(e.taxonomyName){var t=!1;r.taxonomiesQuery.forEach(function(e){e.name===r.taxonomyName&&e.queryString&&(r.queryString=e.queryString,t=!0)}),t||(r.queryString="")}},r.change=e,r.clear=function(){r.queryString="",e()}}]}),ngObibaMica.search.directive("scrollToTop",function(){return{restrict:"A",scope:{trigger:"=scrollToTop"},link:function(e,t){e.$watch("trigger",function(){t[0].scrollTop=0})}}}),ngObibaMica.search.component("searchBoxRegion",{bindings:{targets:"<",options:"<",alertId:"@",lang:"<",taxonomyNav:"<",onSelectCriteria:"&",onGotoClassifications:"&",onSelectTerm:"&"},templateUrl:"search/components/search-box-region/component.html",controller:["$translate","VocabularyService","RqlQueryService","AlertService","StringUtils","LocaleStringUtils","ServerErrorUtils","TaxonomiesSearchResource",function(a,d,h,t,e,r,n,i){var m=this;function p(e,t){return!(-1<(t||[]).indexOf(e.name))&&0===(e.attributes||[]).filter(function(e){return"showSearch"===e.key}).length}function f(e,t){var r=0,a=new RegExp(e,"ig");return t.itemTitle.match(a)?r=10:t.itemDescription&&t.itemDescription.match(a)?r=8:t.itemParentTitle.match(a)?r=6:t.itemParentDescription&&t.itemParentDescription.match(a)&&(r=4),r}m.selectedCriteria=null,m.target=null,m.documents={search:{text:null,active:!1,target:null}},m.selectCriteria=function(e){m.onSelectCriteria({item:e}),m.selectedCriteria=null},m.searchCriteria=function(u){return i.get({query:e.quoteQuery(u.replace(/\/.*/g,"")),locale:m.lang,target:m.documents.search.target}).$promise.then(function(e){if(e){var c=[],l=0;if(e.forEach(function(e){var a,t,n,i,s,o,r=(a=u,n=[],i=0,s=(t=e).target,(o=t.taxonomy).vocabularies&&o.vocabularies.filter(function(e){return d.isVisibleVocabulary(e)&&p(e,m.hideSearch)}).forEach(function(r){if(r.terms)r.terms.filter(function(e){return p(e,m.hideSearch)}).forEach(function(e){var t=h.createCriteriaItem(s,o,r,e,m.lang);n.push({score:f(a,t),item:t}),i++});else{var e=h.createCriteriaItem(s,o,r,null,m.lang);n.push({score:f(a,e),item:e}),i++}}),{results:n,total:i});c.push.apply(c,r.results),l+=r.total}),c.sort(function(e,t){return t.score-e.score}),c=c.splice(0,10),l>c.length){var t={query:u,total:l,size:10,message:r.translate("search.showing",[10,l]),status:"has-warning"};c.push({score:-1,item:t})}return c.map(function(e){return e.item})}return[]},function(e){t.alert({id:m.alertId,type:"danger",msg:n.buildMessage(e),delay:5e3})})},m.selectSearchTarget=function(e){m.documents.search.target=e},m.clearTaxonomy=function(){m.target=null,m.taxonomyName=null},m.showTaxonomy=function(e,t){m.target===e&&m.taxonomyName===t&&m.taxonomiesShown?m.taxonomiesShown=!1:(m.taxonomiesShown=!0,m.target=e,m.taxonomyName=t)},m.translateTaxonomyNav=function(e,t){var r=e[t]&&e[t].filter(function(e){return e.locale===a.use()}).pop();return r?r.text:t},m.goToClassifications=function(){m.onGotoClassifications({})},m.selectTerm=function(e,t,r,a){m.onSelectTerm({target:e,taxonomy:t,vocabulary:r,args:a})}}]}),ngObibaMica.search.directive("studyFilterShortcut",["$location","$translate","RqlQueryService","StudyFilterShortcutService",function(e,r,t,a){return{restrict:"EA",replace:!0,templateUrl:"search/components/study-filter-shortcut/component.html",link:function(t){function e(){var e=a.getStudyClassNameChoices();e.choseAll?t.studyFilterSelection._selection=ngObibaMica.search.STUDY_FILTER_CHOICES.ALL_STUDIES:e.choseIndividual?t.studyFilterSelection._selection=ngObibaMica.search.STUDY_FILTER_CHOICES.INDIVIDUAL_STUDIES:e.choseHarmonization&&(t.studyFilterSelection._selection=ngObibaMica.search.STUDY_FILTER_CHOICES.HARMONIZATION_STUDIES)}t.studyFilterSelection={get selection(){return this._selection},set selection(e){var t;this._selection=e,t=e,a.filter(t,r.use())}},t.$on("$locationChangeSuccess",function(){e()}),e()}}}]),ngObibaMica.search.component("vocabularyFilterDetailHeading",{transclude:!0,bindings:{showTaxonomyPanel:"<",taxonomyName:"<",taxonomiesQuery:"<",clearQuery:"<",onFilterChange:"&",taxonomyTypeMap:"<",resultTabsOrder:"<",target:"<",onSelectType:"&",result:"<",togglePannel:"&"},templateUrl:["ngObibaMicaSearchTemplateUrl",function(e){return e.getTemplateUrl("vocabularyFilterDetailHeading")}],controller:[function(){var t=this,n=document.querySelectorAll("body")[0];function r(r,e){var a=null!==r.target.closest("#back-to-top"),t=n.querySelectorAll(".overlay-front-on-box-shodow");t.forEach(function(e){var t;a=a||(t=e.getBoundingClientRect(),r.clientX>t.x&&r.clientX<t.x+t.width&&r.clientY>t.y&&r.clientY<t.y+t.height)}),t&&!a&&(r.preventDefault(),e&&e())}function a(){n.onkeyup=null,n.onmouseup=null}t.selectType=function(e){return t.onSelectType({type:e})},t.filterChange=function(e){return t.onFilterChange({queryString:e})},t.$onDestroy=function(){a()},n.onmouseup=function(e){r(e,t.togglePannel)},n.onkeyup=function(e){27===e.keyCode&&(a(),t.togglePannel())}}]}),ngObibaMica.DatasetVariableCrosstab=angular.module("obiba.mica.DatasetVariableCrosstab",["ui.bootstrap","obiba.notification","obiba.mica.analysis","schemaForm","schemaForm-datepicker","pascalprecht.translate","angularMoment","ui.bootstrap","ui.select"]),ngObibaMica.DatasetVariableCrosstab.controller("DatasetVariableCrosstabController",["$rootScope","$scope","$routeParams","$log","$location","$route","$translate","DatasetResource","DatasetCategoricalVariablesResource","DatasetVariablesResource","DatasetVariableResource","DatasetVariablesCrosstabResource","ServerErrorAlertService","ContingencyService","LocalizedValues","ChiSquaredCalculator","PageUrlService","ngObibaMicaAnalysisTemplateUrl","AnalysisConfigService",function(i,o,r,t,s,c,l,e,a,n,u,d,h,m,p,f,g,y,b){var v=b.getOptions(),S=function(e){o.serverError=!0,h.alert("MainController",e)},T=function(e){return e&&"CONTINUOUS"===e.nature},E=function(){return o.crosstab.lhs.variable&&o.crosstab.rhs.variable&&!T(o.crosstab.rhs.variable)},O=function(){var e,t,n;o.crosstab.lhs.variable&&o.crosstab.rhs.variable&&(o.crosstab.lhs.xVariable=o.crosstab.lhs.variable,o.crosstab.rhs.xVariable=o.crosstab.rhs.variable,e=m.removeVariableFromUrl(s.path()),t=m.createVariableUrlPart(o.crosstab.lhs.xVariable.id,o.crosstab.rhs.xVariable.id),n=s.path,s.path=function(e,t){if(!1===t)var r=c.current,a=i.$on("$locationChangeSuccess",function(){c.current=r,a()});return n.apply(s,[e])},s.path(e+"/"+t,!1),s.path=n,o.loading=!0,d.get({dsType:r.type,dsId:r.ds,v1:o.crosstab.lhs.xVariable.name,v2:o.crosstab.rhs.xVariable.name},function(e){0===Object.keys(e).filter(function(e){return"$"!==e[0]}).length?S({status:"crosstab.no-data"}):(o.crosstab.contingencies=A(e.contingencies?e.contingencies:[e]),o.datasetHarmo&&(o.crosstab.all=A(e.all?[e.all]:[])[0])),o.loading=!1},S))},R=function(){o.crosstab={lhs:{variable:null,xVariable:null,variables:[]},rhs:{variable:null,xVariable:null,variables:[]},all:null,contingencies:null}};function C(t,e){function u(e,t){return 0===t?0:e/t*100}function r(r){r.frequencies||(r.frequencies=[]);var a=r.frequencies.map(function(e){return e.value});e.forEach(function(e,t){-1===a.indexOf(e)&&r.frequencies.splice(t,0,{count:r.privacyCheck?0:"-",value:e})})}function a(s,o,c,l){l?(s.percent=u(s.n,o),s.frequencies.forEach(function(e,t){var r,a,n,i;e.percent=u(e.count,c.frequencies[t].count),e.cpercent=u(e.count,s.n),l.sum+=(r=e.count,n=s.n,i=c.frequencies[t].count,0==(a=n*i/o)?0:Math.pow(r-a,2)/a)})):s.frequencies.forEach(function(e){e.percent=u(e.count,o),e.cpercent=u(e.n,o)})}t.privacyThreshold;var n,i,s=t.all.total;t.all.privacyCheck=t.all.frequencies&&0<t.all.frequencies.length,r(t.all),a(t.all,s,t.all),t.aggregations&&(t.chiSquaredInfo={pValue:0,sum:0,df:(n=o.crosstab.rhs.xVariable.categories.length,i=o.crosstab.lhs.xVariable.categories.length,(n-1)*(i-1))},t.privacyCheck=!0,t.aggregations.forEach(function(e){e.privacyCheck=!!e.frequencies&&0<e.frequencies.length,t.privacyCheck=t.privacyCheck&&e.privacyCheck,r(e),a(e,s,t.all,t.chiSquaredInfo)}),t.privacyCheck&&(t.chiSquaredInfo.pValue=1-f.compute(t.chiSquaredInfo)))}var D=function(t){var e=t.studySummary,r={},a={};if(t.studySummary){var n=t.studySummary;a=(r=n.populationSummaries?n.populationSummaries[0]:null)&&r.dataCollectionEventSummaries?r.dataCollectionEventSummaries.filter(function(e){return e.id===t.dataCollectionEventId}):null}var i=l.use();return{summary:p.forLang(e.acronym,i),population:r?p.forLang(r.name,i):"",dce:a?p.forLang(a[0].name,i):"",project:t.project,table:t.table,tableName:p.forLang(t.name,i)}};function A(e){var t=o.crosstab.rhs.xVariable.categories?o.crosstab.rhs.xVariable.categories.map(function(e){return e.name}):void 0,r=o.crosstab.lhs.xVariable.categories?o.crosstab.lhs.xVariable.categories.map(function(e){return e.name}):void 0;return e&&e.forEach(function(e){e.totalPrivacyCheck=-1!==e.all.n,(!e.totalPrivacyCheck||0<e.all.n)&&(T(o.crosstab.rhs.xVariable)?function(r,e){r.privacyCheck=r.aggregations.filter(function(e){return null!==e.statistics}).length===r.aggregations.length;var a=r.aggregations.map(function(e){return e.term});r.privacyCheck?e.forEach(function(e,t){-1===a.indexOf(e)&&r.aggregations.splice(t,0,{n:"-",statistics:{min:"-",max:"-",mean:"-",stdDeviation:"-"}})}):(r.aggregations.forEach(function(e){e.statistics={min:"-",max:"-",mean:"-",stdDeviation:"-"}}),r.all.statistics={min:"-",max:"-",mean:"-",stdDeviation:"-"})}(e,r):C(e,t)),e.studyTable&&(e.info=D(e.studyTable))}),e}function w(e,t){var r=null;return e&&e.categories&&(r=e.categories.filter(function(e){return e.name===t})),r?r[0]:t}o.crosstabTemplateUrl=y.getTemplateUrl("variableCrosstab"),o.isStatistical=T,o.getTemplatePath=function(e){if(o.crosstab.rhs.xVariable)return T(o.crosstab.rhs.xVariable)?!e.totalPrivacyCheck||0<e.all.n?y.getTemplateUrl("variableStatistics"):y.getTemplateUrl("variableStatisticsEmpty"):!e.totalPrivacyCheck||0<e.all.n?y.getTemplateUrl("variableFrequencies"):y.getTemplateUrl("variableFrequenciesEmpty");t.error("RHS variable is not initialized!")},o.getPrivacyErrorMessage=function(e){return e.totalPrivacyCheck?e.privacyCheck?"":"dataset.crosstab.privacy-check-failed":"dataset.crosstab.total-privacy-check-failed"},o.canExchangeVariables=E,o.exchangeVariables=function(){if(E()){var e=o.crosstab.lhs.variable;o.crosstab.lhs.variable=o.crosstab.rhs.variable,o.crosstab.rhs.variable=e,O()}},o.extractSummaryInfo=D,o.lhsVariableCategory=function(e){return w(o.crosstab.lhs.xVariable,e)},o.rhsVariableCategory=function(e){return w(o.crosstab.rhs.xVariable,e)},o.clear=function(){R()},o.submit=O,o.searchCategoricalVariables=function(e){!e||e.trim().length<2||a.get({dsType:r.type,dsId:r.ds,query:e.trim()+"*"},function(e){o.crosstab.lhs.variables=e.variables},S)},o.searchVariables=function(e){!e||e.trim().length<2||n.get({dsType:r.type,dsId:r.ds,query:e.trim()+"*"},function(e){o.crosstab.rhs.variables=e.variables},S)},o.PageUrlService=g,o.DocType={CSV:"csv",EXCEL:"excel"},o.StatType={CPERCENT:1,RPERCENT:2,CHI:3},o.routeParams=r,o.options={showDetailedStats:v.crosstab.showDetailedStats,showDetails:!0,statistics:o.StatType.CPERCENT},o.downloadUrl=function(e){return m.getCrossDownloadUrl({":dsType":r.type,":dsId":r.ds,":docType":e,":v1":o.crosstab.lhs.xVariable.name,":v2":o.crosstab.rhs.xVariable.name})},R(),e.get({dsType:r.type,dsId:r.ds},function(e){o.dataset=e,o.dataset.translatedAcronym=p.forLang(o.dataset.acronym,l.use()),o.datasetHarmo=o.dataset.hasOwnProperty("obiba.mica.HarmonizedDatasetDto.type")},S);var I=0;r.varId&&u.get({varId:r.varId},function(e){o.crosstab.lhs.variable=e,o.crosstab.lhs.variables=[e],1<++I&&O()},S),r.byId&&u.get({varId:r.byId},function(e){o.crosstab.rhs.variable=e,o.crosstab.rhs.variables=[e],1<++I&&O()},S)}]),ngObibaMica.DatasetVariableCrosstab.filter("variableCategory",function(){return function(e,t){var r=null;return e&&(r=e.filter(function(e){return e.name===t})),r?r[0]:null}}).filter("variableLabel",["AttributeService",function(a){return function(e){var t="";if(e){var r=a.getAttributes(e,["label"]);return r&&r.forEach(function(e){return t=a.getValue(e),!1}),t}}}]).filter("roundNumber",["$filter",function(t){return function(e){return isNaN(e)?e:t("number")(e,2)}}]),ngObibaMica.DatasetVariableCrosstab.config(["$routeProvider",function(e){e.when("/crosstab/:type/:ds",{templateUrl:"analysis/crosstab/views/crosstab-variable-crosstab.html",controller:"DatasetVariableCrosstabController"}).when("/crosstab/:type/:ds/variable/:varId",{templateUrl:"analysis/crosstab/views/crosstab-variable-crosstab.html",controller:"DatasetVariableCrosstabController"}).when("/crosstab/:type/:ds/variable/:varId/by/:byId",{templateUrl:"analysis/crosstab/views/crosstab-variable-crosstab.html",controller:"DatasetVariableCrosstabController"})}]),ngObibaMica.analysis=angular.module("obiba.mica.analysis",["obiba.alert","ui.bootstrap","pascalprecht.translate","templates-ngObibaMica"]),ngObibaMica.analysis.config(["$provide",function(e){e.provider("ngObibaMicaAnalysisTemplateUrl",(new NgObibaMicaTemplateUrlFactory).create({entities:{header:null,footer:null},variableCrosstab:{template:null},variableFrequencies:{template:null},variableFrequenciesEmpty:{template:null},variableStatistics:{template:null},variableStatisticsEmpty:{template:null}}))}]),ngObibaMica.DatasetVariableCrosstab.factory("DatasetCategoricalVariablesResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DatasetCategoricalVariablesResource"),{},{get:{method:"GET",errorHandler:!0}})}]),ngObibaMica.DatasetVariableCrosstab.factory("DatasetResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DatasetResource"),{},{get:{method:"GET",errorHandler:!0}})}]),ngObibaMica.DatasetVariableCrosstab.factory("DatasetVariableResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DatasetVariableResource"),{},{get:{method:"GET",errorHandler:!0}})}]),ngObibaMica.DatasetVariableCrosstab.factory("DatasetVariablesCrosstabResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DatasetVariablesCrosstabResource"),{},{get:{method:"GET",errorHandler:!0}})}]),ngObibaMica.DatasetVariableCrosstab.factory("DatasetVariablesResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("DatasetVariablesResource"),{},{get:{method:"GET",errorHandler:!0}})}]),ngObibaMica.search.factory("EntitiesCountResource",["$resource","ngObibaMicaUrl",function(e,t){var r=t.getUrl("EntitiesCountResource"),a=-1===r.indexOf(":query")?"POST":"GET";return e(r,{},{get:{method:a,headers:{"Content-Type":"POST"===a?"application/x-www-form-urlencoded":"application/json"},transformRequest:function(e){var t=[];for(var r in e)t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")},errorHandler:!0}})}]),ngObibaMica.search.factory("VariableResource",["$resource","ngObibaMicaUrl","$cacheFactory",function(e,t,r){return e(t.getUrl("VariableResource"),{},{get:{method:"GET",errorHandler:!0,cache:r("variableResource")}})}]),ngObibaMica.search.factory("VariableSummaryResource",["$resource","ngObibaMicaUrl","$cacheFactory",function(e,t,r){return e(t.getUrl("VariableSummaryResource"),{},{get:{method:"GET",errorHandler:!0,cache:r("variableSummaryResource")}})}]),ngObibaMica.analysis.controller("EntitiesCountController",["$scope","$location","$translate","$cookies","LocalizedValues","AnalysisConfigService","EntitiesCountResource","AlertService","ServerErrorUtils","ngObibaMicaAnalysisTemplateUrl",function(t,e,r,a,n,i,s,o,c,l){var u,d,h;function m(){t.query?(t.loading=!0,s.get({query:t.query},function(e){t.result=e,t.loading=!1,t.localizedTotal=(t.result.belowPrivacyThreshold?"<":"")+n.formatNumber(t.result.total,r.use())},function(e){t.result={},t.loading=!1,o.alert({id:"EntitiesCountController",type:"danger",msg:c.buildMessage(e),delay:5e3})})):t.result={}}t.options=i.getOptions(),u=t,d=a,h="micaHideEntitiesCountHelpText",r(["analysis.entities-count.help"]).then(function(e){u.options.EntitiesCountHelpText||d.get(h)||(u.options.EntitiesCountHelpText=e["analysis.entities-count.help"])}),u.closeHelpBox=function(){d.put(h,!0),u.options.EntitiesCountHelpText=null},d.get(h)&&(u.options.EntitiesCountHelpText=null),t.entitiesHeaderTemplateUrl=l.getHeaderUrl("entities"),t.result={},t.query=e.search().query,t.loading=!1,m(),t.$on("$locationChangeSuccess",function(){t.query=e.search().query,m()})}]),ngObibaMica.analysis.config(["$routeProvider",function(e){e.when("/entities-count",{templateUrl:"analysis/views/analysis-entities-count.html",controller:"EntitiesCountController",reloadOnSearch:!1})}]);var AnalysisConfigService=function(){function e(){this.options={crosstab:{showDetailedStats:!0},showAnalysis:!0}}return e.prototype.setOptions=function(t){var r=this;"object"==typeof t&&Object.keys(t).forEach(function(e){e in r.options&&(r.options[e]=t[e])})},e.prototype.getOptions=function(){return angular.copy(this.options)},e.prototype.showAnalysis=function(){return this.options.showAnalysis},e}();ngObibaMica.analysis.service("AnalysisConfigService",[AnalysisConfigService]);var ChiSquaredCalculator=function(){function e(){}return e.prototype.compute=function(e){var t=null,r=e.sum,a=e.df;return a<=0||(t=this.gammacdf(r/2,a/2)),t=Math.round(1e5*t)/1e5},e.prototype.logGamma=function(e){var t=1+76.18009173/e-86.50532033/(e+1)+24.01409822/(e+2)-1.231739516/(e+3)+.00120858003/(e+4)-536382e-11/(e+5);return(e-.5)*Math.log(e+4.5)-(e+4.5)+Math.log(2.50662827465*t)},e.prototype.gcf=function(e,t){for(var r=0,a=1,n=1,i=e,s=0,o=0;1e-5<Math.abs((n-s)/n);)n=e*(r=(s=n)+((o+=1)-t)*r)+o*n,r/=i=e*(a=i+(o-t)*a)+o*i,a/=i,n/=i,i=1;return 1-Math.exp(t*Math.log(e)-e-this.logGamma(t))*n},e.prototype.gser=function(e,t){for(var r=1/t,a=r,n=1;1e-5*a<r;)a+=r=r*e/(t+n),n+=1;return a*=Math.exp(t*Math.log(e)-e-this.logGamma(t))},e.prototype.gammacdf=function(e,t){return e<=0?0:e<t+1?this.gser(e,t):this.gcf(e,t)},e}();ngObibaMica.DatasetVariableCrosstab.service("ChiSquaredCalculator",[ChiSquaredCalculator]);var ContingencyService=function(){function e(){}return e.prototype.removeVariableFromUrl=function(e){return e.replace(/\/variable\/.*/,"")},e.prototype.getCrossDownloadUrl=function(e){return this.searchReplace(":dsType/:dsId/download_:docType/cross/:v1/by/:v2/ws",e)},e.prototype.createVariableUrlPart=function(e,t){return this.searchReplace("variable/:var/by/:by",{":by":t,":var":e})},e.prototype.searchReplace=function(e,t){return e.replace(/:\w+/g,function(e){return t[e]||e})},e}();ngObibaMica.DatasetVariableCrosstab.service("ContingencyService",[ContingencyService]);var EntitiesCountService=function(){function e(e,t){this.$location=e,this.ObibaServerConfigResource=t;var r=this;t.get(function(e){r.hasMultipleStudies=!e.isSingleStudyEnabled||e.isHarmonizedDatasetEnabled})}return e.prototype.isSingleStudy=function(){return!this.hasMultipleStudies},e.prototype.update=function(e,t){if(e!==t){var r=this.$location.search();r.query=r.query.split(e).join("").replace(/,,/,",").replace(/^,/,"").replace(/,$/,""),t&&0!==t.length&&(r.query&&0<r.query.length?r.query=r.query+","+t:r.query=t),this.$location.search(r)}},e.$inject=["$location","ObibaServerConfigResource"],e}();ngObibaMica.analysis.service("EntitiesCountService",["$location","ObibaServerConfigResource",EntitiesCountService]);var CrosstabStudyTableController=function(){function e(e){this.PageUrlService=e,this.contingency={}}return e.prototype.$onChanges=function(){this.contingency.studyTable&&(this.studyLink=this.PageUrlService.studyPage(this.contingency.studyTable.studyId,"individual-study"))},e.$inject=["PageUrlService"],e}(),CrosstabStudyTableComponent=function(){this.transclude=!0,this.bindings={contingency:"<"},this.controller=CrosstabStudyTableController,this.controllerAs="$ctrl",this.templateUrl="analysis/components/crosstab-study-table/component.html"};ngObibaMica.DatasetVariableCrosstab.component("crosstabStudyTable",new CrosstabStudyTableComponent);var Operation,EntitiesCountResultTableController=function(){function e(e,t,r,a,n){this.PageUrlService=e,this.LocalizedValues=t,this.EntitiesCountService=r,this.$translate=a,this.$log=n,this.result={}}return e.prototype.$onInit=function(){this.table={rows:new Array}},e.prototype.$onChanges=function(){this.table=this.asTable(),this.localizedTotal=this.LocalizedValues.formatNumber(this.result.total?this.result.total:0),this.result.belowPrivacyThreshold&&(this.localizedTotal="<"+this.localizedTotal)},e.prototype.showStudyColumn=function(){return!this.EntitiesCountService.isSingleStudy()},e.prototype.localize=function(e){return this.LocalizedValues.forLang(e,this.$translate.use())},e.prototype.asTable=function(){var f=this,g={rows:new Array};return this.studyCount=this.result.counts?this.result.counts.length:0,this.studyCount&&this.result.counts.forEach(function(d){var h=f.localize(d.study.acronym),m=f.localize(d.study.name);if(d.counts){var p=0;d.counts.forEach(function(c){var l=f.localize(c.dataset.acronym),u=f.localize(c.dataset.name);c.counts&&c.counts.forEach(function(e){var t=e.variable.id.split(":"),r=t[1];e.studyTableName&&(r=r+" ("+f.localize(e.studyTableName)+")");var a=t[2],n=f.PageUrlService.variablePage(e.variable.id),i=f.PageUrlService.datasetPage(c.dataset.id,a),s="Dataschema"===a?"harmonization":"individual",o=new Array({colspan:1,link:f.PageUrlService.studyPage(d.study.id,s),rowspan:0===p?1:0,title:0===p?m:"",value:0===p?h:""},{colspan:1,link:n||i,rowspan:1,title:f.localize(e.variable.name),value:r},{colspan:1,link:i,rowspan:1,title:u,value:l},{colspan:1,link:void 0,rowspan:1,title:e.query,value:e.query},{colspan:1,link:void 0,rowspan:1,title:void 0,value:f.LocalizedValues.formatNumber(e.count)});g.rows.push(o),p++})}),g.rows[g.rows.length-p][0].rowspan=p+1,g.rows.push(new Array({colspan:1,rowspan:0,title:void 0,value:void 0},{colspan:3,rowspan:1,title:d.query,value:void 0},{colspan:1,rowspan:1,title:void 0,value:(d.belowPrivacyThreshold?"<":"")+f.LocalizedValues.formatNumber(d.total)}))}}),g},e.$inject=["PageUrlService","LocalizedValues","EntitiesCountService","$translate","$log"],e}(),EntitiesCountResultTableComponent=function(){this.transclude=!0,this.bindings={result:"<"},this.controller=EntitiesCountResultTableController,this.controllerAs="$ctrl",this.templateUrl="analysis/components/entities-count-result-table/component.html"};ngObibaMica.analysis.component("entitiesCountResultTable",new EntitiesCountResultTableComponent),function(e){e.All="all",e.Exists="exists",e.Empty="empty",e.In="in",e.Out="out"}(Operation||(Operation={}));var VariableCriteriaController=function(){function e(e,t,r,a,n,i,s){this.VariableResource=e,this.VariableSummaryResource=t,this.LocalizedValues=r,this.EntitiesCountService=a,this.$log=n,this.$translate=i,this.$filter=s,this.query="",this.state={open:!1},this.categoriesData=[],this.selectedCategories={},this.selectedNumericalOperation="range",this.selectedTemporalOperation="range"}return e.prototype.$onInit=function(){this.loading=!0,this.initializeState()},e.prototype.onKeyup=function(e){13===e.keyCode?this.closeDropdown(!1):27===e.keyCode&&this.closeDropdown(!0)},e.prototype.onSearchTextKeyup=function(e){var t=this.searchText.trim();if(this.categoriesData){var r=new RegExp(t,"i");this.categoriesData.forEach(function(e){e.visible=null!==e.label.match(r)})}},e.prototype.onNumericalMinKeyup=function(e){this.selectedMin=this.ensureNumericValue(this.selectedMin+""," ")},e.prototype.onNumericalMaxKeyup=function(e){this.selectedMax=this.ensureNumericValue(this.selectedMax+""," ")},e.prototype.onNumericalValuesKeyup=function(e){this.selectedNumericalValues=this.ensureNumericValue(this.selectedNumericalValues," ")},e.prototype.closeDropdown=function(e){this.state.open=!1,e||this.update(this.makeNewQuery())},e.prototype.openDropdown=function(){this.state.open?this.closeDropdown(!1):this.state.open=!0},e.prototype.onRemove=function(){this.update("")},e.prototype.getQueryTitle=function(e){var t=this;if(!this.rqlQuery)return"?";var r=this.getOperationTitle(),a=this.getRqlQueryWithArgs();if(1<a.args.length){var n=a.args[1];"CATEGORICAL"===this.getNature()&&(n=n.map(function(e){return t.localizeCategory(e)})),r="range"===a.name?r+" ["+n.join(", ")+"]":r+" ("+n.join(", ")+")"}return e?50<r.length?r.substring(0,50)+"...":r:50<r.length?r:""},e.prototype.showInOperations=function(){return"CATEGORICAL"===this.getNature()||this.isNumerical()||this.isTemporal()},e.prototype.showCategoricalOptions=function(){return"CATEGORICAL"===this.getNature()&&this.showOptions()},e.prototype.showNumericalOptions=function(){return"CONTINUOUS"===this.getNature()&&this.isNumerical()&&this.showOptions()},e.prototype.showTemporalOptions=function(){return"TEMPORAL"===this.getNature()&&this.isTemporal()&&this.showOptions()},e.prototype.localizeNumber=function(e){return this.LocalizedValues.formatNumber(e)},e.prototype.initializeState=function(){if(this.rqlQuery=this.parseQuery(),this.rqlQuery.args){var e=this.getQueryWithArgs();this.id=e.args[0].join(":"),this.VariableResource.get({id:this.id},this.onVariable(),this.onError())}},e.prototype.getQueryWithArgs=function(){return this.isQueryNot()?this.rqlQuery.args[0]:this.rqlQuery},e.prototype.isQueryNot=function(){return"not"===this.rqlQuery.name},e.prototype.update=function(e){this.EntitiesCountService.update(this.query,e)},e.prototype.showOptions=function(){return Operation.All!==this.selectedOperation&&Operation.Exists!==this.selectedOperation&&Operation.Empty!==this.selectedOperation},e.prototype.getNature=function(){return this.variable?this.variable.nature:"?"},e.prototype.isNumerical=function(){return this.variable&&("integer"===this.variable.valueType||"decimal"===this.variable.valueType)},e.prototype.isLogical=function(){return this.variable&&"boolean"===this.variable.valueType},e.prototype.isTemporal=function(){return this.variable&&("date"===this.variable.valueType||"datetime"===this.variable.valueType)},e.prototype.getOperationTitle=function(){var e=this.getRqlQueryWithArgs();return this.isNotQuery()?"exists"===e.name?this.$filter("translate")("analysis.empty"):this.$filter("translate")("analysis.out"):this.$filter("translate")("analysis."+("range"===e.name?"in":e.name))},e.prototype.getRqlQueryWithArgs=function(){return this.isNotQuery()?this.rqlQuery.args[0]:this.rqlQuery},e.prototype.isNotQuery=function(){return this.rqlQuery&&"not"===this.rqlQuery.name},e.prototype.parseQuery=function(){try{return(new RqlParser).parse(this.normalize(this.query)).args[0]}catch(e){this.$log.error(e.message)}return new RqlQuery},e.prototype.normalize=function(e){return e.split(":").join("/")},e.prototype.localizeCategory=function(t){if(!this.variable.categories)return this.isLogical()?this.$filter("translate")("global."+t):t;var e=this.variable.categories.filter(function(e){return e.name===t+""});if(0===e.length)return t;var r=e[0];if(!r.attributes)return t;var a=r.attributes.filter(function(e){return"label"===e.name});return 0===a.length?t:this.localize(a[0].values)||t},e.prototype.localize=function(e){return this.LocalizedValues.forLang(e,this.$translate.use())},e.prototype.prepareCategories=function(){var t=this;if(this.categoriesData=[],"CATEGORICAL"===this.getNature()){var e=this.variable.categories;e?e.forEach(function(e){t.categoriesData.push({label:t.localizeCategory(e.name),name:e.name,visible:!0})}):this.isLogical()&&(this.categoriesData.push({label:this.$filter("translate")("global.true"),name:"true",visible:!0}),this.categoriesData.push({label:this.$filter("translate")("global.false"),name:"false",visible:!0}))}},e.prototype.prepareOptions=function(){var t=this;this.prepareCategories();var e=this.getRqlQueryWithArgs();if(1<e.args.length)if("in"===e.name)this.showCategoricalOptions()?e.args[1].forEach(function(e){t.selectedCategories[e]=!0}):this.showNumericalOptions()?(this.selectedNumericalOperation="in",this.selectedNumericalValues=e.args[1].filter(function(e){return!isNaN(e)}).join(" ")):this.showTemporalOptions()&&(this.selectedTemporalOperation="in",this.selectedTemporalValue=0<e.args[1].length?new Date(Date.parse(e.args[1][0])):void 0);else if("range"===e.name&&0<e.args[1].length){var r=e.args[1][0];if("*"===r?(this.selectedMin=void 0,this.selectedFrom=void 0):this.showNumericalOptions()&&!isNaN(r)?this.selectedMin=r:this.showTemporalOptions()&&(this.selectedFrom=new Date(Date.parse(r))),2<=e.args[1].length){var a=e.args[1][1];"*"===a?(this.selectedMax=void 0,this.selectedTo=void 0):this.showNumericalOptions()&&!isNaN(a)?this.selectedMax=a:this.showTemporalOptions()&&(this.selectedTo=new Date(Date.parse(a)))}}this.selectedOperation="range"===this.rqlQuery.name?"in":this.rqlQuery.name,!this.isQueryNot()||"in"!==e.name&&"range"!==e.name||(this.selectedOperation="out"),this.isQueryNot()&&"exists"===e.name&&(this.selectedOperation="empty")},e.prototype.ensureNumericValue=function(e,t){var r="";if(e)for(var a=0;a<e.length;a++){var n=e.charAt(a);(n===t||"decimal"===this.variable.valueType&&"."===n||"-"===n||!isNaN(parseInt(n,10)))&&(r+=n)}return r},e.prototype.makeNewQuery=function(){var e,t=this,r="";(this.showCategoricalOptions()&&(e=Object.keys(this.selectedCategories).filter(function(e){return t.selectedCategories[e]}).map(function(e){return e}).join(",")),this.showNumericalOptions())&&(e="range"===this.selectedNumericalOperation?[this.selectedMin&&"-"!==this.selectedMin?this.selectedMin:"*",this.selectedMax&&"-"!==this.selectedMax?this.selectedMax:"*"].join(","):this.selectedNumericalValues.split(" ").join(","));this.showTemporalOptions()&&(e="range"===this.selectedTemporalOperation?[this.selectedFrom?this.dateToString(this.selectedFrom):"*",this.selectedTo?this.dateToString(this.selectedTo):"*"].join(","):this.dateToString(this.selectedTemporalValue));switch(this.selectedOperation){case Operation.All:case Operation.Exists:r=this.selectedOperation+"({field})";break;case Operation.Empty:r="not(exists({field}))";break;case Operation.In:e&&0<e.length?this.showCategoricalOptions()||this.showNumericalOptions()&&"in"===this.selectedNumericalOperation||this.showTemporalOptions()&&"in"===this.selectedTemporalOperation?r="in({field},({args}))":(this.showNumericalOptions()&&"range"===this.selectedNumericalOperation||this.showTemporalOptions()&&"range"===this.selectedTemporalOperation)&&(r="range({field},({args}))"):(r="not(exists({field}))",this.selectedOperation="empty");break;case Operation.Out:e&&0<e.length?this.showCategoricalOptions()||this.showNumericalOptions()&&"in"===this.selectedNumericalOperation||this.showTemporalOptions()&&"in"===this.selectedTemporalOperation?r="not(in({field},({args})))":(this.showNumericalOptions()&&"range"===this.selectedNumericalOperation||this.showTemporalOptions()&&"range"===this.selectedTemporalOperation)&&(r="not(range({field},({args})))"):(r="exists({field})",this.selectedOperation="exists")}return r=(r=r.replace("{field}",this.variable.id)).replace("{args}",e)},e.prototype.dateToString=function(e){if(!e)return"";var t=e.getMonth()+1,r=e.getDate();return[e.getFullYear(),(9<t?"":"0")+t,(9<r?"":"0")+r].join("-")},e.prototype.onVariable=function(){var t=this;return function(e){t.variable=e,t.loading=!1,t.prepareOptions(),t.VariableSummaryResource.get({id:e.id},t.onVariableSummary(),t.onError())}},e.prototype.onVariableSummary=function(){var s=this;return function(e){if(s.summary=e,s.summary["Math.ContinuousSummaryDto.continuous"]){var t=s.summary["Math.ContinuousSummaryDto.continuous"].summary;s.rangeMin=t.min,s.rangeMax=t.max;var r=(i=s.summary["Math.ContinuousSummaryDto.continuous"].frequencies)?i.filter(function(e){return"NOT_NULL"===e.value}).pop():void 0;s.existsFrequency=r?r.freq:0;var a=i.filter(function(e){return"N/A"===e.value}).pop();s.emptyFrequency=a?a.freq:0,s.allFrequency=s.existsFrequency+s.emptyFrequency}if(s.summary["Math.CategoricalSummaryDto.categorical"]){var n=s.summary["Math.CategoricalSummaryDto.categorical"].frequencies;s.categoriesData.forEach(function(t){var e=n.filter(function(e){return e.value===t.name});0<e.length&&(t.frequency=e[0].freq)}),s.allFrequency=s.summary["Math.CategoricalSummaryDto.categorical"].n,s.existsFrequency=s.summary["Math.CategoricalSummaryDto.categorical"].otherFrequency+n.filter(function(e){return"N/A"!==e.value}).map(function(e){return e.freq}).reduce(function(e,t){return e+t}),s.emptyFrequency=s.allFrequency-s.existsFrequency}s.summary["Math.TextSummaryDto.textSummary"]&&(s.allFrequency=s.summary["Math.TextSummaryDto.textSummary"].n,(i=s.summary["Math.TextSummaryDto.textSummary"].frequencies)&&(s.existsFrequency=i.filter(function(e){return"N/A"!==e.value}).map(function(e){return e.freq}).reduce(function(e,t){return e+t})),s.summary["Math.TextSummaryDto.textSummary"].otherFrequency&&(s.existsFrequency=s.existsFrequency+s.summary["Math.TextSummaryDto.textSummary"].otherFrequency),s.emptyFrequency=s.allFrequency-s.existsFrequency);if(s.summary["Math.DefaultSummaryDto.defaultSummary"]){s.allFrequency=s.summary["Math.DefaultSummaryDto.defaultSummary"].n;var i;r=(i=s.summary["Math.DefaultSummaryDto.defaultSummary"].frequencies)?i.filter(function(e){return"NOT_NULL"===e.value}).pop():void 0;s.existsFrequency=r?r.freq:0,s.emptyFrequency=s.allFrequency-s.existsFrequency}}},e.prototype.onError=function(){var t=this;return function(e){t.variable=void 0,t.loading=!1}},e.$inject=["VariableResource","VariableSummaryResource","LocalizedValues","EntitiesCountService","$log","$translate","$filter"],e}(),VariableCriteriaComponent=function(){this.transclude=!0,this.bindings={query:"<"},this.controller=VariableCriteriaController,this.controllerAs="$ctrl",this.templateUrl="analysis/components/variable-criteria/component.html"};function NgObibaMicaListsOptionsFactory(){var r={listSearchOptions:{network:{fields:["studyIds","acronym.*","name.*","description.*","logo"]},study:{fields:["logo","objectives.*","acronym.*","name.*","model.methods.design","model.numberOfParticipants.participant"]},dataset:{fields:["acronym.*","name.*","description.*","variableType","studyTable.studyId","studyTable.project","studyTable.table","studyTable.populationId","studyTable.dataCollectionEventId","harmonizationTable.studyId","harmonizationTable.project","harmonizationTable.table","harmonizationTable.populationId"]}},listOptions:{networkOptions:{showStudyBadge:!0,showDatasetBadge:!0,showVariableBadge:!0},studyOptions:{studiesCountCaption:!0,studiesSearchForm:!0,studiesSupplInfoDetails:!0,studiesTrimmedDescription:!0,showNetworkBadge:!0,showDatasetBadge:!0,showVariableBadge:!0},datasetOptions:{showNetworkBadge:!0,showStudyBadge:!0,showVariableBadge:!0}}};function e(){this.getOptions=function(){return r}}this.$get=function(){return new e},this.setOptions=function(t){Object.keys(t).forEach(function(e){e in r&&(r[e]=t[e])})}}function SortWidgetOptionsProvider(){var r={sortOrderField:{options:[{value:"-_score",label:"relevance"},{value:"name",label:"name"},{value:"-name",label:"name"},{value:"acronym",label:"acronym"},{value:"-acronym",label:"acronym"}],defaultValue:"-_score"}},e=this;function t(e){var t=e;this.getOptions=function(){return t}}this.getDefaultOptions=function(){return e.defaultOptions},this.$get=function(){return new t(r)},this.setOptions=function(t){Object.keys(t).forEach(function(e){e in r&&t[e].options&&(r[e].options=r[e].options.concat(t[e].options),r[e].default=t[e].default)})}}function GraphicChartsDataProvider(){function o(e){var t=e;this.getData=function(e){e&&t.$promise.then(e)}}this.$get=["$log","JoinQuerySearchResource","ServerErrorUtils","AlertService","GraphicChartsConfig","GraphicChartsQuery",function(t,e,r,a,n,i){var s=i.queryDtoBuilder(n.getOptions().entityIds,n.getOptions().entityType);return new o(e.studies({query:s},function(e){return e},function(e){t.error("Server error",e)}))}]}function NgObibaMicaFileBrowserOptionsProvider(){var r={locale:"en",downloadInline:!0,downloadKey:!1,folders:{excludes:["population"]},documentsTitle:"file.documents"};this.addExcludeFolder=function(e){e&&r.folders.excludes.push(e)},this.setOptions=function(t){"object"==typeof t&&Object.keys(t).forEach(function(e){e in r&&(r[e]=t[e])})},this.$get=function(){return r}}ngObibaMica.analysis.component("variableCriteria",new VariableCriteriaComponent),ngObibaMica.lists=angular.module("obiba.mica.lists",["obiba.mica.search"]),ngObibaMica.lists.run().config(["$provide",function(e){e.provider("ngObibaMicaLists",NgObibaMicaListsOptionsFactory)}]).config(["ngObibaMicaSearchTemplateUrlProvider",function(e){e.setTemplateUrl("searchStudiesResultTable","lists/views/list/studies-search-result-table-template.html"),e.setTemplateUrl("searchNetworksResultTable","lists/views/list/networks-search-result-table-template.html"),e.setTemplateUrl("searchDatasetsResultTable","lists/views/list/datasets-search-result-table-template.html"),e.setTemplateUrl("searchResultList","lists/views/search-result-list-template.html"),e.setTemplateUrl("searchInputList","lists/views/input-search-widget/input-search-widget-template.html"),e.setTemplateUrl("searchCriteriaRegionTemplate","lists/views/region-criteria/search-criteria-region-template.html"),e.setTemplateUrl("CriterionDropdownTemplate","lists/views/region-criteria/criterion-dropdown-template.html")}]).config(["$provide",function(e){e.provider("sortWidgetOptions",SortWidgetOptionsProvider)}]).filter("getBaseUrl",function(){return function(e){return"/mica/"+e}}).filter("doSearchQuery",function(){return function(e,t){return"/mica/repository#/search?type="+e+"&query="+t+"&display=list"}}),ngObibaMica.lists.service("sortWidgetService",["$filter","$location","RqlQueryService","sortWidgetOptions",function(t,a,n,e){var i=e.getOptions(),s=this;this.getSortOrderOptions=function(){return i.sortOrderField.options.map(function(e){return t("translate")(e.label)}),{options:i.sortOrderField.options}},this.getSortOrderOption=function(t){var r=null;return t||(t=i.sortOrderField.defaultValue),angular.forEach(s.getSortOrderOptions().options,function(e){e.value===t&&(r=e)}),r||s.getSortOrderOption(i.sortOrderField.defaultValue)},this.getSortArg=function(){var e=a.search(),t=n.parseQuery(e.query);if(t){var r=n.getTargetQuerySort(targetToType(t.args[0].name),t);if(r)return r.args[0]}return i.sortOrderField.defaultValue},this.getLabel=function(e,t){var r=null;return angular.forEach(e.options,function(e){e.value===t&&(r=e.label)}),r}}]),ngObibaMica.lists.controller("listSearchWidgetController",["$scope","$rootScope","$location","RqlQueryService","ngObibaMicaUrl",function(a,e,t,n,i){function r(){a.query=t.search().query,a.target=typeToTarget(a.type),a.rqlQuery=n.parseQuery(a.query)}a.navigateToSearchPage=function(){var e=n.findTargetQuery(typeToTarget(a.type),n.parseQuery(a.query));if(e){var t=n.findQueryInTargetByVocabulary(e,"className")||n.findQueryInTargetByVocabulary(e,"id");if(t){e.args=[t];var r=new RqlQuery(RQL_NODE.AND);return r.args.push(e),i.getUrl("BaseUrl")+i.getUrl("SearchBaseUrl")+"?type="+a.type+"&query="+(new RqlQuery).serializeArgs(r.args)+"&display=list"}}return""},a.$on("$locationChangeSuccess",function(){r()});var s=e.$new();a.selectSuggestion=function(e){s.$emit("ngObibaMicaSearch.searchSuggestion",e)},a.search=function(){s.$emit("ngObibaMicaSearch.searchSuggestion",a.searchFilter.replace(/\/.*/g,""))},r()}]).controller("listSortWidgetController",["$scope","$rootScope","sortWidgetService",function(t,e,r){var a=e.$new();function n(){t.selected=r.getSortOrderOption(r.getSortArg())}t.selectSortOrder=r.getSortOrderOptions(),t.getLabel=r.getLabel,t.selected=t.selectSortOrder.options.defaultValue,n(),t.$on("$locationChangeSuccess",function(){n()}),t.selectSortOrderOption=function(e){t.selected=e,a.$emit("ngObibaMicaSearch.sortChange",e.value)}}]),ngObibaMica.lists.directive("listSortWidget",[function(){return{restrict:"EA",controller:"listSortWidgetController",templateUrl:"lists/views/sort-widget/sort-widget-template.html"}}]).directive("listSearchWidget",["ngObibaMicaSearchTemplateUrl",function(e){return{restrict:"EA",require:"^^suggestionField",transclude:!0,replace:!0,scope:{type:"="},controller:"listSearchWidgetController",templateUrl:e.getTemplateUrl("searchInputList")}}]).directive("suggestionField",["$location","DocumentSuggestionResource","$translate","RqlQueryService","EntitySuggestionService",function(e,t,r,a,n){return{restrict:"EA",replace:!0,scope:{documentType:"=",model:"=",placeholderText:"=",select:"="},templateUrl:"lists/views/input-search-widget/suggestion-field.html",link:function(t){t.suggest=function(e){return n.suggestForTargetQuery(t.documentType,e)}}}}]),ngObibaMica.graphics=angular.module("obiba.mica.graphics",["obiba.graphics","obiba.utils","templates-ngObibaMica"]),ngObibaMica.graphics.config(["$provide",function(e){e.provider("GraphicChartsData",GraphicChartsDataProvider)}]).run(["GraphicChartsConfigurations",function(e){e.setClientConfig()}]),ngObibaMica.graphics.directive("obibaChart",[function(){return{restrict:"EA",replace:!0,scope:{fieldTransformer:"=",chartType:"=",chartAggregationName:"=",chartEntityDto:"=",chartOptionsName:"=",chartOptions:"=",chartHeader:"=",chartTitle:"=",chartTitleGraph:"=",chartSelectGraphic:"="},templateUrl:"graphics/views/charts-directive.html",controller:"GraphicChartsController"}}]).directive("obibaTable",[function(){return{restrict:"EA",replace:!0,scope:{fieldTransformer:"=",chartType:"@",chartAggregationName:"=",chartEntityDto:"=",chartOptionsName:"=",chartOptions:"=",chartHeader:"=",chartTitle:"=",chartTitleGraph:"=",chartSelectGraphic:"=",chartOrdered:"=",chartNotOrdered:"="},templateUrl:"graphics/views/tables-directive.html",controller:"GraphicChartsController"}}]),ngObibaMica.graphics.controller("GraphicChartsController",["$rootScope","$scope","$filter","$window","GraphicChartsConfig","GraphicChartsUtils","GraphicChartsData","RqlQueryService","ngObibaMicaUrl","D3GeoConfig","D3ChartConfig",function(e,a,n,i,s,t,r,o,c,l,u){a.ready=!0,a.$watch("chartAggregationName",function(){a.chartAggregationName&&(a.chartObject={},r.getData(function(r){r&&t.getArrayByAggregation(a.chartAggregationName,r[a.chartEntityDto]).then(function(e){var t=e.map(function(e){return e.participantsNbr?[e.title,e.value,e.participantsNbr]:[e.title,e.value]});a.updateCriteria=function(e,t){o.createCriteriaItem("study","Mica_study",t,e).then(function(e){var t=s.getOptions().entityType,r=s.getOptions().entityIds,a=e.id.split("."),n=c.getUrl("SearchBaseUrl")+"?type=studies&query="+t+"(in(Mica_"+t+".id,"+r+")),study(in("+a[0]+"."+a[1]+","+a[2].replace(":","%253A")+"))";i.location.href=c.getUrl("BaseUrl")+n})},t&&(null!==/^Table-/.exec(a.chartType)?(a.chartObject.ordered=a.chartOrdered,a.chartObject.notOrdered=a.chartNotOrdered,a.chartHeader.length<3?a.chartObject.header=[n("translate")(a.chartHeader[0]),n("translate")(a.chartHeader[1])]:a.chartObject.header=[n("translate")(a.chartHeader[0]),n("translate")(a.chartHeader[1]),n("translate")(a.chartHeader[2])],a.chartObject.type=a.chartType,a.chartObject.data=t,a.chartObject.vocabulary=a.chartAggregationName,a.chartObject.entries=e,a.chartObject.getTable=function(){return a.chartObject}):(a.chartHeader.length<3||t.map(function(e){return e.pop(),e}),t.unshift([n("translate")(a.chartHeader[0]),n("translate")(a.chartHeader[1])]),a.chartObject.term=!0,a.chartObject.type=a.chartType,a.chartObject.data=t,a.chartObject.options={backgroundColor:{fill:"transparent"}},angular.extend(a.chartObject.options,a.chartOptions),a.chartObject.options.title=n("translate")(a.chartTitleGraph)+" (N="+r.studyResultDto.totalHits+")",a.$parent.directive={title:a.chartObject.options.title})),"GeoChart"===a.chartType?(a.chartObject.d3Config=(new l).withData(e).withTitle(a.chartObject.options.title),a.chartObject.options&&a.chartObject.d3Config.withColor(a.chartOptions.colors)):(a.chartObject.d3Config=new u(a.chartAggregationName).withType("PieChart"===a.chartType?"pieChart":"multiBarHorizontalChart").withData(e,"PieChart"===a.chartType,n("translate")("graphics.nbr-studies")).withTitle(n("translate")(a.chartTitleGraph)+" (N="+r.studyResultDto.totalHits+")"),"PieChart"!==a.chartType&&(a.chartObject.d3Config.options.chart.showLegend=!1),a.chartObject.options&&a.chartObject.options.colors&&(a.chartObject.d3Config.options.chart.color=a.chartOptions.colors),a.chartObject.d3Config.options.chart.legendPosition="right",a.chartObject.d3Config.options.chart.legend={margin:{top:0,right:10,bottom:0,left:0}})})}))})}]),ngObibaMica.graphics.factory("GraphicChartsDataResource",["$resource","ngObibaMicaUrl",function(e,t){var r=t.getUrl("JoinQuerySearchResource"),a=-1===r.indexOf(":query")?"POST":"GET";return e(r,{},{studies:{method:a,headers:{"Content-Type":"POST"===a?"application/x-www-form-urlencoded":"application/json"},errorHandler:!0,params:{type:"studies"},transformRequest:function(e){var t=[];for(var r in e)t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")}}})}]).service("GraphicChartsConfig",function(){var r={options:{entityIds:"NaN",entityType:null,ChartsOptions:{geoChartOptions:{header:["graphics.country","graphics.nbr-studies"],title:"graphics.geo-chart-title",options:{backgroundColor:{fill:"transparent"},colors:["#e5edfb","#cfddf5","#b8cbed","#a0b8e2","#88a4d4"]}},studiesDesigns:{header:["graphics.study-design","graphics.nbr-studies","graphics.number-participants"],title:"graphics.study-design-chart-title",options:{bars:"horizontal",series:{0:{axis:"nbrStudies"},1:{axis:"nbrParticipants"}},axes:{x:{nbrStudies:{side:"top",label:"Number of Studies"},nbrParticipants:{label:"Number of Participants"}}},backgroundColor:{fill:"transparent"},colors:["#b8cbed","#e5edfb","#cfddf5","#a0b8e2","#88a4d4"]}},numberParticipants:{header:["graphics.number-participants","graphics.nbr-studies"],title:"graphics.number-participants-chart-title",options:{backgroundColor:{fill:"transparent"},colors:["#b8cbed","#e5edfb","#cfddf5","#a0b8e2","#88a4d4"],pieSliceTextStyle:{color:"#000000"}}},biologicalSamples:{header:["graphics.bio-samples","graphics.nbr-studies"],title:"graphics.bio-samples-chart-title",options:{bars:"horizontal",series:{0:{axis:"nbrStudies"}},axes:{x:{nbrStudies:{side:"top",label:"Number of Studies"}}},backgroundColor:{fill:"transparent"},colors:["#b8cbed","#e5edfb","#cfddf5","#a0b8e2","#88a4d4"]}}}},setOptions:function(t){"object"==typeof t&&Object.keys(t).forEach(function(e){e in r.options&&(r.options[e]=t[e])})},getOptions:function(){return angular.copy(r.options)}};return r}).service("GraphicChartsUtils",["LocalizedValues","TaxonomyResource","VocabularyService","$q","$translate",function(c,a,n,i,l){var u={getTerms:function(r){var e=i.defer();function t(){var t=null;u.vocabularies&&angular.forEach(u.vocabularies,function(e){n.vocabularyAlias(e)===r&&(t=e.terms)}),e.resolve(t)}return u.vocabularies?t():a.get({target:"study",taxonomy:"Mica_study"}).$promise.then(function(e){u.vocabularies=angular.copy(e.vocabularies),t()}),e.promise}};this.getArrayByAggregation=function(s,r){var a=i.defer();s&&r||a.resolve([]);var o=[];return u.getTerms(s).then(function(e){var t=e,i=0;angular.forEach(r.aggs,function(r){if(r.aggregation===s)if(r["obiba.mica.RangeAggregationResultDto.ranges"])i=0,angular.forEach(t,function(t){angular.forEach(r["obiba.mica.RangeAggregationResultDto.ranges"],function(e){t.name===e.key&&e.count&&(o[i]={title:c.forLocale(t.title,l.use()),value:e.count,key:e.key},i++)})});else{if("populations-model-selectionCriteria-countriesIso"===r.aggregation){var n=l.use();t.sort(function(e,t){var r=c.forLocale(e.title,n),a=c.forLocale(t.title,n);return r<a?-1:a<r?1:0})}var a=0;i=0,angular.forEach(t,function(t){angular.forEach(r["obiba.mica.TermsAggregationResultDto.terms"],function(e){t.name===e.key&&e.count&&("model-methods-design"===r.aggregation?(angular.forEach(e.aggs,function(e){if("model-numberOfParticipants-participant-number"===e.aggregation){var t=e["obiba.mica.StatsAggregationResultDto.stats"];a=c.formatNumber(t?t.data.sum:0)}}),o[i]={title:c.forLocale(t.title,l.use()),value:e.count,participantsNbr:a,key:e.key}):o[i]={title:c.forLocale(t.title,l.use()),value:e.count,key:e.key},i++)})})}}),a.resolve(o)}),a.promise}}]).service("GraphicChartsQuery",["RqlQueryService","RqlQueryUtils","$translate",function(i,s,o){this.queryDtoBuilder=function(e,t){var r;e&&"NaN"!==e||(r="study(exists(Mica_study.id))"),t&&"NaN"!==e&&(r=t+"(in(Mica_"+t+".id,("+e+")))");var a=angular.copy(i.parseQuery(r));s.addLocaleQuery(a,o.use());var n=(new RqlQuery).serializeArgs(a.args);return i.prepareGraphicsQuery(n,["Mica_study.populations-selectionCriteria-countriesIso","Mica_study.populations-dataCollectionEvents-bioSamples","Mica_study.numberOfParticipants-participant-number"],["Mica_study.methods-design"])}}]),ngObibaMica.localized=angular.module("obiba.mica.localized",["obiba.notification","pascalprecht.translate","templates-ngObibaMica"]),ngObibaMica.localized.directive("localized",["LocalizedValues",function(t){return{restrict:"AE",scope:{value:"=",lang:"=",ellipsisSize:"=",markdownIt:"=",keyLang:"@",keyValue:"@"},templateUrl:"localized/localized-template.html",link:function(e){e.keyLang=e.keyLang||"lang",e.keyValue=e.keyValue||"value",e.LocalizedValues=t}}}]).directive("localizedNumber",["LocalizedValues",function(t){return{restrict:"E",scope:{number:"=value"},template:"{{::localizedNumber}}",controller:["$scope",function(e){e.localizedNumber=t.formatNumber(e.number)}]}}]).directive("localizedInput",[function(){return{restrict:"AE",require:"^form",scope:{name:"@",model:"=",label:"@",required:"@",disabled:"=",lang:"=",help:"@",customValidator:"="},templateUrl:"localized/localized-input-template.html",link:function(t,e,r,a){(angular.isUndefined(t.model)||null===t.model)&&(t.model=[{lang:t.lang,value:""}]),t.$watch("model",function(e){(angular.isUndefined(e)||null===e)&&(t.model=[{lang:t.lang,value:""}]),0===t.model.filter(function(e){if(e.lang===t.lang)return e}).length&&t.model.push({lang:t.lang,value:""})},!0),t.fieldName=t.name+"-"+t.lang,t.form=a}}}]).directive("localizedInputGroup",[function(){return{restrict:"AE",require:"^form",scope:{name:"@",model:"=",label:"@",required:"@",disabled:"=",lang:"=",help:"@",remove:"=",customValidator:"="},templateUrl:"localized/localized-input-group-template.html",link:function(t,e,r,a){(angular.isUndefined(t.model)||null===t.model)&&(t.model=[{lang:t.lang,value:""}]),t.$watch("model",function(e){(angular.isUndefined(e)||null===e)&&(t.model=[{lang:t.lang,value:""}]),0===t.model.filter(function(e){if(e.lang===t.lang)return e}).length&&t.model.push({lang:t.lang,value:""})},!0),t.fieldName=t.name+"-"+t.lang,t.form=a}}}]).directive("localizedTextarea",[function(){return{restrict:"AE",require:"^form",scope:{name:"@",model:"=",label:"@",required:"@",disabled:"=",lang:"=",help:"@",rows:"@",customValidator:"="},templateUrl:"localized/localized-textarea-template.html",link:function(t,e,r,a){(angular.isUndefined(t.model)||null===t.model)&&(t.model=[{lang:t.lang,value:""}]),t.$watch("model",function(e){(angular.isUndefined(e)||null===e)&&(t.model=[{lang:t.lang,value:""}]),0===t.model.filter(function(e){if(e.lang===t.lang)return e}).length&&t.model.push({lang:t.lang,value:""})},!0),t.fieldName=t.name+"-"+t.lang,t.form=a}}}]),ngObibaMica.localized.service("LocalizedValues",["$translate",function(t){var s=this;this.for=function(t,r,a,e){if(angular.isArray(t)){var n=t.filter(function(e){return e[a]===r});if(n&&0<n.length)return n[0][e];var i=t.map(function(e){return e[a]});if(0<i.length)return s.for(t,1===i.length?i[0]:"en",a,e)}else if(angular.isObject(t))return s.for(Object.keys(t).map(function(e){return{lang:e,value:t[e]}}),r,a,e);return t||""},this.forLocale=function(e,t){var r=this.for(e,t,"locale","text");return r&&""!==r||(r=this.for(e,"und","locale","text")),r&&""!==r||(r=this.for(e,"en","locale","text")),r},this.forLang=function(e,t){var r=this.for(e,t,"lang","value");return r&&""!==r||(r=this.for(e,"und","lang","value")),r&&""!==r||(r=this.for(e,"en","lang","value")),r},this.formatNumber=function(e){return null==e||"number"!=typeof e?e:e.toLocaleString(t.use())},this.arrayToObject=function(e){var t={};return e&&e.forEach(function(e){t[e.lang]=e.value}),t},this.objectToArray=function(t,e){var r=[];if(t){var a=e||Object.keys(t);a&&a.forEach(function(e){r.push({lang:e,value:t[e]})})}return 0===r.length?void 0:r}}]).service("LocalizedSchemaFormService",["$filter",function(r){this.translate=function(e){return e?"string"==typeof e?this.translateString(e):"object"==typeof e?Array.isArray(e)?this.translateArray(e):this.translateObject(e):e:e},this.translateObject=function(e){if(!e)return e;for(var t in e)e.hasOwnProperty(t)&&("string"==typeof e[t]?e[t]=this.translateString(e[t]):"object"==typeof e[t]&&(Array.isArray(e[t])?e[t]=this.translateArray(e[t]):e[t]=this.translateObject(e[t])));return e},this.translateArray=function(e){if(!e)return e;var t=this;return e.map(function(e){return t.translate(e)}),e},this.translateString=function(e){return e?e.replace(/t\(([^\)]+)\)/g,function(e,t){return r("translate")(t)}):e}}]),ngObibaMica.localized.filter("localizedNumber",["LocalizedValues",function(t){return function(e){return 0===e?0:e?t.formatNumber(e):""}}]).filter("localizedString",["$translate","LocalizedValues",function(t,r){return function(e){return r.forLocale(e,t.use())}}]),ngObibaMica.fileBrowser=angular.module("obiba.mica.fileBrowser",["pascalprecht.translate","ui.bootstrap","templates-ngObibaMica"]).config(["$provide",function(e){e.provider("ngObibaMicaFileBrowserOptions",new NgObibaMicaFileBrowserOptionsProvider)}]),ngObibaMica.fileBrowser.directive("fileBrowser",[function(){return{restrict:"EA",replace:!0,controller:"FileBrowserController",scope:{docPath:"@",docId:"@",tokenKey:"@",subject:"=",refresh:"=",showTitle:"@"},templateUrl:"file-browser/views/file-browser-template.html",link:function(e,t){e.selfNode=t[0]}}}]),ngObibaMica.fileBrowser.controller("FileBrowserController",["$rootScope","$scope","$log","$filter","StringUtils","FileBrowserService","BrowserBreadcrumbHelper","AlertService","ServerErrorUtils","FileBrowserFileResource","FileBrowserSearchResource","ngObibaMicaFileBrowserOptions","FileBrowserDownloadService","CustomWatchDomElementService",function(e,s,o,t,r,a,n,i,c,l,u,d,h,m){var p=function(e,t){y(),b(e,t)},f=function(e,t,r){e.stopPropagation(),t&&p(t.path,r)},g=function(e){i.alert({id:"FileSystemController",type:"danger",msg:c.buildMessage(e)}),403!==e.status&&s.data.document&&f(s.data.document)};function y(){s.data.search.text=null,s.data.search.active=!1}function b(t,r){var e;s.data.search.active=!1,e=r?{path:t,keyToken:r}:{path:t},l.get(e,function(e){404!==e.code?(s.pagination.selected=-1,s.data.document=s.data.details.document=e,s.data.document.children||(s.data.document.children=[]),r&&(s.data.document.keyToken=r),s.data.document.path===s.data.rootPath&&(s.data.document.children=s.data.document.children.filter(function(e){return d.folders.excludes.indexOf(e.name)<0}),s.data.document.size=s.data.document.children.length),s.data.breadcrumbs=n.toArray(t,s.data.rootPath),s.data.isFile=a.isFile(e),s.data.isRoot=a.isRoot(e),s.noDocument=!1,"FOLDER"===e.type&&e.size<1&&(s.noDocument=!0)):s.noDocument=!0},g)}function v(){s.pagination.selected=-1,s.data.details.show=!1}var S=function(e){s.data.search.active=!0,v();var t=s.data.search.recursively,r=null,a=null,n=999;switch(s.data.search.query=e){case"RECENT":e="",r="desc",a="lastModifiedDate",n=10}var i={query:e,recursively:t,sort:a,order:r,limit:n};!function(a,e){e.query=function(e){var t="";try{var r=[];d.folders.excludes.forEach(function(e){var t=a.replace(/\//g,"\\/")+"\\/"+e.replace(/\s/,"\\ ");r.push(t),r.push(t+"\\/*")}),t=0<r.length?"NOT path:("+r.join(" OR ")+")":""}catch(e){}return e?e+" AND "+t:t}(e.query);var t=angular.extend({},{path:a},e);u.search(t,function(e){var t=s.data.document?angular.copy(s.data.document):{};t.children=e,s.data.document=t},function(e){o.debug("ERROR:",e)})}(s.data.document.path,i)},T=function(){y(),b(s.data.document.path)},E=function(e,t){e&&t&&(s.docPath=e,s.docId=t),s.docPath&&"/"!==s.docPath&&s.docId&&(s.data.docRootIcon=n.rootIcon(s.docPath),s.data.rootPath=s.docPath+("null"!==s.docId?"/"+s.docId:""),s.tokenKey?b(s.data.rootPath,s.tokenKey):b(s.data.rootPath,null))};s.downloadTarget=d.downloadInline?"_blank":"_self",s.getDownloadUrl=h.getUrl,s.screen=e.screen,s.truncate=r.truncate,s.getDocumentIcon=a.getDocumentIcon,s.navigateToPath=p,s.navigateTo=f,s.navigateBack=function(){if(!s.data.isRoot&&s.data.document){var e=s.data.document.path.replace(/\\/g,"/").replace(/\/[^\/]*$/,"");b(e||"/")}},s.navigateToParent=function(e,t,r){e.stopPropagation();var a=t.path;a=0===a.lastIndexOf("/")?"/":a.substring(0,a.lastIndexOf("/")),p(a,r)},s.clearSearch=T,s.searchDocuments=S,s.toggleRecursively=function(){s.data.search.recursively=!s.data.search.recursively,s.data.search.text?S(s.data.search.text):s.data.search.query&&S(s.data.search.query)},s.searchKeyUp=function(e){switch(e.keyCode){case 13:s.data.search.text?S(s.data.search.text):T();break;case 27:s.data.search.active&&T()}},s.isFile=a.isFile,s.isRoot=a.isRoot,s.getLocalizedValue=function(e){return a.getLocalizedValue(e,d.locale)},s.hasLocalizedValue=function(e){return a.hasLocalizedValue(e,d.locale)},s.hideDetails=v,s.showDetails=function(e,t){s.pagination.selected=t,s.data.details.document=e,s.data.details.show=!0},s.getTypeParts=function(e){return a.isFile(e)&&e.attachment.type?e.attachment.type.split(/,|\s+/):[]},s.documentsTitle=d.documentsTitle,s.pagination={selected:-1,currentPage:1,itemsPerPage:20},s.data={keyToken:null,details:{document:null,show:!1},docRootIcon:null,rootPath:null,document:null,accesses:[],search:{text:null,active:!1,recursively:!0},breadcrumbs:null,isFile:!1,isRoot:!1,editDescField:!1},s.$watchGroup(["docPath","docId"],function(){E()}),s.__defineSetter__("selfNode",function(e){e&&m.configWatch(e,["refresh","show-title"]).customWatch(function(){"true"===e.attributes[4].value&&(E(e.attributes[1].value,e.attributes[2].value),s.showTitle=e.attributes[6].value)})})}]),ngObibaMica.fileBrowser.factory("FileBrowserFileResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("FileBrowserFileResource"),{path:"@path",keyToken:"@keyToken"},{get:{method:"GET",errorHandler:!0}})}]).factory("FileBrowserSearchResource",["$resource","ngObibaMicaUrl",function(e,t){return e(t.getUrl("FileBrowserSearchResource"),{path:"@path"},{search:{method:"GET",isArray:!0,errorHandler:!0}})}]).service("FileBrowserDownloadService",["ngObibaMicaUrl","ngObibaMicaFileBrowserOptions",function(a,n){return this.getUrl=function(e,t){var r=a.getUrl("FileBrowserDownloadUrl").replace(/:path/,e).replace(/:inline/,n.downloadInline);return r=t?r.replace(/:key/,t):r.replace(/:key/,"")},this}]).service("FileBrowserService",[function(){this.isFile=function(e){return e&&"FILE"===e.type},this.isRoot=function(e){return e&&"/"===e.path},this.getLocalizedValue=function(e,t){if(!e)return null;var r=e.filter(function(e){return e.lang===t});return r&&0<r.length?r[0].value:null},this.hasLocalizedValue=function(e,t){var r=this.getLocalizedValue(e,t);return null!==r&&0<r.trim().length},this.getDocumentIcon=function(e){if(!e)return"";if("FOLDER"===e.type)return"fa-folder";var t=e.path.match(/\.(\w+)$/);if(t&&1<t.length)switch(t[1].toLowerCase()){case"doc":case"docx":case"odm":case"gdoc":return"fa-file-word-o";case"xls":case"xlsx":return"fa-file-excel-o";case"pdf":return"fa-file-pdf-o";case"ppt":case"odt":return"fa-file-powerpoint-o";case"xt":return"fa-file-text-o"}return"fa-file"}}]).service("BrowserBreadcrumbHelper",[function(){this.toArray=function(e,t){if(e){var r=(e=e.replace(t,"")).replace(/\/$/,"").split("/").slice(1),a=[],n=null;return r.forEach(function(e){n=(null===n?t:n)+"/"+e,a.push({name:e,path:n})}),a}return[{name:"",path:""}]},this.rootIcon=function(e){var t=/^\/([^\/]*)/.exec(e);switch(t?t[1]:""){case"study":return"i-obiba-study";case"network":return"i-obiba-network";case"study-dataset":return"i-obiba-study-dataset";case"harmonization-dataset":return"i-obiba-harmo-dataset";default:return"fa fa-hdd-o"}}}]);